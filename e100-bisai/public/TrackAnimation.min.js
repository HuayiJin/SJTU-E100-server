var BMapGLLib=window.BMapGLLib=BMapGLLib||{};(function(){var DELTA_ZOOM=1;var DEFAULT_TILT=55;var DEFAULT_DURATION=10000;var DEFAULT_DELAY=0;var DEFAULT_OVERALLVIEW=true;var PLAY=1;var CANCEL=2;var start=0;var TrackAnimation=BMapGLLib.TrackAnimation=function(map,polyline,opts){this._map=map;this._polyline=polyline;this._totalPath=polyline.getPath();this._overallView=map.getViewport(polyline.getPath());this._status=CANCEL;this._opts={zoom:this._getZoom(),tilt:DEFAULT_TILT,duration:DEFAULT_DURATION,delay:DEFAULT_DELAY,overallView:DEFAULT_OVERALLVIEW};this._initOpts(opts);this._expandPath=this._addPath(polyline.getPath())};TrackAnimation.prototype._getZoom=function(){return Math.min(this._overallView.zoom+DELTA_ZOOM,this._map.getMaxZoom())};TrackAnimation.prototype._updateAniParams=function(){this._updatePathAni();this._updateViewAni();this._polyline.setPath(this._expandPath.slice(0,1))};TrackAnimation.prototype._updatePathAni=function(){this._expandPath=this._addPath(this._totalPath)};TrackAnimation.prototype._updateViewAni=function(){this._overallView=this._map.getViewport(this._totalPath);var length=this._totalPath.length;var keyFrames=[];var duration=this._opts.overallView?this._opts.duration+2000:this._opts.duration;for(var i=0;i<length;i++){var item=this._totalPath[i];var percent=this._pathPercents[i]*(this._opts.duration/duration);keyFrames.push({center:new BMapGL.Point(item.lng,item.lat),zoom:this._opts.zoom,tilt:i===0?0:this._opts.tilt,heading:0,percentage:percent})}if(this._opts.overallView){keyFrames.push({center:new BMapGL.Point(this._overallView.center.lng,this._overallView.center.lat),zoom:this._overallView.zoom-DELTA_ZOOM,tilt:0,heading:0,percentage:1})}var opts={duration:duration,delay:0,interation:1};this._viewAni=new BMapGL.ViewAnimation(keyFrames,opts)};TrackAnimation.prototype._addPath=function(path){var TOTAL_NUM=this._opts.duration/10;var length=path.length;var totalDistance=0;var distances=[];var expandPath=[];for(var i=1;i<length;i++){var distance=this._map.getDistance(path[i-1],path[i]);distances.push(distance);totalDistance+=distance}var percents=[0];for(var i=1;i<length;i++){var percent=(distances[i-1]/totalDistance).toFixed(2);percents[i]=percents[i-1]+parseFloat(percent,10);expandPath=expandPath.concat(this._getPath(path[i-1],path[i],percent*TOTAL_NUM))}this._pathPercents=percents;return expandPath};TrackAnimation.prototype._getPath=function(start,end,num){var result=[];for(var i=0;i<=num;i++){var point=new BMapGL.Point((end.lng-start.lng)/num*i+start.lng,(end.lat-start.lat)/num*i+start.lat);if(point.lng===0||point.lat===0){}else{result.push(point)}}return result};TrackAnimation.prototype._initOpts=function(opts){for(var p in opts){if(opts.hasOwnProperty(p)){this._opts[p]=opts[p]}}};TrackAnimation.prototype.start=function(){var me=this;setTimeout(function(){me._updateAniParams();me._map.removeOverlay(me._polyline);me._map.addOverlay(me._polyline);me._status=PLAY;me._step(performance.now());me._map.startViewAnimation(me._viewAni)},this._opts.delay)};TrackAnimation.prototype.cancel=function(){this._status=CANCEL;start=0;this._map.cancelViewAnimation(this._viewAni)};TrackAnimation.prototype._step=function(timestamp){if(this._status!==PLAY){start=0;return}if(!start){start=timestamp}var percent=(timestamp-start)/this._opts.duration;var end=Math.round(this._expandPath.length*percent);this._polyline.setPath(this._expandPath.slice(0,end));if(timestamp<start+this._opts.duration){window.requestAnimationFrame(this._step.bind(this))}else{start=0}};TrackAnimation.prototype.setZoom=function(zoom){this._opts.zoom=zoom};TrackAnimation.prototype.getZoom=function(zoom){return this._opts.zoom};TrackAnimation.prototype.setTilt=function(tilt){this._opts.tilt=tilt};TrackAnimation.prototype.getTilt=function(tilt){return this._opts.tilt};TrackAnimation.prototype.setDelay=function(delay){this._opts.delay=delay};TrackAnimation.prototype.getDelay=function(delay){return this._opts.delay};TrackAnimation.prototype.setDuration=function(duration){this._opts.duration=duration};TrackAnimation.prototype.getDuration=function(duration){return this._opts.duration};TrackAnimation.prototype.enableOverallView=function(){this._opts.overallView=true};TrackAnimation.prototype.disableOverallView=function(){this._opts.overallView=false};TrackAnimation.prototype.setPolyline=function(polyline){this._polyline=polyline;this._totalPath=polyline.getPath()};TrackAnimation.prototype.getPolyline=function(){return this._polyline}})();
