<!DOCTYPE html>
<html lang="en" style="height: 100%">
    <head>
            <meta http-equiv="Access-Control-Allow-Origin" content="*" />
        <!-- <meta http-equiv="refresh" content="10"> -->
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-gl/dist/echarts-gl.min.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-stat/dist/ecStat.min.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/dataTool.min.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/map/js/china.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/bmap.min.js"></script>
       <script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=2GCVEjjkYGGiVjTR1EoENtf2SNzYaiRI"></script>
       <!-- <script src="theme/dark.js"></script> -->
       <!-- button -->
       <!-- <link rel="shortcut icon" href="../favicon.ico"> 
       <link rel="stylesheet" type="text/css" href="css/default.css" />
       <link rel="stylesheet" type="text/css" href="css/component.css" />
       <script src="js/modernizr.custom.js"></script> -->

       <!-- Stylesheet -->
        <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous"> -->
        
        <!-- jQuery & Bootstrap -->
        <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script> -->

        <!-- Latest compiled and minified CSS -->
        <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.12/dist/css/bootstrap-select.min.css"> -->

        <!-- Latest compiled and minified JavaScript -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.12/dist/js/bootstrap-select.min.js"></script> -->

        <!-- (Optional) Latest compiled and minified JavaScript translation files -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.12/dist/js/i18n/defaults-*.min.js"></script> -->

        <!-- semantic-ui -->
        <link href="semantic.min.css" rel="stylesheet" type="text/css">
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script src="semantic.min.js"></script>

       <style type="text/css">
        div#mapDiv {
            /* background-color:green; */
            height:75%;
            width:75%;
            float:left;
        }
        div#optionList {
            /* background-color:gray; */
            height:75%;
            width:25%;
            float:left;
        }
        div#chart {
            /* background-color:blue; */
            width:100%;
            height:25%;
            float: left; 
        }
        </style>

        
    </head>

    <body style="height: 100%; margin: 0" >
        <!-- <div id="Echarts"></div> -->
        <div id="mapDiv"></div>
        <div id="optionList">
            <div id="detailOption" style="height: 20%; width: 100%; float: left; ">
                <select name="reques_type" class="ui dropdown" id="select">
                    <optgroup label="车辆状态">
                        <option value="velocity" selected>速度</option>
                        <option value="cumulative_mileage">总行驶里程</option>
                        <option value="drive_motor_rpm">电机转速</option>
                        <option value="drive_motor_temperature">电机温度</option>
                    </optgroup>
                    <optgroup label="电池信息">
                        <option value="residual_energy">剩余电量</option>
                        <option value="high_voltage_battery_current">总电流</option>
                        <option value="total_battery_voltage">总电压</option>
                        <option value="max_single_voltage">电池最高单体电压</option>
                        <option value="min_single_voltage">电池最低单体电压</option>
                        <option value="insulation_resistance_value">绝缘阻值</option>
                    </optgroup>
                    <optgroup label="其他数据">
                        <option value="motor_torque">电机转矩</option>
                        <option value="motor_controller_current">电机控制器电流</option>
                        <option value="motor_controller_voltage">电机控制器电压</option>
                    </optgroup>
                </select>
                
                <select class="ui search selection dropdown" id="search-select"> 
                    <option value="LK6ADCE20JB008246">LK6ADCE20JB008246</option>
                    <option value="LK6ADCE20JB008862">LK6ADCE20JB008862</option>
                    <option value="LK6ADCE20JB009252">LK6ADCE20JB009252</option>
                    <option value="LK6ADCE21JB009051">LK6ADCE21JB009051</option>
                    <option value="LK6ADCE21JB010538">LK6ADCE21JB010538</option>
                    <option value="LK6ADCE21JB011110">LK6ADCE21JB011110</option>
                    <option value="LK6ADCE22JB008295">LK6ADCE22JB008295</option>
                    <option value="LK6ADCE22JB009639">LK6ADCE22JB009639</option>
                    <option value="LK6ADCE22JB011116">LK6ADCE22JB011116</option>
                    <option value="LK6ADCE23JB009102">LK6ADCE23JB009102</option>
                    <option value="LK6ADCE23JB009634">LK6ADCE23JB009634</option>
                    <option value="LK6ADCE23JB011142">LK6ADCE23JB011142</option>
                    <option value="LK6ADCE24JB007889">LK6ADCE24JB007889</option>
                    <option value="LK6ADCE24JB008251">LK6ADCE24JB008251</option>
                    <option value="LK6ADCE24JB008864">LK6ADCE24JB008864</option>
                    <option value="LK6ADCE24JB008878">LK6ADCE24JB008878</option>
                    <option value="LK6ADCE24JB011084">LK6ADCE24JB011084</option>
                    <option value="LK6ADCE24JB011098">LK6ADCE24JB011098</option>
                    <option value="LK6ADCE24JB011134">LK6ADCE24JB011134</option>
                    <option value="LK6ADCE25JB008288">LK6ADCE25JB008288</option>
                    <option value="LK6ADCE25JB008310">LK6ADCE25JB008310</option>
                    <option value="LK6ADCE25JB008887">LK6ADCE25JB008887</option>
                    <option value="LK6ADCE25JB011059">LK6ADCE25JB011059</option>
                    <option value="LK6ADCE25JB011062">LK6ADCE25JB011062</option>
                    <option value="LK6ADCE25JB011112">LK6ADCE25JB011112</option>
                    <option value="LK6ADCE26JB008879">LK6ADCE26JB008879</option>
                    <option value="LK6ADCE26JB008882">LK6ADCE26JB008882</option>
                    <option value="LK6ADCE26JB010499">LK6ADCE26JB010499</option>
                    <option value="LK6ADCE27JB008292">LK6ADCE27JB008292</option>
                    <option value="LK6ADCE27JB008874">LK6ADCE27JB008874</option>
                    <option value="LK6ADCE27JB009264">LK6ADCE27JB009264</option>
                    <option value="LK6ADCE27JB010480">LK6ADCE27JB010480</option>
                    <option value="LK6ADCE27JB011144">LK6ADCE27JB011144</option>
                    <option value="LK6ADCE28JB008253" selected=true>LK6ADCE28JB008253</option>
                    <option value="LK6ADCE28JB009077">LK6ADCE28JB009077</option>
                    <option value="LK6ADCE28JB009273">LK6ADCE28JB009273</option>
                    <option value="LK6ADCE28JB010522">LK6ADCE28JB010522</option>
                    <option value="LK6ADCE28JB011122">LK6ADCE28JB011122</option>
                    <option value="LK6ADCE29JB007922">LK6ADCE29JB007922</option>
                    <option value="LK6ADCE29JB008293">LK6ADCE29JB008293</option>
                    <option value="LK6ADCE29JB009640">LK6ADCE29JB009640</option>
                    <option value="LK6ADCE29JB011114">LK6ADCE29JB011114</option>
                    <option value="LK6ADCE2XJB008285">LK6ADCE2XJB008285</option>
                    <option value="LK6ADCE2XJB008299">LK6ADCE2XJB008299</option>
                    <option value="LK6ADCE2XJB008884">LK6ADCE2XJB008884</option>
                    <option value="LK6ADCE2XJB009081">LK6ADCE2XJB009081</option>
                    <option value="LK6ADCE2XJB009243">LK6ADCE2XJB009243</option>
                    <option value="LK6ADCE2XJB009694">LK6ADCE2XJB009694</option>
                    <option value="LK6ADCE2XJB011137">LK6ADCE2XJB011137</option>
                    <option value="LK6ADCE20HB005003">LK6ADCE20HB005003</option>
                    <option value="LK6ADCE20HB005082">LK6ADCE20HB005082</option>
                    <option value="LK6ADCE20HB005339">LK6ADCE20HB005339</option>
                    <option value="LK6ADCE20HB005390">LK6ADCE20HB005390</option>
                    <option value="LK6ADCE20HB005678">LK6ADCE20HB005678</option>
                    <option value="LK6ADCE20HB005700">LK6ADCE20HB005700</option>
                    <option value="LK6ADCE20HB006040">LK6ADCE20HB006040</option>
                    <option value="LK6ADCE20HB006247">LK6ADCE20HB006247</option>
                    <option value="LK6ADCE21HB005012">LK6ADCE21HB005012</option>
                    <option value="LK6ADCE21HB005026">LK6ADCE21HB005026</option>
                    <option value="LK6ADCE21HB005155">LK6ADCE21HB005155</option>
                    <option value="LK6ADCE21HB005401">LK6ADCE21HB005401</option>
                    <option value="LK6ADCE21HB005446">LK6ADCE21HB005446</option>
                    <option value="LK6ADCE21HB005527">LK6ADCE21HB005527</option>
                    <option value="LK6ADCE21HB005723">LK6ADCE21HB005723</option>
                    <option value="LK6ADCE21HB005995">LK6ADCE21HB005995</option>
                    <option value="LK6ADCE21HB006063">LK6ADCE21HB006063</option>
                    <option value="LK6ADCE21HB006564">LK6ADCE21HB006564</option>
                    <option value="LK6ADCE21HB006810">LK6ADCE21HB006810</option>
                    <option value="LK6ADCE22HB005102">LK6ADCE22HB005102</option>
                    <option value="LK6ADCE22HB005438">LK6ADCE22HB005438</option>
                    <option value="LK6ADCE22HB005701">LK6ADCE22HB005701</option>
                    <option value="LK6ADCE22HB006203">LK6ADCE22HB006203</option>
                    <option value="LK6ADCE22HB006556">LK6ADCE22HB006556</option>
                    <option value="LK6ADCE23HB005383">LK6ADCE23HB005383</option>
                    <option value="LK6ADCE23HB005402">LK6ADCE23HB005402</option>
                    <option value="LK6ADCE23HB005433">LK6ADCE23HB005433</option>
                    <option value="LK6ADCE23HB005447">LK6ADCE23HB005447</option>
                    <option value="LK6ADCE23HB005481">LK6ADCE23HB005481</option>
                    <option value="LK6ADCE23HB005724">LK6ADCE23HB005724</option>
                    <option value="LK6ADCE23HB005738">LK6ADCE23HB005738</option>
                    <option value="LK6ADCE23HB005805">LK6ADCE23HB005805</option>
                    <option value="LK6ADCE23HB006789">LK6ADCE23HB006789</option>
                    <option value="LK6ADCE24HB005103">LK6ADCE24HB005103</option>
                    <option value="LK6ADCE24HB005425">LK6ADCE24HB005425</option>
                    <option value="LK6ADCE24HB005697">LK6ADCE24HB005697</option>
                    <option value="LK6ADCE24HB005957">LK6ADCE24HB005957</option>
                    <option value="LK6ADCE24HB006381">LK6ADCE24HB006381</option>
                    <option value="LK6ADCE24HB006512">LK6ADCE24HB006512</option>
                    <option value="LK6ADCE25HB005207">LK6ADCE25HB005207</option>
                    <option value="LK6ADCE25HB005322">LK6ADCE25HB005322</option>
                    <option value="LK6ADCE25HB005370">LK6ADCE25HB005370</option>
                    <option value="LK6ADCE25HB005384">LK6ADCE25HB005384</option>
                    <option value="LK6ADCE25HB005434">LK6ADCE25HB005434</option>
                    <option value="LK6ADCE25HB005529">LK6ADCE25HB005529</option>
                    <option value="LK6ADCE25HB006812">LK6ADCE25HB006812</option>
                    <option value="LK6ADCE26HB005085">LK6ADCE26HB005085</option>
                    <option value="LK6ADCE26HB005409">LK6ADCE26HB005409</option>
                    <option value="LK6ADCE26HB005460">LK6ADCE26HB005460</option>
                    <option value="LK6ADCE26HB005703">LK6ADCE26HB005703</option>
                    <option value="LK6ADCE26HB006284">LK6ADCE26HB006284</option>
                    <option value="LK6ADCE26HB006558">LK6ADCE26HB006558</option>
                    <option value="LK6ADCE26HB006804">LK6ADCE26HB006804</option>
                    <option value="LK6ADCE26HB006852">LK6ADCE26HB006852</option>
                    <option value="LK6ADCE27HB005063">LK6ADCE27HB005063</option>
                    <option value="LK6ADCE27HB006407">LK6ADCE27HB006407</option>
                    <option value="LK6ADCE27HB006536">LK6ADCE27HB006536</option>
                    <option value="LK6ADCE27HB006553">LK6ADCE27HB006553</option>
                    <option value="LK6ADCE27HB006861">LK6ADCE27HB006861</option>
                    <option value="LK6ADCE28HB005010">LK6ADCE28HB005010</option>
                    <option value="LK6ADCE28HB005072">LK6ADCE28HB005072</option>
                    <option value="LK6ADCE28HB005282">LK6ADCE28HB005282</option>
                    <option value="LK6ADCE28HB005413">LK6ADCE28HB005413</option>
                    <option value="LK6ADCE28HB005640">LK6ADCE28HB005640</option>
                    <option value="LK6ADCE28HB006027">LK6ADCE28HB006027</option>
                    <option value="LK6ADCE28HB006464">LK6ADCE28HB006464</option>
                    <option value="LK6ADCE28HB006836">LK6ADCE28HB006836</option>
                    <option value="LK6ADCE29HB005176">LK6ADCE29HB005176</option>
                    <option value="LK6ADCE2XHB005185">LK6ADCE2XHB005185</option>
                    <option value="LK6ADCE2XHB005526">LK6ADCE2XHB005526</option>
                    <option value="LK6ADCE2XHB006207">LK6ADCE2XHB006207</option>
                    <option value="LK6ADCE2XHB006546">LK6ADCE2XHB006546</option>
                    <option value="LK6ADCE2XHB006790">LK6ADCE2XHB006790</option>

                    
                </select>
                <script>
                    $('#select').dropdown();
                    $('#search-select').dropdown();
                </script>
                <div class="ui animated button" onclick="onClickSearchButton()">
                    <div class="visible content">搜索</div>
                    <div class="hidden content">走</div>
                </div>  
            </div>
            <div id="detailLine" style="height: 35%; width: 100%; float: left;">
                    <div id="dynamicLine" style="height: 130%; width: 100%; float: left;"></div>
            </div>

            <div id="detailPanel" style="height: 45%; width: 100%; float: left;">
                <div id="guage" style="height: 130%; width: 100%; float: left;"></div>
            </div>
            
        </div>
        <div id="chart">
            <div id="Pie" style="height: 100%; width: 25%; float: left;"></div>
            <!-- <div id="Gauge" style="height: 100%; width: 25%; float: left;"></div> -->
            <!-- <div id="Heatmap"" style="height: 100%; width: 50%; float: left;"></div> -->
            <div id="Stack" style="height: 100%; width: 50%; float: left;"></div>
            <div id="Board" style="height: 100%; width: 25%; float: left;">
                <div style="height: 40%; float: left; padding-right: 10%;">
                    <p id="time1" style="margin-left: 5%; margin-top: 5%;">item1</p>
                    <iframe id="fancybox-frame" name="fancybox-frame1573219207283" frameborder="0" scrolling="no" hspace="0"  src="http://i.tianqi.com/index.php?c=code&a=getcode&id=35&h=55&w=200"></iframe>
                
                </div>                    
                <div style="height: 60%; width: 100%; padding-left:5%; float: left;">
                    <table border="0" style="font: size 200px; height: 100%; width: 70%;">
                        <tr><td> </td></tr>
                        <tr><td> </td></tr>
                        <tr><td> </td></tr>
                        <tr><td> </td></tr>

                    </table>
                </div>

                </div>
                
                <script>
                    function mytime(){
                        var a = new Date();
                        var b = a.toLocaleTimeString();
                        var c = a.toLocaleDateString();
                        document.getElementById("time1").innerHTML = "&nbsp"+"&nbsp"+c+"&nbsp"+b;
                        }
                    setInterval(function() {mytime()},1000);
                </script>

            </div>

            
        </div>


    </body>
</html>

<script type="text/javascript">

// <!-- 初始化地图 -->

	// 百度地图API功能
	var map = new BMap.Map("mapDiv");  // 创建Map实例
	// map.centerAndZoom("上海交通大学-电子信息与电气工程学院",15);      // 初始化地图,用城市名设置地图中心点
    //必须得要用坐标点，不然没法使用个性化地图
    // map.centerAndZoom(new BMap.Point(121.449051,31.03083),16);   //电院
    map.centerAndZoom(new BMap.Point(121.447176,31.033731),16); //新行政楼

    map.enableScrollWheelZoom(true);    //允许滚轮缩放地图
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
	var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
	var top_right_navigation = new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_RIGHT, type: BMAP_NAVIGATION_CONTROL_SMALL}); //右上角，仅包含平移和缩放按钮
    // map.addControl(top_left_control);        
	// map.addControl(top_left_navigation);     
	map.addControl(top_right_navigation);
    // map.setMapStyleV2({     
    //     styleId: '17c84567c712a49ee687af01700e1d74'
    // });



// <!-- 测试工具 -->
    function getRandomData(baseValue){
        var amplitude = (Math.random()*baseValue/5).toFixed(2)-0;
        if(Math.random() > 0.5) return baseValue+amplitude;
        else return baseValue-amplitude;

        // return Math.random()*maxValue.toFixed(2)-0;
    }

    var stackTimeStamp = 0;

    function getStackTimeStamp(){
        stackTimeStamp += 1;
        return stackTimeStamp;
    }

    var onlineCarPosition = [['LK6ADCE28JB008253', 121.451102, 31.030699], ['LK6ADCE20HB005678', 121.449193, 31.031152], ['LK6ADCE22HB005438', 121.450657, 31.033836]];
    var offlineCarPosition = [['LK6ADCE25HB005434', 121.441102, 31.031152], ['LK6ADCE26HB006852', 121.450657, 31.034961]];
    var chargingCarPosition = [['LK6ADCE2XHB006790', 121.441215, 31.031527]];

    function getNextStep(prePosition){
        var nxtLongi = prePosition['longitude'] + (Math.random()-0.5)/1000;
        var nxtLati = prePosition['latitude'] + (Math.random()-0.5)/1000;
        return {'longitude':nxtLongi, 'latitude':nxtLati};
    }

    var carTraceHistory = [{'longitude':121.451102, 'latitude':31.030699}]

    for(var i = 0; i < 100; ++i){
        carTraceHistory.push(getNextStep(carTraceHistory[carTraceHistory.length-1]));
    }

// <!-- 全局变量 当前激活脚本 状态信息 -->

    // 用于层叠图的全局变量数组
    var stack_online;
    var stack_offline;
    var stack_charging;
    var stack_time;

    // 用于背景查询，当前需要查哪些值
    var need_online = true;
    var need_offline = true;
    var need_charging = true;

    // 当前interval函数句柄
    var curIntervalHandler;

    // 当前是单车模式还是背景模式
    var curSingleMode = false;
    // 判断当前是否需要更新
    // 当鼠标悬停再某个点上时，不更新，防止信息窗口山东
    var needUpdateMap = true;

    // 地图锁
    var mapLocked = false;

    // 当前关注单车
    var curCarVin; 
    var curCarType;

    // 用于侧边栏折线图的数据
    var singleDataPoly = new Array();

    // 单车模式下当前头部点覆盖物句柄
    var curNewOverlayHandler;
    var curOldOverlayHandler;

    // 单车模式下轨迹最近时间戳
    var curTraceStamp;

    // 不同状态下的覆盖物图标
    var iconOnline = new BMap.Icon("icon-green-small.gif", new BMap.Size(25, 25));
    var iconOffline = new BMap.Icon("icon-pink-small.gif", new BMap.Size(25, 25));
    var iconCharging = new BMap.Icon("icon-blue-small.gif", new BMap.Size(25, 25));

    var iconStart = new BMap.Icon("start.png", new BMap.Size(25, 25));
    var iconEnd = new BMap.Icon("final.png", new BMap.Size(25, 25));

    var iconArr = new Array();
    iconArr.push(iconOnline,iconOffline, iconCharging);

    // 是否需要显示动画
    var needAnimation = [true, true, true]

    // 时间解析
    // Date.parse("2018-11-30T09:49:50.000Z")
    var timeGap = 1000*5    //1000ms*5s

    function timeValidate(rawTime){
        Math.floor(rawTime.getTime()/timeGap)*timeGap
    }
    



// <!-- 单车查询 -->
    function requestSingleCarTrace(){

        curOldOverlayHandler = new BMap.Marker(new BMap.Point(carTraceHistory[0]['longitude'], carTraceHistory[0]['latitude']));
        curOldOverlayHandler.setIcon(iconStart);
        map.addOverlay(curOldOverlayHandler)
        curOldOverlayHandler.setAnimation(BMAP_ANIMATION_DROP);//跳动的动画

        for(var i = 1; i < carTraceHistory.length; ++i){
            drawLine(carTraceHistory[i-1], carTraceHistory[i]);
        }

        curNewOverlayHandler = new BMap.Marker(new BMap.Point(carTraceHistory[carTraceHistory.length-1]['longitude'], carTraceHistory[carTraceHistory.length-1]['latitude']));
        curNewOverlayHandler.setIcon(iconEnd);
        var content = curCarVin;
        map.addOverlay(curNewOverlayHandler)
        curNewOverlayHandler.setAnimation(BMAP_ANIMATION_BOUNCE);//跳动的动画
        addMouseHandler(content, curNewOverlayHandler);

        
        var view = map.getViewport(eval([curOldOverlayHandler.getPosition(), curNewOverlayHandler.getPosition()]));
        var mapZoom = view.zoom; 
        var centerPoint = view.center; 
        map.centerAndZoom(centerPoint,mapZoom);

    }

    function requestSingleCarHistory(){
        for (var i = 0; i < 5; i++) {
            data.shift();
            data.push(randomData());
        }
    
        myChartLine.setOption({
            series: [{
                data: data
            }]
        });
        
    }

    function requestSingleCar(){
        optionGuage.series[0].data[0].value = (Math.random()*60).toFixed(2) - 0;
        optionGuage.series[1].data[0].value = (Math.random()*7).toFixed(2) - 0;
        optionGuage.series[2].data[0].value = (Math.random()*2).toFixed(2) - 0;
        optionGuage.series[3].data[0].value = (Math.random()*2).toFixed(2) - 0;
        myChartGuage.setOption(optionGuage,true);
    }


    

// <!-- 默认查询 -->
    function requestOnline(){
        drawMapPoint(onlineCarPosition, 0);
    }
    function requestOffline(){
        drawMapPoint(offlineCarPosition, 1);
    }
    function requestCharging(){
        drawMapPoint(chargingCarPosition, 2);
    }

    function backgroundRequest(){
        // map.clearOverlays();
        if(need_online){requestOnline();}
        if(need_offline){requestOffline();}
        if(need_charging){requestCharging();}
    }

// <!-- 背景查询 -->

    // 初始化层叠图
    function initialStack(){
        
        $.ajax({
            url: 'http://202.120.60.31:3000/query/history/status', //请求的url
            type: 'get', //请求的方式
            data: 'limit=100',
            error: function (data) {
                alert('initialStack请求失败');
            },
            success: function (data) {
                stack_online = new Array(1200);
                stack_offline = new Array(1200);
                stack_charging = new Array(1200);
                stack_time = new Array(1200);
                
                var curDate = timeValidate(new Date());

                for(var i = 0; i < 1200; ++i){
                    stack_time[1200-1-i] = (curDate-timeGap*i);
                    stack_offline[i] = 0;
                    stack_charging[i] = 0;
                    stack_online[i] = 0;
                }

                for(var car in data){
                    curInfo = data[car]['info']
                    var curDataIdx = 0;
                    for(var i in stack_time){
                        while(curDataIdx < curInfo.length && timeValidate(curInfo[curDataIdx]['create_time']) <= stack_time[i]){
                            // alert(curDataIdx);
                            ++curDataIdx;
                        }
                        if(curDataIdx == 0){
                            continue;
                        }else{
                            if(curInfo[curDataIdx-1]['vehicle_operating_mode'] == '行驶'){
                                stack_online[i] += 1;
                            }else if(curInfo[curDataIdx-1]['vehicle_operating_mode'] == '上电'){
                                stack_charging[i] += 1;
                            }else if(curInfo[curDataIdx-1]['vehicle_operating_mode'] == '休眠'){
                                stack_offline[i] += 1;
                            }
                        }
                    }
                }
                // alert('brk 1');
                while(stack_time.length > 0){
                    // alert(stack_time.length);
                    // alert('brk 2');
                    // alert(stack_online[0]);
                    // alert(stack_offline[0]);
                    // alert(stack_charging[0]);
                    if(stack_online[0] == 0 && stack_offline[0] == 0 && stack_charging[0] == 0){
                        stack_online.shift();
                        stack_offline.shift();
                        stack_charging.shift();
                        stack_time.shift();
                    }else{
                        break;
                    }
                }

                // alert('brk 3');
                // alert(stack_time.length)

                var option = myChartStack.getOption();
                option.series[0].data = stack_online;
                option.series[1].data = stack_offline;
                option.series[2].data = stack_charging;
                option.xAxis[0].data = stack_time;

                myChartStack.setOption(option);

            }
            
        });

        // stack_online = new Array();
        // stack_offline = new Array();
        // stack_charging = new Array();
        // stack_time = new Array();
        // for(var i = 0; i < 1000; ++i){
        //     stack_time.push(getStackTimeStamp());
        //     stack_online.push(getRandomData(100));
        //     stack_offline.push(getRandomData(50));
        //     stack_charging.push(getRandomData(50));
        // }
        // var option = myChartStack.getOption();
        // option.series[0].data = stack_online;
        // option.series[1].data = stack_offline;
        // option.series[2].data = stack_charging;
        // option.xAxis[0].data = stack_time;

        // myChartStack.setOption(option);
    }

    function requestCurrentTypeNum(){
        $.ajax({
            url: 'http://202.120.60.31:3000/query/history/status', //请求的url
            type: 'get', //请求的方式
            data: 'limit=1',
            error: function (data) {
                alert('requestCurrentTypeNum请求失败');
            },
            success: function (data) {
                var cur_online = 0;
                var cur_offline = 0;
                var cur_charging = 0;
                for(var i in data){
                    if(data[i]['latest_info']['vehicle_operating_mode'] == '休眠'){
                        ++cur_offline;
                    }else if(data[i]['latest_info']['vehicle_operating_mode'] == '行驶'){
                        ++cur_online;
                    }else if(data[i]['latest_info']['vehicle_operating_mode'] == '上电'){
                        ++cur_charging;
                    }
                }
                var option = myChartPie.getOption();
                option.series[0].data[0]['value'] = cur_online;
                option.series[0].data[1]['value'] = cur_offline;
                option.series[0].data[2]['value'] = cur_charging;
                myChartPie.setOption(option);

                // alert('brk 1');
                var curDate = timeValidate(new Date());
                if(stack_time.length != 0 && curDate <= stack_time[stack_time.length-1]){
                    // alert('brk 2');
                    //do nothing
                }else{
                    // alert('brk 3');

                    if(stack_time.length >= 500){
                        stack_time.shift();
                    }
                    stack_time.push(curDate);
                    if(stack_time.length >= 500){
                        stack_online.shift();
                    }
                    stack_online.push(cur_online);
                    if(stack_time.length >= 500){
                        stack_offline.shift();
                    }
                    stack_offline.push(cur_offline);
                    if(stack_time.length >= 500){
                        stack_charging.shift();
                    }
                    stack_charging.push(cur_charging);

                    var option = myChartStack.getOption();
                    option.series[0].data = stack_online;
                    option.series[1].data = stack_offline;
                    option.series[2].data = stack_charging;
                    option.xAxis[0].data = stack_time;

                    myChartStack.setOption(option);
                }

            }
            
        });

        /**
         * stack初始化方法，UTC时间->毫秒数
         * 从此刻开始向前追溯一定的距离，每1000ms为array中的一个单位
         * 针对每辆car
         *  针对每个时间单为
         *      遍历info数组，知道到时间不大于当前单位的那个元素，填入
         * 
         */
        // var cur_online = getRandomData(100);
        // var cur_offline = getRandomData(50);
        // var cur_charging = getRandomData(50);

        // // var option = myChartPie.getOption();
        // // option.series[0].data[0]['value'] = cur_online;
        // // option.series[0].data[1]['value'] = cur_offline;
        // // option.series[0].data[2]['value'] = cur_charging;
        // // myChartPie.setOption(option);

        // stack_time.shift();
        // stack_time.push(getStackTimeStamp());
        // stack_online.shift();
        // stack_online.push(cur_online);
        // stack_offline.shift();
        // stack_offline.push(cur_offline);
        // stack_charging.shift();
        // stack_charging.push(cur_charging);

        // option = myChartStack.getOption();
        // option.series[0].data = stack_online;
        // option.series[1].data = stack_offline;
        // option.series[2].data = stack_charging;
        // option.xAxis[0].data = stack_time;

        // myChartStack.setOption(option);
    }


// <!-- 回调函数 -->  

    // <!-- 饼图回调函数 --> 
    function eConsole(param) {
        if(param.dataIndex == 0){
            need_online = !need_online;
            needAnimation[0] = true; need
        }else if(param.dataIndex == 1){
            need_offline = !need_offline;
            needAnimation[1] = true;
        }else if(param.dataIndex == 2){
            need_charging = !need_charging;
            needAnimation[2] = true;
        }
    //     map.clearOverlays();
    // 　　clickFunc(param.dataIndex);//执行点击效果
    }

    // <!-- 搜索点击回调函数 -->
    function onClickSearchButton(){
        var requestType = document.getElementById('select');
        var requestTypeValue = requestType.options[requestType.selectedIndex].value;
        var requestId = document.getElementById('search-select');
        var requestIdValue = requestId.options[requestId.selectedIndex].value;

        do_initRequestSingleCar(requestTypeValue, requestIdValue)

    }

    // <!-- 地图覆盖物点击回调函数 -->
    function onClickOverlay(targetId){
        var requestType = document.getElementById('select');
        var requestTypeValue = requestType.options[requestType.selectedIndex].value;

        do_initRequestSingleCar(requestTypeValue, targetId)

        // onClickSearchButton()
        // alert(targetId);
    }

    // <!-- 进入单车模式的实际执行函数 -->
    function do_initRequestSingleCar(requestTypeValue, requestIdValue){
        data = [];
        for (var i = 0; i < 1000; i++) {
            data.push(randomData());
        }
        alert('single start');
        if(requestIdValue != 'LK6ADCE28JB008253') alert('no data yet');
        else{
            mapLocked = true;
            map.clearOverlays();
            curCarVin = requestIdValue;
            curCarType = requestTypeValue;
            requestSingleCarTrace();
            map.addEventListener("click", backToBackground);
            curSingleMode = true;
            mapLocked = false;
            
        }
    }

    // 进入单车模式后增加的地图回调函数 用于返回到默认模式
    function backToBackground(){
        // alert("evoke");
        map.removeEventListener("click", backToBackground);
        for(var i = 0; i < needAnimation.length; ++i){
            needAnimation[i] = true;
        }
        map.centerAndZoom(new BMap.Point(121.447176,31.033731),16); //新行政楼

        var option = myChartGuage.getOption();
        option.series[0].data[0].value = 0;
        option.series[1].data[0].value = 0;
        option.series[2].data[0].value = 0;
        option.series[3].data[0].value = 0;
        myChartGuage.setOption(optionGuage);

        option = myChartLine.getOption();
        data=[];
        option.series[0].data = data;
        myChartLine.setOption(option);

        curSingleMode = false;
    }



// <!-- 绘图 -->
// <!-- 右侧栏折线图 开始 -->

    var domLine = document.getElementById("dynamicLine");
    var myChartLine = echarts.init(domLine);
    var app = {};
    optionLine = null;
    function randomData() {
        now = new Date(+now + oneDay);
        value = value + Math.random() * 21 - 10;
        return {
            name: now.toString(),
            value: [
                [now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/'),
                Math.round(value)
            ]
        }
    }
    
    var data = new Array();
    var now = +new Date(1997, 9, 3);
    var oneDay = 24 * 3600 * 1000;
    var value = Math.random() * 1000;
    // for (var i = 0; i < 1000; i++) {
    //     data.push(randomData());
    // }
    
    optionLine = {
        title: {
            text: '历史速度'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function (params) {
                params = params[0];
                var date = new Date(params.name);
                return date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear() + ' : ' + params.value[1];
            },
            axisPointer: {
                animation: false
            }
        },
        xAxis: {
            type: 'time',
            splitLine: {
                show: false
            }
        },
        yAxis: {
            type: 'value',
            boundaryGap: [0, '100%'],
            splitLine: {
                show: false
            }
        },
        series: [{
            name: '模拟数据',
            type: 'line',
            showSymbol: false,
            hoverAnimation: false,
            data: data
        }]
    };
    
    // setInterval(function () {
    
    //     for (var i = 0; i < 5; i++) {
    //         data.shift();
    //         data.push(randomData());
    //     }
    
    //     myChartLine.setOption({
    //         series: [{
    //             data: data
    //         }]
    //     });
    // }, 1000);;
    if (optionLine && typeof optionLine === "object") {
        myChartLine.setOption(optionLine, true);
    }

// <!-- 右侧栏折线图 结束 -->

// <!-- 右侧栏仪表盘 开始 -->


    var domGuage = document.getElementById("guage");
    var myChartGuage = echarts.init(domGuage);
    var app = {};
    optionGuage = null;
    optionGuage = {
        tooltip : {
            formatter: "{a} <br/>{c} {b}"
        },
        // toolbox: {
        //     show: true,
        //     feature: {
        //         restore: {show: true},
        //         saveAsImage: {show: true}
        //     }
        // },
        series : [
            {
                name: '速度',
                type: 'gauge',
                z: 3,
                center: ['48%', '50%'],    // 默认全局居中

                min: 0,
                max: 50,
                splitNumber: 10,
                radius: '55%',
                axisLine: {            // 坐标轴线
                    lineStyle: {       // 属性lineStyle控制线条样式
                        color : [ //表盘颜色
                            [ 0.2,  "#8FBC8F"],//0-50%处的颜色
                            [ 0.6, "#4F94CD" ],//51%-70%处的颜色
                            [ 1, "#B22222" ],//70%-90%处的颜色
                        ],
                        width: 10
                    }
                },
                axisTick: {            // 坐标轴小标记
                    length: "15%",        // 属性length控制线长
                    lineStyle: {       // 属性lineStyle控制线条样式
                        color: 'auto'
                    }
                },
                splitLine: {           // 分隔线
                    length: "20%",         // 属性length控制线长
                    lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                        color: 'auto'
                    }
                },
                axisLabel: {
                    backgroundColor: 'auto',
                    borderRadius: 2,
                    color: '#eee',
                    padding: 3,
                    fontSize:'70%',
                    textShadowBlur: 2,
                    textShadowOffsetX: 1,
                    textShadowOffsetY: 1,
                    textShadowColor: '#222'
                },
                pointer: {
                    width:"7%"
                },
                title : {
                    // 其余属性默认使用全局文本样式，详见TEXTSTYLE
                    fontWeight: 'bolder',
                    fontSize: '60%',
                    fontStyle: 'italic'
                },
                detail : {
                    // 其余属性默认使用全局文本样式，详见TEXTSTYLE
                    formatter: function (value) {
                        value = (value + '').split('.');
                        value.length < 2 && (value.push('00'));
                        return ('00' + value[0]).slice(-2)
                            + '.' + (value[1] + '00').slice(0, 2);
                    },
                    fontWeight: 'bolder',
                    borderRadius: 3,
                    backgroundColor: '#444',
                    borderColor: '#aaa',
                    shadowBlur: 5,
                    shadowColor: '#333',
                    shadowOffsetX: 0,
                    shadowOffsetY: 3,
                    borderWidth: 2,
                    textBorderColor: '#000',
                    textBorderWidth: 2,
                    textShadowBlur: 2,
                    textShadowColor: '#fff',
                    textShadowOffsetX: 0,
                    textShadowOffsetY: 0,
                    fontFamily: 'Arial',
                    fontSize:'100%',
                    width: 100,
                    color: '#eee',
                    rich: {}
                },
                data:[{value: 40, name: 'km/h'}]
            },
            {
                name: '转速',
                type: 'gauge',
                center: ['15%', '55%'],    // 默认全局居中
                radius: '30%',
                min:0,
                max:7,
                endAngle:50,
                splitNumber:7,
                axisLine: {            // 坐标轴线
                    lineStyle: {       // 属性lineStyle控制线条样式
                        width: 8
                    }
                },
                axisTick: {            // 坐标轴小标记
                    length:'15%',        // 属性length控制线长
                    lineStyle: {       // 属性lineStyle控制线条样式
                        color: 'auto'
                    }
                },
                splitLine: {           // 分隔线
                    length:'20%',         // 属性length控制线长
                    lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                        color: 'auto'
                    }
                },
                pointer: {
                    width:"8%"
                },
                title: {
                    offsetCenter: [0, '-30%'],       // x, y，单位px
                    fontSize:'60%'
                },
                detail: {
                    // 其余属性默认使用全局文本样式，详见TEXTSTYLE
                    fontWeight: 'bolder',
                    fontSize:'10%',
                },
                data:[{value: 1.5, name: 'x1000 r/min'}]
            },
            {
                name: '油表',
                type: 'gauge',
                center: ['80%', '40%'],    // 默认全局居中
                radius: '25%',
                min: 0,
                max: 2,
                startAngle: 135,
                endAngle: 45,
                splitNumber: 2,
                axisLine: {            // 坐标轴线
                    lineStyle: {       // 属性lineStyle控制线条样式
                        width: 8
                    }
                },
                axisTick: {            // 坐标轴小标记
                    splitNumber: 5,
                    length: '10%',        // 属性length控制线长
                    lineStyle: {        // 属性lineStyle控制线条样式
                        color: 'auto'
                    }
                },
                axisLabel: {
                    formatter:function(v){
                        switch (v + '') {
                            case '0' : return 'E';
                            case '1' : return 'Gas';
                            case '2' : return 'F';
                        }
                    }
                },
                splitLine: {           // 分隔线
                    length: '15%',         // 属性length控制线长
                    lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                        color: 'auto'
                    }
                },
                pointer: {
                    width:"4%"
                },
                title : {
                    show: false
                },
                detail : {
                    show: false
                },
                data:[{value: 0.5, name: 'gas'}]
            },
            {
                name: '水表',
                type: 'gauge',
                center : ['80%', '58%'],    // 默认全局居中
                radius : '25%',
                min: 0,
                max: 2,
                startAngle: 315,
                endAngle: 225,
                splitNumber: 2,
                axisLine: {            // 坐标轴线
                    lineStyle: {       // 属性lineStyle控制线条样式
                        width: 8
                    }
                },
                axisTick: {            // 坐标轴小标记
                    show: false
                },
                axisLabel: {
                    formatter:function(v){
                        switch (v + '') {
                            case '0' : return 'H';
                            case '1' : return 'Water';
                            case '2' : return 'C';
                        }
                    }
                },
                splitLine: {           // 分隔线
                    length: '15%',         // 属性length控制线长
                    lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                        color: 'auto'
                    }
                },
                pointer: {
                    width:"4%"
                },
                title: {
                    show: false
                },
                detail: {
                    show: false
                },
                data:[{value: 0.5, name: 'gas'}]
            }
        ]
    };
    
    // setInterval(function (){
    //     optionGuage.series[0].data[0].value = (Math.random()*60).toFixed(2) - 0;
    //     optionGuage.series[1].data[0].value = (Math.random()*7).toFixed(2) - 0;
    //     optionGuage.series[2].data[0].value = (Math.random()*2).toFixed(2) - 0;
    //     optionGuage.series[3].data[0].value = (Math.random()*2).toFixed(2) - 0;
    //     myChartGuage.setOption(optionGuage,true);
    // },2000);;
    if (optionGuage && typeof optionGuage === "object") {
        myChartGuage.setOption(optionGuage, true);
    }


// <!-- 底部栏 -->


// <!-- Pie Start -->
    var domPie = document.getElementById("Pie");
    var myChartPie = echarts.init(domPie);
    var app = {};
    optionPie = null;
    app.title = '环形图';
    
    optionPie = {
        tooltip: {
            triggeron:'click',
            trigger: 'item',
            formatter: "{b}: {c} ({d}%)"
        },
        legend: {
            orient: 'vertical',
            x: 'left',
            data:['online','offline','charging']
            // data:['运行中','空闲中','低电量','离线','待维修']
            // tooltip: {
            //     triggeron:'click',
            //     trigger: 'item',
            //     formatter: "{b}: {c} ({d}%)"
            // }

        },
        series: [
            {
                name:'车辆状态',
                type:'pie',
                radius: ['35%', '70%'],
                avoidLabelOverlap: false,
                label: {
                    normal: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        show: true,
                        textStyle: {
                            fontSize: '110%',
                            fontWeight: 'bold'
                        }
                    }
                },
                labelLine: {
                    normal: {
                        show: true
                    }
                },
                data:[
                    {value:335, name:'online'},
                    {value:335, name:'offline'},
                    {value:310, name:'charging'},
                    // {value:234, name:'离线'},
                    // {value:135, name:'待维修'},
                ]
            }
        ]
    };
    ;
    if (optionPie && typeof optionPie === "object") {
        myChartPie.setOption(optionPie, true);
    }
// <!-- Pie End -->


// 层叠图开始
    var domStack = document.getElementById("Stack");
    var myChartStack = echarts.init(domStack);
    var app = {};
    optionStack = null;
    optionStack = {
        title: {
            text: '车辆使用情况'
        },
        tooltip : {
            trigger: 'axis',
            axisPointer: {
                type: 'cross',
                label: {
                    backgroundColor: '#6a7985'
                }
            }
        },
        legend: {
            // data:['使用中','空闲中','低电量','离线','待维修']
            data:['online','offline','charging']
        },
        // toolbox: {
        //     feature: {
        //         saveAsImage: {}
        //     }
        // },
        grid: {
            // top: '15%',
            left: '3%',
            right: '4%',
            // bottom: '50px',
            containLabel: true
        },
        xAxis : [
            {
                type : 'category',
                boundaryGap : false,
                data : new Array(),
                // data : ['','','','','','','', '']
            }
        ],
        yAxis : [
            {
                type : 'value'
            }
        ],
        dataZoom: [
            {   // 这个dataZoom组件，默认控制x轴。
                type: 'slider', // 这个 dataZoom 组件是 slider 型 dataZoom 组件
                start: 50,      // 左边在 10% 的位置。
                end: 100         // 右边在 60% 的位置。
            },
            {   // 这个dataZoom组件，也控制x轴。
                type: 'inside', // 这个 dataZoom 组件是 inside 型 dataZoom 组件
                start: 50,      // 左边在 10% 的位置。
                end: 100         // 右边在 60% 的位置。
            }
        ],
        series : [
            {
                name:'online',
                type:'line',
                stack: '总量',
                areaStyle: {},
                data : new Array(),
                // data:[120, 132, 101, 134, 90, 230, 210,1000]
            },
            {
                name:'offline',
                type:'line',
                stack: '总量',
                areaStyle: {},
                data : new Array(),
                // data:[220, 182, 191, 234, 290, 330, 310, 1000]
            },
            {
                name:'charging',
                type:'line',
                stack: '总量',
                areaStyle: {},
                data : new Array(),
                // data:[150, 232, 201, 154, 190, 330, 410, 1000]
            },
            // {
            //     name:'离线',
            //     type:'line',
            //     stack: '总量',
            //     areaStyle: {normal: {}},
            //     data:[320, 332, 301, 334, 390, 330, 320]
            // },
            // {
            //     name:'待维修',
            //     type:'line',
            //     stack: '总量',
            //     label: {
            //         normal: {
            //             show: true,
            //             position: 'top'
            //         }
            //     },
            //     areaStyle: {normal: {}},
            //     data:[820, 932, 901, 934, 1290, 1330, 1320]
            // }
        ]
    };
    ;

    // initialStack();
    if (optionStack && typeof optionStack === "object") {
        myChartStack.setOption(optionStack, true);
    }

// 层叠图 结束


    window.onresize = function () {
        myChartPie.resize();
        myChartStack.resize();
        myChartGuage.resize();
        myChartLine.resize();
    }


// <!-- 绘制地图 -->

    // 绘制轨迹折线图
    function drawLine(prePoint, nxtPoint){
        var sym = new BMap.Symbol
        (
            BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, //百度预定义的 箭头方向向下的非闭合箭头
            {
                fillColor : '#0F0', //设置矢量图标的填充颜色。支持颜色常量字符串、十六进制、RGB、RGBA等格式
                fillOpacity : 1, //设置矢量图标填充透明度,范围0~1
                scale : 0.5, //设置矢量图标的缩放比例
                // rotation : 90, //设置矢量图标的旋转角度,参数为角度
                strokeColor : '#FFF', //设置矢量图标的线填充颜色,支持颜色常量字符串、十六进制、RGB、RGBA等格式
                strokeOpacity : 1, //设置矢量图标线的透明度,opacity范围0~1
                strokeWeight : 2, //旋设置线宽。如果此属性没有指定，则线宽跟scale数值相
            }
        );

        var iconSequence = new BMap.IconSequence
        (
            sym, //symbol为符号样式
            '0%', //offset为符号相对于线起点的位置，取值可以是百分比也可以是像素位置，默认为"100%"
            '40%', //repeat为符号在线上重复显示的距离，可以是百分比也可以是距离值，同时设置repeat与offset时，以repeat为准
            false //fixedRotation设置图标的旋转角度是否与线走向一致，默认为true
        );
        var polyline = new BMap.Polyline(
            [
                new BMap.Point(prePoint['longitude'], prePoint['latitude']),
                new BMap.Point(nxtPoint['longitude'], nxtPoint['latitude'])
            ],
            {
                icons : [iconSequence], //图标集合  **也是我之前没有实现样式改变的最大原因**
                strokeColor : '#0F0', //折线颜色 尽量与图标填充色保持一样
                strokeOpacity : 1, //折线的透明度，取值范围0 - 1
                strokeWeight : 5, //折线的宽度，以像素为单位
            }
        );
        map.addOverlay(polyline);
    }

    // 绘制点（根据车辆状态选择图片颜色），并加入回调
    function drawMapPoint(data, type){
        // var myIcon = new BMap.Icon("./img/icon-green-small.gif", new BMap.Size(25, 25));
        for(var i = 0; i < data.length; ++i){
            
            var marker = new BMap.Marker(new BMap.Point(data[i][1], data[i][2]));
            marker.setIcon(iconArr[type]);
            var content = data[i][0];
            map.addOverlay(marker)
            if(needAnimation[type]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
            addMouseHandler(content, marker);
        }
        needAnimation[type] = false;
    }

    function addMouseHandler(content,marker){
        marker.addEventListener("mouseover",function(e){
            this.getPosition();
            needUpdateMap = false;
            openInfo(content, e);
        });
        marker.addEventListener("mouseout",function(e){
            needUpdateMap = true;
        });
        marker.addEventListener("click",function(){ //必须要在外面套一个匿名函数，不然会直接执行，不知道为什么
            onClickOverlay(content);
        });
    }

    function openInfo(content, e){
        var p=e.target;
        
        var opts = {
            // width : 50px,     // 信息窗口宽度
            // height: '10%',     // 信息窗口高度
            title : '车辆编号'  // 信息窗口标题
        }

        var point=new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content, opts);
        map.openInfoWindow(infoWindow, point);
    }

    // // var data_info = [[121.447176,31.033731],[135.447176,35.033731],[115.447176,35.033731]];
    // var data_info = [[121.447176,31.033780,"car1"],[121.445009,31.030880,"car2"],[121.444695,31.027980,"car2"]];
    // function eConsole(param) {
    // 　　//param.dataIndex 获取当前点击索引，
    // // 　　alert(param.dataIndex);
    //     map.clearOverlays();
    // 　　clickFunc(param.dataIndex);//执行点击效果
    // }
    // myChartPie.on("click", eConsole);
    
    // function addMouseHandler(content,marker, num){
    //     marker.addEventListener("mouseover",function(e){
            
    //         this.getPosition();
    //         openInfo(content, e);
    //         // alert(num);
    //     });
    //     marker.addEventListener("click",function(){ //必须要在外面套一个匿名函数，不然会直接执行，不知道为什么
    //         onClickOverlay(num);
    //     });
    // }

    // function openInfo(content, e){
    //     // alert("mouse on");
    //     var p=e.target;
        
    //     var opts = {
    //         // width : 50px,     // 信息窗口宽度
    //         // height: '10%',     // 信息窗口高度
    //         title : '车辆编号'  // 信息窗口标题
    //     }

        
    //     var point=new BMap.Point(p.getPosition().lng, p.getPosition().lat);
    //     var infoWindow = new BMap.InfoWindow(content, opts);
    //     map.openInfoWindow(infoWindow, point);
    //     // alert(content);
    // }

    // function clickFunc(carType){
    //     // alert(data_info.length);
    //     var myIcon = new BMap.Icon("./img/icon-green-small.gif", new BMap.Size(25, 25));
    //     for(var i = 0; i < data_info.length; ++i){
            
    //         var marker = new BMap.Marker(new BMap.Point(data_info[i][0], data_info[i][1]));
    //         marker.setIcon(myIcon);
    //         var content = data_info[i][2];
    //         map.addOverlay(marker)
    //         addMouseHandler(content, marker, i);
    //     }
    // }
 


    // <!-- 网页启动 -->
    initialStack();
    myChartPie.on("click", eConsole);
    backToBackground();
    setInterval(function(){requestCurrentTypeNum()}, 919);
    setInterval(function(){
        if(!needUpdateMap || mapLocked) return;
        if(!curSingleMode){
            map.clearOverlays();
            backgroundRequest();
        }else{

            requestSingleCarHistory();
            requestSingleCar();
        }
    }, 977);
</script>
          