<!DOCTYPE html>
<html lang="en" style="height: 100%">
    <head>
            <meta http-equiv="Access-Control-Allow-Origin" content="*" />

        <!-- <meta http-equiv="refresh" content="10"> -->
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-gl/dist/echarts-gl.min.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-stat/dist/ecStat.min.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/dataTool.min.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/map/js/china.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js"></script>
       <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/bmap.min.js"></script>
       <!-- <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=2GCVEjjkYGGiVjTR1EoENtf2SNzYaiRI"></script> -->
       <script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=stCj3XtKtn4BKeUDSV512dwfCEDBkh6Y"></script>

       <!--加载鼠标绘制工具-->
        <script type="text/javascript" src="//api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
        <link rel="stylesheet" href="//api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />

        <!-- 几何工具 -->
        <script type="text/javascript" src="http://api.map.baidu.com/library/GeoUtils/1.2/src/GeoUtils_min.js"></script>

       
       <!-- <script src="theme/dark.js"></script> -->
       <!-- button -->
       <!-- <link rel="shortcut icon" href="../favicon.ico"> 
       <link rel="stylesheet" type="text/css" href="css/default.css" />
       <link rel="stylesheet" type="text/css" href="css/component.css" />
       <script src="js/modernizr.custom.js"></script> -->

       <!-- Stylesheet -->
        <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous"> -->
        
        <!-- jQuery & Bootstrap -->
        <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script> -->

        <!-- Latest compiled and minified CSS -->
        <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.12/dist/css/bootstrap-select.min.css"> -->

        <!-- Latest compiled and minified JavaScript -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.12/dist/js/bootstrap-select.min.js"></script> -->

        <!-- (Optional) Latest compiled and minified JavaScript translation files -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.12/dist/js/i18n/defaults-*.min.js"></script> -->

        <!-- semantic-ui -->
        <link href="semantic.min.css" rel="stylesheet" type="text/css">
        <!-- <link href="icon.min.css" rel="stylesheet" type="text/css"> -->

        <!-- <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script> -->
        <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="semantic.min.js"></script>

        <link href="https://cdn.bootcss.com/semantic-ui/2.4.1/components/icon.css" rel="stylesheet">

        <script type="text/javascript" src="vin_license.js"></script>

        <!-- <script src="package.js"></script> -->



       <style type="text/css">
            div#mapDiv {
                /* background-color:green; */
                height:75%;
                width:75%;
                float:left;
            }
            div#optionList {
                /* background-color:gray; */
                height:75%;
                width:25%;
                float:left;
            }
            div#chart {
                /* background-color:blue; */
                width:100%;
                height:25%;
                float: left; 
            }
            .threed{
                color: #2d52ca;
                letter-spacing: 0;
                text-shadow: 0px 1px 0px #999, 0px 2px 0px #888, 0px 3px 0px #777, 0px 4px 0px #666, 0px 5px 0px #555, 0px 6px 0px #444, 0px 7px 0px #333, 0px 8px 7px #001135 
            }
        </style>

        
    </head>

    <body>
    <div id="mySidebar" class="ui right inverted vertical menu sidebar">
        <a class="item" href="javascript:void(0);" onclick="window.location.reload();">
            刷新
        </a>
        <a class="item" href="javascript:void(0);" onclick="reactivate()">
            重新激活
        </a>
        <a class="item" href="javascript:void(0);" onclick="logout()">
            退出登录
        </a>
        <a class="item" href="http://202.120.60.31:3000/heatmap">
            热力图模式
        </a>
        <a class="item" href="http://202.120.60.31:4000">
            车辆大数据分析平台
        </a>
        <script>
            function reactivate(){
                pageStale = false;
            }
            function logout(){
                location.href='http://202.120.60.31:3000';
            }
        </script>
    </div>
    <div class="pusher" style="height: 100%; margin: 0" >
        <!-- <div id="Echarts"></div> -->

        <div id="mapDiv"></div>
        
        <div id="optionList">
            <div style="height:10%">
                <img width="100%" src="img/fog.jpg" onclick="$('.ui.sidebar').sidebar({
                    transition:'scale down' //默认uncover，可以取值push\overlay\slide along\slide out\scale down
                }).sidebar('toggle');">
                <!-- <h3 class="threed">自动驾驶电动汽车大数据云雾融合平台</h3> -->
            </div>
            <div style="height:90%">
                <div id="detailOption" style="height: 20%; width: 100%; float: left; ">
                    <!-- 查询类型选择 -->
                    <select name="reques_type" class="ui compact dropdown" id="select">
                        <optgroup label="车辆状态">
                            <option value="velocity" selected>速度</option>
                            <option value="cumulative_mileage">总行驶里程</option>
                            <option value="drive_motor_rpm">电机转速</option>
                            <option value="drive_motor_temperature">电机温度</option>
                        </optgroup>
                        <optgroup label="电池信息">
                            <option value="residual_energy">剩余电量</option>
                            <option value="high_voltage_battery_current">总电流</option>
                            <option value="total_battery_voltage">总电压</option>
                            <option value="max_single_voltage">电池最高单体电压</option>
                            <option value="min_single_voltage">电池最低单体电压</option>
                            <option value="insulation_resistance_value">绝缘阻值</option>
                        </optgroup>
                        <optgroup label="其他数据">
                            <option value="motor_torque">电机转矩</option>
                            <option value="motor_controller_current">电机控制器电流</option>
                            <option value="motor_controller_voltage">电机控制器电压</option>
                        </optgroup>
                    </select>
                    <!-- vin选择 -->
                    <select class="ui compact search selection dropdown" id="search-select" onchange="vinChange()"> 
                        <option value="LK6ADCE22JB007910">LK6ADCE22JB007910</option>
                        <option value="LK6ADCE22JB011083">LK6ADCE22JB011083</option>
                        <option value="LK6ADCE29JB011100">LK6ADCE29JB011100</option>
                        <option value="LK6ADCE20JB011051">LK6ADCE20JB011051</option>
                        <option value="LK6ADCE23JB008886">LK6ADCE23JB008886</option>
                        <option value="LK6ADCE27JB011113">LK6ADCE27JB011113</option>
                        <option value="LK6ADCE25JB011093">LK6ADCE25JB011093</option>
                        <option value="LK6ADCE28JB008883">LK6ADCE28JB008883</option>
                        <option value="LK6ADCE28JB009631">LK6ADCE28JB009631</option>
                        <option value="LK6ADCE26JB010499">LK6ADCE26JB010499</option>
                        <option value="LK6ADCE28JB010486">LK6ADCE28JB010486</option>
                        <option value="LK6ADCE20JB010482">LK6ADCE20JB010482</option>
                        <option value="LK6ADCE29JB010481">LK6ADCE29JB010481</option>
                        <option value="LK6ADCE29JB009637">LK6ADCE29JB009637</option>
                        <option value="LK6ADCE25JB009635">LK6ADCE25JB009635</option>
                        <option value="LK6ADCE24JB011117">LK6ADCE24JB011117</option>
                        <option value="LK6ADCE21JB009633">LK6ADCE21JB009633</option>
                        <option value="LK6ADCE23JB009651">LK6ADCE23JB009651</option>
                        <option value="LK6ADCE25JB011076">LK6ADCE25JB011076</option>
                        <option value="LK6ADCE28JB011105">LK6ADCE28JB011105</option>
                        <option value="LK6ADCE27JB011094">LK6ADCE27JB011094</option>
                        <option value="LK6ADCE24JB011134">LK6ADCE24JB011134</option>
                        <option value="LK6ADCE20JB011129">LK6ADCE20JB011129</option>
                        <option value="LK6ADCE2XJB011123">LK6ADCE2XJB011123</option>
                        <option value="LK6ADCE26JB011099">LK6ADCE26JB011099</option>
                        <option value="LK6ADCE21JB011057">LK6ADCE21JB011057</option>
                        <option value="LK6ADCE25JB011112">LK6ADCE25JB011112</option>
                        <option value="LK6ADCE29JB011095">LK6ADCE29JB011095</option>
                        <option value="LK6ADCE21JB011091">LK6ADCE21JB011091</option>
                        <option value="LK6ADCE28JB009659">LK6ADCE28JB009659</option>
                        <option value="LK6ADCE24JB009691">LK6ADCE24JB009691</option>
                        <option value="LK6ADCE29JB010500">LK6ADCE29JB010500</option>
                        <option value="LK6ADCE29JB008312">LK6ADCE29JB008312</option>
                        <option value="LK6ADCE25JB010526">LK6ADCE25JB010526</option>
                        <option value="LK6ADCE29JB010514">LK6ADCE29JB010514</option>
                        <option value="LK6ADCE28JB009676">LK6ADCE28JB009676</option>
                        <option value="LK6ADCE28JB010522">LK6ADCE28JB010522</option>
                        <option value="LK6ADCE22JB009642">LK6ADCE22JB009642</option>
                        <option value="LK6ADCE21JB009664">LK6ADCE21JB009664</option>
                        <option value="LK6ADCE21JB010510">LK6ADCE21JB010510</option>
                        <option value="LK6ADCE27HB005533">LK6ADCE27HB005533</option>
                        <option value="LK6ADCE26HB005460">LK6ADCE26HB005460</option>
                        <option value="LK6ADCE2XHB005154">LK6ADCE2XHB005154</option>
                        <option value="LK6ADCE28HB005184">LK6ADCE28HB005184</option>
                        <option value="LK6ADCE23HB005383">LK6ADCE23HB005383</option>
                        <option value="LK6ADCE22HB005388">LK6ADCE22HB005388</option>
                        <option value="LK6ADCE20HB005390">LK6ADCE20HB005390</option>
                        <option value="LK6ADCE28HB006531">LK6ADCE28HB006531</option>
                        <option value="LK6ADCE2XHB006546">LK6ADCE2XHB006546</option>
                        <option value="LK6ADCE28HB006464">LK6ADCE28HB006464</option>
                        <option value="LK6ADCE22HB005701">LK6ADCE22HB005701</option>
                        <option value="LK6ADCE27HB006407">LK6ADCE27HB006407</option>
                        <option value="LK6ADCE23HB005402">LK6ADCE23HB005402</option>
                        <option value="LK6ADCE28HB005640">LK6ADCE28HB005640</option>
                        <option value="LK6ADCE28HB006836">LK6ADCE28HB006836</option>
                        <option value="LK6ADCE23HB005738">LK6ADCE23HB005738</option>
                        <option value="LK6ADCE21HB005026">LK6ADCE21HB005026</option>
                        <option value="LK6ADCE21HB005012">LK6ADCE21HB005012</option>
                        <option value="LK6ADCE28HB005282">LK6ADCE28HB005282</option>
                        <option value="LK6ADCE22HB005522">LK6ADCE22HB005522</option>
                        <option value="LK6ADCE2XHB005185">LK6ADCE2XHB005185</option>
                        <option value="LK6ADCE20HB005339">LK6ADCE20HB005339</option>
                        <option value="LK6ADCE26HB006284">LK6ADCE26HB006284</option>
                        <option value="LK6ADCE21HB005981">LK6ADCE21HB005981</option>
                        <option value="LK6ADCE27HB006116">LK6ADCE27HB006116</option>
                        <option value="LK6ADCE27HB005063">LK6ADCE27HB005063</option>
                        <option value="LK6ADCE25HB005109">LK6ADCE25HB005109</option>
                        <option value="LK6ADCE20HB005082" selected=true>LK6ADCE20HB005082</option>
                        <option value="LK6ADCE27HB006553">LK6ADCE27HB006553</option>
                        <option value="LK6ADCE22HB005102">LK6ADCE22HB005102</option>
                        <option value="LK6ADCE27HB006861">LK6ADCE27HB006861</option>
                        <option value="LK6ADCE20JB007842">LK6ADCE20JB007842</option>
                        <option value="LK6ADCE27JB007885">LK6ADCE27JB007885</option>
                        <option value="LK6ADCE25JB007934">LK6ADCE25JB007934</option>
                        <option value="LK6ADCE21JB007929">LK6ADCE21JB007929</option>
                        <option value="LK6ADCE23JB008290">LK6ADCE23JB008290</option>
                        <option value="LK6ADCE2XJB007931">LK6ADCE2XJB007931</option>
                        <option value="LK6ADCE20JB008294">LK6ADCE20JB008294</option>
                        <option value="LK6ADCE2XJB008285">LK6ADCE2XJB008285</option>
                        <option value="LK6ADCE29JB008293">LK6ADCE29JB008293</option>
                        <option value="LK6ADCE29JB007905">LK6ADCE29JB007905</option>
                        <option value="LK6ADCE21JB008241">LK6ADCE21JB008241</option>
                        <option value="LK6ADCE20JB007890">LK6ADCE20JB007890</option>
                        <option value="LK6ADCE24JB008251">LK6ADCE24JB008251</option>
                        <option value="LK6ADCE22JB007891">LK6ADCE22JB007891</option>
                        <option value="LK6ADCE2XJB008299">LK6ADCE2XJB008299</option>
                        <option value="LK6ADCE2XJB011140">LK6ADCE2XJB011140</option>
                        <option value="LK6ADCE22JB008247">LK6ADCE22JB008247</option>
                        <option value="LK6ADCE28JB008253">LK6ADCE28JB008253</option>
                        <option value="LK6ADCE2XJB008268">LK6ADCE2XJB008268</option>
                        <option value="LK6ADCE25JB008873">LK6ADCE25JB008873</option>
                        <option value="LK6ADCE27JB008292">LK6ADCE27JB008292</option>
                        <option value="LK6ADCE28JB009273">LK6ADCE28JB009273</option>
                        <option value="LK6ADCE22JB008250">LK6ADCE22JB008250</option>
                        <option value="LK6ADCE23JB008239">LK6ADCE23JB008239</option>
                        <option value="LK6ADCE28JB011122">LK6ADCE28JB011122</option>
                        <option value="LK6ADCE29JB011114">LK6ADCE29JB011114</option>
                        <option value="LK6ADCE24JB008864">LK6ADCE24JB008864</option>
                        <option value="LK6ADCE23JB008872">LK6ADCE23JB008872</option>
                        <option value="LK6ADCE27JB008874">LK6ADCE27JB008874</option>
                        <option value="LK6ADCE21JB011110">LK6ADCE21JB011110</option>
                        <option value="LK6ADCE23JB011142">LK6ADCE23JB011142</option>
                        <option value="LK6ADCE26JB008879">LK6ADCE26JB008879</option>
                        <option value="LK6ADCE2XJB008884">LK6ADCE2XJB008884</option>
                        <option value="LK6ADCE24JB008878">LK6ADCE24JB008878</option>
                        <option value="LK6ADCE25JB011059">LK6ADCE25JB011059</option>
                        <option value="LK6ADCE24JB011098">LK6ADCE24JB011098</option>
                        <option value="LK6ADCE24JB011084">LK6ADCE24JB011084</option>
                        <option value="LK6ADCE22JB011116">LK6ADCE22JB011116</option>
                        <option value="LK6ADCE2XJB009694">LK6ADCE2XJB009694</option>
                        <option value="LK6ADCE25JB008887">LK6ADCE25JB008887</option>
                        <option value="LK6ADCE23JB009634">LK6ADCE23JB009634</option>
                        <option value="LK6ADCE27JB009636">LK6ADCE27JB009636</option>
                        <option value="LK6ADCE22JB009639">LK6ADCE22JB009639</option>
                        <option value="LK6ADCE21JB010538">LK6ADCE21JB010538</option>
                        <option value="LK6ADCE22JB009091">LK6ADCE22JB009091</option>
                        <option value="LK6ADCE22JB009057">LK6ADCE22JB009057</option>
                        <option value="LK6ADCE27JB009085">LK6ADCE27JB009085</option>
                        <option value="LK6ADCE24JB009061">LK6ADCE24JB009061</option>
                        <option value="LK6ADCE23JB009083">LK6ADCE23JB009083</option>
                        <option value="LK6ADCE23JB009102">LK6ADCE23JB009102</option>
                        <option value="LK6ADCE21JB009065">LK6ADCE21JB009065</option>
                        <option value="LK6ADCE29JB009086">LK6ADCE29JB009086</option>
                        <option value="LK6ADCE26JB009059">LK6ADCE26JB009059</option>
                        <option value="LK6ADCE24JB008993">LK6ADCE24JB008993</option>
                        <option value="LK6ADCE25JB009053">LK6ADCE25JB009053</option>
                        <option value="LK6ADCE22JB008975">LK6ADCE22JB008975</option>
                        <option value="LK6ADCE2XJB009114">LK6ADCE2XJB009114</option>
                        <option value="LK6ADCE28JB009113">LK6ADCE28JB009113</option>
                        <option value="LK6ADCE21JB009082">LK6ADCE21JB009082</option>
                        <option value="LK6ADCE29HB005176">LK6ADCE29HB005176</option>
                        <option value="LK6ADCE21HB006452">LK6ADCE21HB006452</option>
                        <option value="LK6ADCE21HB005723">LK6ADCE21HB005723</option>
                        <option value="LK6ADCE24HB006171">LK6ADCE24HB006171</option>
                        <option value="LK6ADCE28HB006027">LK6ADCE28HB006027</option>
                        <option value="LK6ADCE2XHB006207">LK6ADCE2XHB006207</option>
                        <option value="LK6ADCE23HB006789">LK6ADCE23HB006789</option>
                        <option value="LK6ADCE24HB005828">LK6ADCE24HB005828</option>
                        <option value="LK6ADCE21HB005446">LK6ADCE21HB005446</option>
                        <option value="LK6ADCE24HB005425">LK6ADCE24HB005425</option>
                        <option value="LK6ADCE23HB005447">LK6ADCE23HB005447</option>
                        <option value="LK6ADCE20HB006040">LK6ADCE20HB006040</option>
                        <option value="LK6ADCE2XHB005526">LK6ADCE2XHB005526</option>
                        <option value="LK6ADCE26HB005216">LK6ADCE26HB005216</option>
                        <option value="LK6ADCE27HB006536">LK6ADCE27HB006536</option>
                        <option value="LK6ADCE25HB005384">LK6ADCE25HB005384</option>
                        <option value="LK6ADCE25HB005370">LK6ADCE25HB005370</option>
                        <option value="LK6ADCE25HB005322">LK6ADCE25HB005322</option>
                        <option value="LK6ADCE20HB005003">LK6ADCE20HB005003</option>
                        <option value="LK6ADCE24HB006381">LK6ADCE24HB006381</option>
                        <option value="LK6ADCE26HB005703">LK6ADCE26HB005703</option>
                        <option value="LK6ADCE2XHB006790">LK6ADCE2XHB006790</option>
                        <option value="LK6ADCE22HB006296">LK6ADCE22HB006296</option>
                        <option value="LK6ADCE28HB005010">LK6ADCE28HB005010</option>
                        <option value="LK6ADCE25HB005983">LK6ADCE25HB005983</option>
                        <option value="LK6ADCE21HB005995">LK6ADCE21HB005995</option>
                        <option value="LK6ADCE25HB005434">LK6ADCE25HB005434</option>
                        <option value="LK6ADCE21HB006564">LK6ADCE21HB006564</option>
                        <option value="LK6ADCE22HB005407">LK6ADCE22HB005407</option>
                        <option value="LK6ADCE20HB005700">LK6ADCE20HB005700</option>
                        <option value="LK6ADCE24HB005697">LK6ADCE24HB005697</option>
                        <option value="LK6ADCE21HB006547">LK6ADCE21HB006547</option>
                        <option value="LK6ADCE21HB005396">LK6ADCE21HB005396</option>
                        <option value="LK6ADCE26HB005393">LK6ADCE26HB005393</option>
                        <option value="LK6ADCE23HB006565">LK6ADCE23HB006565</option>
                        <option value="LK6ADCE24HB005103">LK6ADCE24HB005103</option>
                        <option value="LK6ADCE20HB005678">LK6ADCE20HB005678</option>
                        <option value="LK6ADCE26HB006852">LK6ADCE26HB006852</option>
                        <option value="LK6ADCE22HB005746">LK6ADCE22HB005746</option>
                        <option value="LK6ADCE24HB006557">LK6ADCE24HB006557</option>
                        <option value="LK6ADCE22HB005438">LK6ADCE22HB005438</option>
                        <option value="LK6ADCE24HB005733">LK6ADCE24HB005733</option>
                        <option value="LK6ADCE20HB005809">LK6ADCE20HB005809</option>
                        <option value="LK6ADCE23HB005805">LK6ADCE23HB005805</option>
                        <option value="LK6ADCE2XJB007928">LK6ADCE2XJB007928</option>
                        <option value="LK6ADCE22JB007910">LK6ADCE22JB007910</option>
                        <option value="LK6ADCE23JB008287">LK6ADCE23JB008287</option>
                        <option value="LK6ADCE20JB009252">LK6ADCE20JB009252</option>
                        <option value="LK6ADCE22JB008331">LK6ADCE22JB008331</option>
                        <option value="LK6ADCE22HB006203">LK6ADCE22HB006203</option>
                        <option value="LK6ADCE28HB005413">LK6ADCE28HB005413</option>
                        <option value="LK6ADCE26HB006804">LK6ADCE26HB006804</option>
                        <option value="LK6ADCE2XHB005400">LK6ADCE2XHB005400</option>
                        <option value="LK6ADCE26HB005085">LK6ADCE26HB005085</option>
                        <option value="LK6ADCE20JB007839">LK6ADCE20JB007839</option>
                        <option value="LK6ADCE26JB007893">LK6ADCE26JB007893</option>
                        <option value="LK6ADCE2XJB007895">LK6ADCE2XJB007895</option>
                        <option value="LK6ADCE26JB007943">LK6ADCE26JB007943</option>
                        <option value="LK6ADCE29JB009265">LK6ADCE29JB009265</option>
                        <option value="LK6ADCE25JB008291">LK6ADCE25JB008291</option>
                        <option value="LK6ADCE29JB007922">LK6ADCE29JB007922</option>
                        <option value="LK6ADCE26JB008252">LK6ADCE26JB008252</option>
                        <option value="LK6ADCE26JB008249">LK6ADCE26JB008249</option>
                        <option value="LK6ADCE21JB008286">LK6ADCE21JB008286</option>
                        <option value="LK6ADCE20JB008246">LK6ADCE20JB008246</option>
                        <option value="LK6ADCE27JB011144">LK6ADCE27JB011144</option>
                        <option value="LK6ADCE29JB011047">LK6ADCE29JB011047</option>
                        <option value="LK6ADCE25JB011062">LK6ADCE25JB011062</option>
                        <option value="LK6ADCE27JB010480">LK6ADCE27JB010480</option>
                        <option value="LK6ADCE26JB008994">LK6ADCE26JB008994</option>
                        <option value="LK6ADCE21JB009079">LK6ADCE21JB009079</option>
                        <option value="LK6ADCE21JB009051">LK6ADCE21JB009051</option>
                        <option value="LK6ADCE25JB009067">LK6ADCE25JB009067</option>
                        <option value="LK6ADCE28JB009077">LK6ADCE28JB009077</option>
                        <option value="LK6ADCE25JB009098">LK6ADCE25JB009098</option>
                        <option value="LK6ADCE21JB009096">LK6ADCE21JB009096</option>
                        <option value="LK6ADCE23HB005481">LK6ADCE23HB005481</option>
                        <option value="LK6ADCE26HB005488">LK6ADCE26HB005488</option>
                        <option value="LK6ADCE25HB005207">LK6ADCE25HB005207</option>
                        <option value="LK6ADCE26HB005409">LK6ADCE26HB005409</option>
                        <option value="LK6ADCE20HB006247">LK6ADCE20HB006247</option>
                        <option value="LK6ADCE24HB006512">LK6ADCE24HB006512</option>
                        <option value="LK6ADCE22HB006556">LK6ADCE22HB006556</option>
                        <option value="LK6ADCE25HB005529">LK6ADCE25HB005529</option>
                        <option value="LK6ADCE21HB006810">LK6ADCE21HB006810</option>
                        <option value="LK6ADCE26HB006401">LK6ADCE26HB006401</option>
                        <option value="LK6ADCE21HB005401">LK6ADCE21HB005401</option>
                        <option value="LK6ADCE21HB006063">LK6ADCE21HB006063</option>
                        <option value="LK6ADCE28HB005072">LK6ADCE28HB005072</option>
                        <option value="LK6ADCE23JB007933">LK6ADCE23JB007933</option>
                        <option value="LK6ADCE2XJB009081">LK6ADCE2XJB009081</option>
                        <option value="LK6ADCE20JB008330">LK6ADCE20JB008330</option>
                        <option value="LK6ADCE21HB005155">LK6ADCE21HB005155</option>
                        <option value="LK6ADCE21HB005527">LK6ADCE21HB005527</option>
                        <option value="LK6ADCE24HB005957">LK6ADCE24HB005957</option>
                        <option value="LK6ADCE23HB005433">LK6ADCE23HB005433</option>
                        <option value="LK6ADCE25JB007853">LK6ADCE25JB007853</option>
                        <option value="LK6ADCE26JB007845">LK6ADCE26JB007845</option>
                        <option value="LK6ADCE28JB008298">LK6ADCE28JB008298</option>
                        <option value="LK6ADCE29JB009640">LK6ADCE29JB009640</option>
                        <option value="LK6ADCE25JB008288">LK6ADCE25JB008288</option>
                        <option value="LK6ADCE22JB008295">LK6ADCE22JB008295</option>
                        <option value="LK6ADCE24JB008248">LK6ADCE24JB008248</option>
                        <option value="LK6ADCE21JB008868">LK6ADCE21JB008868</option>
                        <option value="LK6ADCE26JB008283">LK6ADCE26JB008283</option>
                        <option value="LK6ADCE21JB008269">LK6ADCE21JB008269</option>
                        <option value="LK6ADCE2XJB011137">LK6ADCE2XJB011137</option>
                        <option value="LK6ADCE27JB009264">LK6ADCE27JB009264</option>
                        <option value="LK6ADCE25JB008310">LK6ADCE25JB008310</option>
                        <option value="LK6ADCE26HB006558">LK6ADCE26HB006558</option>
                        <option value="LK6ADCE23HB005724">LK6ADCE23HB005724</option>
                        <option value="LK6ADCE23JB008855">LK6ADCE23JB008855</option>
                        <option value="LK6ADCE2XJB010487">LK6ADCE2XJB010487</option>
                        <option value="LK6ADCE21JB010555">LK6ADCE21JB010555</option>
                        <option value="LK6ADCE27JB007840">LK6ADCE27JB007840</option>
                        <option value="LK6ADCE24JB007889">LK6ADCE24JB007889</option>
                        <option value="LK6ADCE28JB008849">LK6ADCE28JB008849</option>
                        <option value="LK6ADCE20JB008862">LK6ADCE20JB008862</option>
                        <option value="LK6ADCE26JB008882">LK6ADCE26JB008882</option>
                        <option value="LK6ADCE2XJB009243">LK6ADCE2XJB009243</option>                 
                    </select>
                    <!-- 车牌号选择 -->
                    <select class="ui compact search selection dropdown" id="search-select-license" onchange="licenseChange()"> 
                        <option value="AD91750">AD91750</option>
                        <option value="AD75237">AD75237</option>
                        <option value="AD76517">AD76517</option>
                        <option value="AD77836">AD77836</option>
                        <option value="AD04438">AD04438</option>
                        <option value="AD92696">AD92696</option>
                        <option value="AD70137">AD70137</option>
                        <option value="AD95901">AD95901</option>
                        <option value="AD75081">AD75081</option>
                        <option value="AD81932">AD81932</option>
                        <option value="AD96310">AD96310</option>
                        <option value="AD73619">AD73619</option>
                        <option value="AD03642">AD03642</option>
                        <option value="AD91567">AD91567</option>
                        <option value="AD71067">AD71067</option>
                        <option value="AD04315">AD04315</option>
                        <option value="AD86308">AD86308</option>
                        <option value="AD89121">AD89121</option>
                        <option value="AD66459">AD66459</option>
                        <option value="AD71026">AD71026</option>
                        <option value="AD75207">AD75207</option>
                        <option value="AD99563">AD99563</option>
                        <option value="AD04827">AD04827</option>
                        <option value="AD99329">AD99329</option>
                        <option value="AD70167">AD70167</option>
                        <option value="AD79902">AD79902</option>
                        <option value="AD01342">AD01342</option>
                        <option value="AD82865">AD82865</option>
                        <option value="AD86306">AD86306</option>
                        <option value="AD61496">AD61496</option>
                        <option value="AD90638">AD90638</option>
                        <option value="AD70872">AD70872</option>
                        <option value="AD04659">AD04659</option>
                        <option value="AD00804">AD00804</option>
                        <option value="AD63471">AD63471</option>
                        <option value="AD86597">AD86597</option>
                        <option value="AD97236">AD97236</option>
                        <option value="AD85260">AD85260</option>
                        <option value="AD09745">AD09745</option>
                        <option value="AD03476">AD03476</option>
                        <option value="AD90172">AD90172</option>
                        <option value="AD90178">AD90178</option>
                        <option value="AD68492">AD68492</option>
                        <option value="AD92923">AD92923</option>
                        <option value="AD92260">AD92260</option>
                        <option value="AD86006">AD86006</option>
                        <option value="AD77152">AD77152</option>
                        <option value="AD79992">AD79992</option>
                        <option value="AD93339">AD93339</option>
                        <option value="AD78160">AD78160</option>
                        <option value="AD78170">AD78170</option>
                        <option value="AD90555">AD90555</option>
                        <option value="AD93390">AD93390</option>
                        <option value="AD97966">AD97966</option>
                        <option value="AD92920">AD92920</option>
                        <option value="AD86088">AD86088</option>
                        <option value="AD86033">AD86033</option>
                        <option value="AD99168">AD99168</option>
                        <option value="AD95911">AD95911</option>
                        <option value="AD92377">AD92377</option>
                        <option value="AD90566">AD90566</option>
                        <option value="AD99106">AD99106</option>
                        <option value="AD90787">AD90787</option>
                        <option value="AD97918">AD97918</option>
                        <option value="AD95900">AD95900</option>
                        <option value="AD71028">AD71028</option>
                        <option value="AD90162">AD90162</option>
                        <option value="AD96275">AD96275</option>
                        <option value="AD90108">AD90108</option>
                        <option value="AD78586">AD78586</option>
                        <option value="AD85119">AD85119</option>
                        <option value="AD89912">AD89912</option>
                        <option value="AD72172">AD72172</option>
                        <option value="AD68942">AD68942</option>
                        <option value="AD90751">AD90751</option>
                        <option value="AD65948">AD65948</option>
                        <option value="AD86762">AD86762</option>
                        <option value="AD73577">AD73577</option>
                        <option value="AD88763">AD88763</option>
                        <option value="AD95732">AD95732</option>
                        <option value="AD86712">AD86712</option>
                        <option value="AD92950">AD92950</option>
                        <option value="AD91037">AD91037</option>
                        <option value="AD77535">AD77535</option>
                        <option value="AD68784">AD68784</option>
                        <option value="AD79863">AD79863</option>
                        <option value="AD76590">AD76590</option>
                        <option value="AD76970">AD76970</option>
                        <option value="AD64252">AD64252</option>
                        <option value="AD81270">AD81270</option>
                        <option value="AD79323">AD79323</option>
                        <option value="AD04645">AD04645</option>
                        <option value="AD70903">AD70903</option>
                        <option value="AD89721">AD89721</option>
                        <option value="AD72961">AD72961</option>
                        <option value="AD00547">AD00547</option>
                        <option value="AD77195">AD77195</option>
                        <option value="AD96035">AD96035</option>
                        <option value="AD81969">AD81969</option>
                        <option value="AD86375">AD86375</option>
                        <option value="AD91138">AD91138</option>
                        <option value="AD79522">AD79522</option>
                        <option value="AD78132">AD78132</option>
                        <option value="AD89913">AD89913</option>
                        <option value="AD85368">AD85368</option>
                        <option value="AD04925">AD04925</option>
                        <option value="AD86039">AD86039</option>
                        <option value="AD78172">AD78172</option>
                        <option value="AD04749">AD04749</option>
                        <option value="AD70125">AD70125</option>
                        <option value="AD92330">AD92330</option>
                        <option value="AD77823">AD77823</option>
                        <option value="AD97089">AD97089</option>
                        <option value="AD76587">AD76587</option>
                        <option value="AD90726">AD90726</option>
                        <option value="AD67145">AD67145</option>
                        <option value="AD80385">AD80385</option>
                        <option value="AD89751">AD89751</option>
                        <option value="AD70715">AD70715</option>
                        <option value="AD95130">AD95130</option>
                        <option value="AD95903">AD95903</option>
                        <option value="AD93116">AD93116</option>
                        <option value="AD76593">AD76593</option>
                        <option value="AD70736">AD70736</option>
                        <option value="AD72117">AD72117</option>
                        <option value="AD02646">AD02646</option>
                        <option value="AD72207">AD72207</option>
                        <option value="AD95727">AD95727</option>
                        <option value="AD04588">AD04588</option>
                        <option value="AD90311">AD90311</option>
                        <option value="AD78581">AD78581</option>
                        <option value="AD92379">AD92379</option>
                        <option value="AD99158">AD99158</option>
                        <option value="AD97982">AD97982</option>
                        <option value="AD77101">AD77101</option>
                        <option value="AD76267">AD76267</option>
                        <option value="AD97908">AD97908</option>
                        <option value="AD98812">AD98812</option>
                        <option value="AD95768">AD95768</option>
                        <option value="AD95260">AD95260</option>
                        <option value="AD86056">AD86056</option>
                        <option value="AD98877">AD98877</option>
                        <option value="AD72013">AD72013</option>
                        <option value="AD81066">AD81066</option>
                        <option value="AD97956">AD97956</option>
                        <option value="AD92280">AD92280</option>
                        <option value="AD98892">AD98892</option>
                        <option value="AD95986">AD95986</option>
                        <option value="AD99119">AD99119</option>
                        <option value="AD92200">AD92200</option>
                        <option value="AD96295">AD96295</option>
                        <option value="AD99113">AD99113</option>
                        <option value="AD90163">AD90163</option>
                        <option value="AD77199">AD77199</option>
                        <option value="AD81068">AD81068</option>
                        <option value="AD99153">AD99153</option>
                        <option value="AD81028">AD81028</option>
                        <option value="AD90589">AD90589</option>
                        <option value="AD98871">AD98871</option>
                        <option value="AD72902">AD72902</option>
                        <option value="AD04340">AD04340</option>
                        <option value="AD99192">AD99192</option>
                        <option value="AD98876">AD98876</option>
                        <option value="AD78585">AD78585</option>
                        <option value="AD81002">AD81002</option>
                        <option value="AD95885">AD95885</option>
                        <option value="AD98826">AD98826</option>
                        <option value="AD99111">AD99111</option>
                        <option value="AD92287">AD92287</option>
                        <option value="AD92299">AD92299</option>
                        <option value="AD97998">AD97998</option>
                        <option value="AD81008">AD81008</option>
                        <option value="AD92292">AD92292</option>
                        <option value="AD95988">AD95988</option>
                        <option value="AD70975">AD70975</option>
                        <option value="AD91750">AD91750</option>
                        <option value="AD91356">AD91356</option>
                        <option value="AD82838">AD82838</option>
                        <option value="AD71382">AD71382</option>
                        <option value="AD79606">AD79606</option>
                        <option value="AD76233">AD76233</option>
                        <option value="AD77179">AD77179</option>
                        <option value="AD98882">AD98882</option>
                        <option value="AD79611">AD79611</option>
                        <option value="AD93671">AD93671</option>
                        <option value="AD96025">AD96025</option>
                        <option value="AD04083">AD04083</option>
                        <option value="AD08144">AD08144</option>
                        <option value="AD76173">AD76173</option>
                        <option value="AD64043">AD64043</option>
                        <option value="AD93557">AD93557</option>
                        <option value="AD77903">AD77903</option>
                        <option value="AD64392">AD64392</option>
                        <option value="AD04317">AD04317</option>
                        <option value="AD82836">AD82836</option>
                        <option value="AD82073">AD82073</option>
                        <option value="AD04476">AD04476</option>
                        <option value="AD81026">AD81026</option>
                        <option value="AD97127">AD97127</option>
                        <option value="AD85319">AD85319</option>
                        <option value="AD99302">AD99302</option>
                        <option value="AD95120">AD95120</option>
                        <option value="AD87565">AD87565</option>
                        <option value="AD65994">AD65994</option>
                        <option value="AD78390">AD78390</option>
                        <option value="AD76193">AD76193</option>
                        <option value="AD78100">AD78100</option>
                        <option value="AD79668">AD79668</option>
                        <option value="AD79966">AD79966</option>
                        <option value="AD81093">AD81093</option>
                        <option value="AD95777">AD95777</option>
                        <option value="AD96299">AD96299</option>
                        <option value="AD96222">AD96222</option>
                        <option value="AD78180">AD78180</option>
                        <option value="AD92966">AD92966</option>
                        <option value="AD71019">AD71019</option>
                        <option value="AD81022">AD81022</option>
                        <option value="AD93353">AD93353</option>
                        <option value="AD98890">AD98890</option>
                        <option value="AD95805">AD95805</option>
                        <option value="AD92196">AD92196</option>
                        <option value="AD79639">AD79639</option>
                        <option value="AD97909">AD97909</option>
                        <option value="AD76222">AD76222</option>
                        <option value="AD79866">AD79866</option>
                        <option value="AD97876">AD97876</option>
                        <option value="AD04685">AD04685</option>
                        <option value="AD89103">AD89103</option>
                        <option value="AD07804">AD07804</option>
                        <option value="AD98156">AD98156</option>
                        <option value="AD70963">AD70963</option>
                        <option value="AD79569">AD79569</option>
                        <option value="AD71303">AD71303</option>
                        <option value="AD75905">AD75905</option>
                        <option value="AD77860">AD77860</option>
                        <option value="AD87910">AD87910</option>
                        <option value="AD85392">AD85392</option>
                        <option value="AD76995">AD76995</option>
                        <option value="AD86726">AD86726</option>
                        <option value="AD92277">AD92277</option>
                        <option value="AD97968">AD97968</option>
                        <option value="AD79102">AD79102</option>
                        <option value="AD83739">AD83739</option>
                        <option value="AD64234">AD64234</option>
                        <option value="AD67931">AD67931</option>
                        <option value="AD70293">AD70293</option>
                        <option value="AD64654">AD64654</option>
                        <option value="AD68745">AD68745</option>
                        <option value="AD92653">AD92653</option>
                        <option value="AD79321">AD79321</option>
                    </select>
                    <script>
                        $('#select').dropdown();
                        $('#search-select').dropdown();
                        $('#search-select-license').dropdown();
                    </script>
                    <div class="ui animated button" onclick="onClickSearchButton()">
                        <div class="visible content">搜索</div>
                        <div class="hidden content"><i class="compass icon"></i></div>
                    </div>  
                    <div class="ui right labeled left icon input">
                        <i class="tags icon"></i>
                        <input type="text" placeholder="修改车辆备注">
                        <a class="ui tag label" onclick="addLabel()">
                          修改备注
                        </a>
                    </div>
                </div>
                <div id="detailLine" style="height: 35%; width: 100%; float: left;">
                    <div id="dynamicLine" style="height: 110%; width: 100%; float: left;"></div>
                </div>

                <div id="detailPanel" style="height: 45%; width: 100%; float: left;">
                    <div id="guage" style="height: 100%; width: 85%; float: left; padding-left: 10%;"></div>
                </div>
            </div>
            
        </div>
        <div id="chart">
            <div id="Pie" style="height: 100%; width: 25%; float: left;"></div>
            <!-- <div id="Gauge" style="height: 100%; width: 25%; float: left;"></div> -->
            <!-- <div id="Heatmap"" style="height: 100%; width: 50%; float: left;"></div> -->
            <div id="Stack" style="height: 100%; width: 50%; float: left;"></div>
            <div id="Board" style="height: 100%; width: 25%; float: left;">
                <div id="right_bottom_coner_default" style="height: 100%; width: 100%; padding-right: 10%; overflow: scroll;">
                    <!-- <p id="time1" style="margin-left: 5%; margin-top: 5%;">item1</p> -->
                    
                    <!-- <iframe id="fancybox-frame" name="fancybox-frame1573219207283" frameborder="0" scrolling="no" hspace="0"  src="http://i.tianqi.com/index.php?c=code&a=getcode&id=35&h=55&w=200&py=minhang"></iframe> -->
                    <!-- <div style="float: right" href="javascript:void(0);" onclick="$('.ui.sidebar').sidebar('toggle');"><i class="huge angle left icon" ></i></div> -->
                    <!-- <button class="ui button" href="javascript:void(0);" onclick="$('.ui.sidebar').sidebar('toggle');">
                            <i class="angle left icon" ></i>
                        </button> -->
                </div>                    
                <div id="right_bottom_coner_detail" style="height: 100%; width: 100%; padding-left:5%; float: left; overflow:auto">
                        <div id="detail_div" class="ui secondary vertical pointing menu" style="width: 100%">
                            <a class="active item">
                                车辆详情
                            </a>
                            <a id="detail_car_VIN" class="active item" href="javascript:void(0);" onclick="setSingleCarType('car_VIN')">
                                
                            </a>
                            <a id="detail_longitude" class="item" href="javascript:void(0);" onclick="setSingleCarType('longitude')">
                                
                            </a>
                            <a id="detail_latitude" class="item" href="javascript:void(0);" onclick="setSingleCarType('latitude')">
                                
                            </a>
                            <a id="detail_vehicle_operating_mode" class="item" href="javascript:void(0);" onclick="setSingleCarType('vehicle_operating_mode')">
                                
                            </a>
                            <a id="detail_brake_pedal_status" class="item" href="javascript:void(0);" onclick="setSingleCarType('brake_pedal_status')">
                                
                            </a>
                            <a id="detail_accelerator_pedal_stroke" class="item" href="javascript:void(0);" onclick="setSingleCarType('accelerator_pedal_stroke')">
                                
                            </a>
                            <a id="detail_gear_position" class="item" href="javascript:void(0);" onclick="setSingleCarType('gear_position')">
                                
                            </a>
                            <a id="detail_key_status" class="item" href="javascript:void(0);" onclick="setSingleCarType('key_status')">
                                
                            </a>
                            <a id="detail_driving_mode" class="item" href="javascript:void(0);" onclick="setSingleCarType('driving_mode')">
                                
                            </a>
                            <a id="detail_velocity" class="item" href="javascript:void(0);" onclick="setSingleCarType('velocity')">
                                
                            </a>
                            <a id="detail_motor_status" class="item" href="javascript:void(0);" onclick="setSingleCarType('motor_status')">
                                
                            </a>
                            <a id="detail_motor_torque" class="item" href="javascript:void(0);" onclick="setSingleCarType('motor_torque')">
                                
                            </a>
                            <a id="detail_drive_motor_rpm" class="item" href="javascript:void(0);" onclick="setSingleCarType('drive_motor_rpm')">
                                
                            </a>
                            <a id="detail_motor_controller_current" class="item" href="javascript:void(0);" onclick="setSingleCarType('motor_controller_current')">
                                
                            </a>
                            <a id="detail_motor_controller_voltage" class="item" href="javascript:void(0);" onclick="setSingleCarType('motor_controller_voltage')">
                                
                            </a>
                            <a id="detail_drive_motor_temperature" class="item" href="javascript:void(0);" onclick="setSingleCarType('drive_motor_temperature')">
                                
                            </a>
                            <a id="detail_motor_controller_temperature" class="item" href="javascript:void(0);" onclick="setSingleCarType('motor_controller_temperature')">
                                
                            </a>
                            <a id="detail_high_voltage_battery_current" class="item" href="javascript:void(0);" onclick="setSingleCarType('high_voltage_battery_current')">
                                
                            </a>
                            <a id="detail_total_battery_voltage" class="item" href="javascript:void(0);" onclick="setSingleCarType('total_battery_voltage')">
                                
                            </a>
                            <a id="detail_insulation_resistance_value" class="item" href="javascript:void(0);" onclick="setSingleCarType('insulation_resistance_value')">
                                
                            </a>
                            <a id="detail_residual_energy" class="item" href="javascript:void(0);" onclick="setSingleCarType('residual_energy')">
                                
                            </a>
                            <a id="detail_max_single_voltage" class="item" href="javascript:void(0);" onclick="setSingleCarType('max_single_voltage')">
                                
                            </a>
                            <a id="detail_min_single_voltage" class="item" href="javascript:void(0);" onclick="setSingleCarType('min_single_voltage')">
                                
                            </a>
                            <a id="detail_cumulative_mileage" class="item" href="javascript:void(0);" onclick="setSingleCarType('cumulative_mileage')">
                                
                            </a>
                        </div>
                </div>

            </div>
                
            <script>
                function mytime(){
                    var a = new Date();
                    var b = a.toLocaleTimeString();
                    var c = a.toLocaleDateString();
                    document.getElementById("time1").innerHTML = "&nbsp"+"&nbsp"+c+"&nbsp"+b;
                    }
                setInterval(function() {mytime()},1000);

                
            </script>

        </div>
    </div>
    </body>
</html>

<script type="text/javascript">
    function addLabel(){
        alert("车辆功能尚未完善");
    }

</script>

<script type="text/javascript">
    var onChangeCalled = false;

    function vinChange(){
        if (onChangeCalled){
            console.log("cascade");
            onChangeCalled = false;
            return;
        }else{
            onChangeCalled = true;
        }

        var requestId = document.getElementById('search-select');
        var requestIdValue = requestId.options[requestId.selectedIndex].value;

        console.log('vinchange to '+requestIdValue);
        console.log('license to '+getLicenseByVin(requestIdValue));
        $('#search-select-license').dropdown('set selected', getLicenseByVin(requestIdValue));
    }

    function licenseChange(){
        if (onChangeCalled){
            console.log("cascade");
            onChangeCalled = false;
            return;
        }else{
            onChangeCalled = true;
        }

        console.log('license change')
        var requestLicense = document.getElementById('search-select-license');
        var requestLicenseValue = requestLicense.options[requestLicense.selectedIndex].value;

        console.log('licensechange to '+requestLicenseValue);
        console.log('vin to '+getVinByLicense(requestLicenseValue));
        $('#search-select').dropdown('set selected', getVinByLicense(requestLicenseValue));
    }

</script>

<script type="text/javascript">

// <!-- 初始化地图 -->

	// 百度地图API功能
	var map = new BMap.Map("mapDiv");  // 创建Map实例
	// map.centerAndZoom("上海交通大学-电子信息与电气工程学院",15);      // 初始化地图,用城市名设置地图中心点
    //必须得要用坐标点，不然没法使用个性化地图
    // map.centerAndZoom(new BMap.Point(121.449051,31.03083),16);   //电院
    map.centerAndZoom(new BMap.Point(121.447176,31.033731),16); //新行政楼

    map.enableScrollWheelZoom(true);    //允许滚轮缩放地图
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
	var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
	var top_right_navigation = new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_RIGHT, type: BMAP_NAVIGATION_CONTROL_SMALL}); //右上角，仅包含平移和缩放按钮
    // map.addControl(top_left_control);        
	// map.addControl(top_left_navigation);     
	map.addControl(top_right_navigation);
    // map.setMapStyleV2({     
    //     styleId: '17c84567c712a49ee687af01700e1d74'
    // });

    var overlays = [];
	var overlaycomplete = function(e){
        overlays.push(e.overlay);
        console.log(e.overlay.getPath())
        drawingManager.close();
    };
    var styleOptions = {
        strokeColor:"red",    //边线颜色。
        fillColor:"none",      //填充颜色。当参数为空时，圆形将没有填充效果。
        strokeWeight: 3,       //边线的宽度，以像素为单位。
        strokeOpacity: 0.8,	   //边线透明度，取值范围0 - 1。
        fillOpacity: 0.6,      //填充的透明度，取值范围0 - 1。
        strokeStyle: 'solid', //边线的样式，solid或dashed。
        enableClicking: false,
    }
    //实例化鼠标绘制工具
    var drawingManager = new BMapLib.DrawingManager(map, {
        isOpen: false, //是否开启绘制模式
        enableDrawingTool: false, //是否显示工具栏
        drawingToolOptions: {
            anchor: BMAP_ANCHOR_TOP_RIGHT, //位置
            offset: new BMap.Size(5, 5), //偏离值
        },
        circleOptions: styleOptions, //圆的样式
        polylineOptions: styleOptions, //线的样式
        polygonOptions: styleOptions, //多边形的样式
        rectangleOptions: styleOptions //矩形的样式
    });  
    // 默认围栏
    SJTUPoints = [new BMap.Point(121.427485,31.034331), new BMap.Point(121.452907,31.042871), new BMap.Point(121.458567,31.029102), new BMap.Point(121.433666,31.021489)]
    defaulteFence = new BMap.Polygon(SJTUPoints, styleOptions)
    overlays.push(defaulteFence)
    
    map.addOverlay(defaulteFence)
    console.log('defaulteFence')
    console.log(defaulteFence)
    console.log(IsInPolygon(new BMap.Point(121.447176,31.033731), defaulteFence))
	 //添加鼠标绘制工具监听事件，用于获取绘制结果
    drawingManager.addEventListener('overlaycomplete', overlaycomplete);


    function centerAndZoomCarVin(e){
        console.log($(e).text())
        vin = $(e).text().split(' ')[0]

        console.log('center:'+vin)
        if((backGroundPointCache[vin] != undefined) && (backGroundPointCache[vin]['converted'] != undefined)){
            console.log(backGroundPointCache[vin]['converted'])
            console.log(IsInPolygon(backGroundPointCache[vin]['converted'], defaulteFence))
            map.centerAndZoom(backGroundPointCache[vin]['converted'],20);
        }else{
            console.log('centerAndZoomCarVin undefined')
        }
    }

    function centerAndZoomCoor(long, lati){
        console.log(long,lati)
        map.centerAndZoom(new BMap.Point(long, lati),20);

    }

    function clearAll() {
        for(var i = 0; i < overlays.length; i++){
            map.removeOverlay(overlays[i]);
        }
        overlays.length = 0   
    }

    function IsInPolygon(point, polygon){
        if(BMapLib.GeoUtils.isPointInPolygon(point,polygon)){
　　　　　　　return true;
        }else{
　　　　　　　return false;
        }
       
    }

    function IsInFance(point){
        for(var i = 0; i < overlays.length; i++){
            if(IsInPolygon(point, overlays[i]) == false){
                return false;
            }
        }
        return true;    
    }

    // 右键菜单
    var menu = new BMap.ContextMenu();
	var txtMenuItem = [
		{
			text:'返回全局模式',
			callback:function(){backToBackground();}
		},
        {
			text:'添加电子围栏',
			callback:function(){
                drawingManager.open();
                drawingManager.setDrawingMode(BMAP_DRAWING_POLYGON);
            }
		},
        {
			text:'移除电子围栏',
			callback:function(){
                clearAll();
            }
		},
		// {
		// 	text:'缩小',
		// 	callback:function(){map.zoomOut()}
		// }
	];

	for(var i=0; i < txtMenuItem.length; i++){
		menu.addItem(new BMap.MenuItem(txtMenuItem[i].text,txtMenuItem[i].callback,100));
	}
	map.addContextMenu(menu);



// <!-- 测试工具 -->
    function getRandomData(baseValue){
        var amplitude = (Math.random()*baseValue/5).toFixed(2)-0;
        if(Math.random() > 0.5) return baseValue+amplitude;
        else return baseValue-amplitude;

        // return Math.random()*maxValue.toFixed(2)-0;
    }

    var stackTimeStamp = 0;

    function getStackTimeStamp(){
        stackTimeStamp += 1;
        return stackTimeStamp;
    }



    function getNextStep(prePosition){
        var nxtLongi = prePosition['longitude'] + (Math.random()-0.5)/1000;
        var nxtLati = prePosition['latitude'] + (Math.random()-0.5)/1000;
        return {'longitude':nxtLongi, 'latitude':nxtLati};
    }

    var carTraceHistory = [{'longitude':121.451102, 'latitude':31.030699}]

    for(var i = 0; i < 100; ++i){
        carTraceHistory.push(getNextStep(carTraceHistory[carTraceHistory.length-1]));
    }

// <!-- 全局变量 当前激活脚本 状态信息 -->
    var totalOperatingModelCnt = 6;

    // 用于层叠图的全局变量数组
    var stack_online;
    var stack_offline;
    var stack_charging;
    var stack_initmode;
    var stack_poweron;
    var stack_time = new Array();
    var stack_show_time = new Array();
    var stack_value = new Array(totalOperatingModelCnt);
    for(var i = 0; i < totalOperatingModelCnt; ++i){
        stack_value[i] = new Array();
        console.log('stacklen ' + stack_value[i].length);
    }
    // 用于饼图和层叠图更新的数组
    var cur_value = new Array(totalOperatingModelCnt);

    // 当前interval函数句柄
    var curIntervalHandler;

    // 当前是单车模式还是背景模式
    var curSingleMode = false;
    // 判断当前是否需要更新
    // 当鼠标悬停再某个点上时，不更新，防止信息窗口山东
    var needUpdateMap = true;

    // 地图锁
    var mapLocked = false;

    // 当前关注单车
    var curCarVin; 
    var curCarType;

    // 用于侧边栏折线图的数据
    var singleDataPoly = new Array();

    // 单车模式下当前头部点覆盖物句柄
    var curNewOverlayHandler;
    var curOldOverlayHandler;

    // 单车模式下轨迹最近时间戳
    var curTraceStamp;

    // 不同状态下的覆盖物图标
    var iconOnline = new BMap.Icon("icon-green-small.gif", new BMap.Size(25, 25));
    var iconOffline = new BMap.Icon("icon-pink-small.gif", new BMap.Size(25, 25));
    var iconCharging = new BMap.Icon("icon-blue-small.gif", new BMap.Size(25, 25));
    var iconInitmode = new BMap.Icon("icon-purple-small.gif", new BMap.Size(25, 25));
    var iconPoweron = new BMap.Icon("icon-yellow-small.gif", new BMap.Size(25, 25));
    var iconUnknown = new BMap.Icon("icon-orange-small.gif", new BMap.Size(25, 25));

    var iconStart = new BMap.Icon("start.png", new BMap.Size(25, 25));
    var iconEnd = new BMap.Icon("final.png", new BMap.Size(25, 25));

    var iconArr = new Array();
    iconArr.push(iconOnline,iconOffline, iconCharging, iconInitmode, iconPoweron, iconUnknown);

    // 是否需要显示动画
    var needAnimation = [true, true, true, true, true];

    // 时间解析
    // Date.parse("2018-11-30T09:49:50.000Z")
    var timeGap = 1000*60*60*12;    //1000ms/s*60s/min*60min/h*12h

    function timeValidate(rawTime){
        return Math.floor(rawTime.getTime()/timeGap)*timeGap;
    }
    
    // 用于默认查询绘图的车辆原始坐标
    // var onlineCarPosition = [];
    // var offlineCarPosition = [];
    // var chargingCarPosition = [];
    // var poweronCarPosition = [];
    // var initmodeCarPosition = [];


    var carPosition = new Array(totalOperatingModelCnt);
    for(var i = 0; i < carPosition.length; ++i){
        carPosition[i] = new Array();
    }

    var carPositionIdx = new Array(totalOperatingModelCnt);

    function getOperatingModeType(typeStr){
        if(typeStr == '活跃'){
            return 0;
        }else if(typeStr == '休眠'){
            return 1;
        }else if(typeStr == '充电'){
            return 2;
        }else if(typeStr == '初始化'){
            return 3;
        }else if(typeStr == '上电'){
            return 4;
        }else{
            return 5;
        }
    }

    function getOperatingModeTypeName(typeNum){
        if(typeNum == 0){
            return '活跃';
        }else if(typeNum == 1){
            return '休眠';
        }else if(typeNum == 2){
            return '充电';
        }else if(typeNum == 3){
            return '初始化';
        }else if(typeNum == 4){
            return '上电';
        }else{
            return '未知';
        }
    }

    // 用于背景查询，当前需要查哪些值
    // var need_online = true;
    // var need_offline = true;
    // var need_charging = true;
    // var need_initmode = true;
    // var need_poweron = true;

    var needBackgroundRequest = new Array(totalOperatingModelCnt);

    for(var i = 0; i < needBackgroundRequest.length; ++i){
        needBackgroundRequest[i] = true;
    }

    var backgroundRequestProcessing = new Array(totalOperatingModelCnt);
    for(var i = 0; i < backgroundRequestProcessing.length; ++i){
        backgroundRequestProcessing[i] = false;
    }

    // 单车历史轨迹参数
    var singleCarFilteredPoints = new Array();
    var singleCarTranslatedPoints = new Array();
    var singleCarTranslatedPointsIdx = 0;
    var singleCarFilteredPointsIdx = 0;

    // 全局模式下地图覆盖物记录
    var backgroundCarOverlayOld = new Array(totalOperatingModelCnt);
    var backgroundCarOverlayNew = new Array(totalOperatingModelCnt);
    for(var i = 0; i < totalOperatingModelCnt; ++i){
        backgroundCarOverlayOld[i] = new Array();
        backgroundCarOverlayNew[i] = new Array();
    }

    // stack初始化是否完成，防止在空stack里过早插入数据
    var stackInitialFinish = false;

    // 网页过期
    var pageStale = false;

    // 用于背景查询的坐标缓存
    var backGroundPointCache = {};

    // 历史状态接口被封掉之后用all/location接口来画饼图用
    var pie_active_cnt = 0;
    var pie_deactive_cnt = 0;

    var singleCarTraceInitFinish = false;

    var shouldRequestSingle = true;


// <!-- 单车查询 -->
    function do_singleCarTrace(){
        console.log('do_singleCarTrace');
        if(singleCarTranslatedPoints.length == 0){
            alert('no history trace');
            return;
        }
        // console.log(singleCarTranslatedPoints.length);
        curOldOverlayHandler = new BMap.Marker(singleCarTranslatedPoints[0]);
        curOldOverlayHandler.setIcon(iconStart);
        map.addOverlay(curOldOverlayHandler)
        curOldOverlayHandler.setAnimation(BMAP_ANIMATION_DROP);//跳动的动画

        // for(var i = 1; i < singleCarTranslatedPoints.length; ++i){
        //     console.log(i);
        //     drawLine(singleCarTranslatedPoints[i-1], singleCarTranslatedPoints[i]);
        // }

        // var sym = new BMap.Symbol
        // (
        //     BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, //百度预定义的 箭头方向向下的非闭合箭头
        //     {
        //         fillColor : '#0F0', //设置矢量图标的填充颜色。支持颜色常量字符串、十六进制、RGB、RGBA等格式
        //         fillOpacity : 1, //设置矢量图标填充透明度,范围0~1
        //         scale : 0.5, //设置矢量图标的缩放比例
        //         // rotation : 90, //设置矢量图标的旋转角度,参数为角度
        //         strokeColor : '#FFF', //设置矢量图标的线填充颜色,支持颜色常量字符串、十六进制、RGB、RGBA等格式
        //         strokeOpacity : 1, //设置矢量图标线的透明度,opacity范围0~1
        //         strokeWeight : 2, //旋设置线宽。如果此属性没有指定，则线宽跟scale数值相
        //     }
        // );

        // var iconSequence = new BMap.IconSequence
        // (
        //     sym, //symbol为符号样式
        //     '0%', //offset为符号相对于线起点的位置，取值可以是百分比也可以是像素位置，默认为"100%"
        //     '40%', //repeat为符号在线上重复显示的距离，可以是百分比也可以是距离值，同时设置repeat与offset时，以repeat为准
        //     false //fixedRotation设置图标的旋转角度是否与线走向一致，默认为true
        // );
        // var polyline = new BMap.Polyline(
        //     singleCarTranslatedPoints,
        //     {
        //         icons : [iconSequence], //图标集合  **也是我之前没有实现样式改变的最大原因**
        //         strokeColor : '#0F0', //折线颜色 尽量与图标填充色保持一样
        //         strokeOpacity : 1, //折线的透明度，取值范围0 - 1
        //         strokeWeight : 5, //折线的宽度，以像素为单位
        //     }
        // );

        // var sy = new BMap.Symbol(BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, {
        //     scale: 0.6,//图标缩放大小
        //     strokeColor:'#fff',//设置矢量图标的线填充颜色
        //     strokeWeight: '2',//设置线宽
        // });
        // var icons = new BMap.IconSequence(sy, '10', '30');
        // var polyline =new BMap.Polyline(singleCarTranslatedPoints, {
        //     enableEditing: false,//是否启用线编辑，默认为false
        //     enableClicking: true,//是否响应点击事件，默认为true
        //     icons:[icons],
        //     strokeWeight:'8',//折线的宽度，以像素为单位
        //     strokeOpacity: 0.8,//折线的透明度，取值范围0 - 1
        //     strokeColor:"#18a45b" //折线颜色
        // });

        var polyline = new BMap.Polyline(singleCarTranslatedPoints, { strokeColor: "#18a45b", strokeWeight: 5, strokeOpacity: 0.8 });
        map.addOverlay(polyline);

        curNewOverlayHandler = new BMap.Marker(singleCarTranslatedPoints[singleCarTranslatedPoints.length-1]);
        curNewOverlayHandler.setIcon(iconEnd);
        var content = curCarVin;
        map.addOverlay(curNewOverlayHandler)
        curNewOverlayHandler.setAnimation(BMAP_ANIMATION_BOUNCE);//跳动的动画
        addMouseHandler(content, curNewOverlayHandler);

        singleCarTraceInitFinish = true;

        // console.log('brk0');
        
        var view = map.getViewport(eval([curOldOverlayHandler.getPosition(), curNewOverlayHandler.getPosition()]));
        var mapZoom = view.zoom; 
        var centerPoint = view.center; 
        map.centerAndZoom(centerPoint,mapZoom);

    }

    function rawPointValid(lon, lat){
        if (lon == null || lat == null) {
            return false;
        }
        if (lon > 124 || lon < 118 || lat > 35 || lat < 27) {
            return false;
        }
        return true;
    }

    function filterTrace(data){
        console.log('过滤前的历史轨迹长度: '+data.length);
        for(var i = 0; i < data.length; ++i){
            // if (data[i]['longitude'] == null || data[i]['latitude'] == null) {
            //     continue;
            // }
            // if (data[i]['longitude'] > 124 || data[i]['longitude'] < 118 || data[i]['latitude'] > 35 || data[i]['latitude'] < 27) {
            //     continue;
            // }

            if(!rawPointValid(data[i]['longitude'], data[i]['latitude'])){
                continue;
            }

            var curPoint = new BMap.Point(data[i]['longitude'], data[i]['latitude']);
            if(singleCarFilteredPoints.length == 0 || !curPoint.equals(singleCarFilteredPoints[singleCarFilteredPoints.length-1])){
                singleCarFilteredPoints.push(curPoint);
            }
            // if(singleCarFilteredPoints.length > 10) break;
        }
        console.log('过滤完的历史轨迹长度: '+singleCarFilteredPoints.length);

        // console.log(singleCarFilteredPoints.length);
    }

    function translateTrace(){
        console.log('translateTrace');
        var convertor = new BMap.Convertor();
        var pointArr = [];
        for(var j = 0; j < 10; ++j){
            if(singleCarFilteredPointsIdx >= singleCarFilteredPoints.length) break;
            pointArr.push(singleCarFilteredPoints[singleCarFilteredPointsIdx]);
            ++singleCarFilteredPointsIdx;
        }
        // console.log(singleCarFilteredPointsIdx);
        if(pointArr.length > 0) convertor.translate(pointArr, 1, 5, translateCallBackTrace);
    }

    function requestSingleCarTrace(){
        singleCarTraceInitFinish = false;
        $.ajax({
            url: 'http://202.120.60.31:3000/query/single/route', //请求的url
            type: 'get', //请求的方式
            data: 'car_VIN='+curCarVin+'&limit=2880',
            error: function (data) {
                console.log('requestSingleCarTrace请求失败');
            },
            success: function (data) {
                console.log('请求到的历史轨迹长度: '+data.length);
                singleCarTranslatedPoints = new Array();
                singleCarFilteredPoints = new Array();
                singleCarFilteredPointsIdx = 0;
                singleCarTranslatedPointsIdx = 0;
                filterTrace(data);
                translateTrace();
            }
            
        });

    }

    function setSingleCarType(typeName){
        if(typeName == curCarType){
            return;
        }else{
            mapLocked = true;
            curCarType = typeName;
            requestSingleCarHistory();
            mapLocked = false;
        }
    }

    function requestSingleCarHistory(){
        $.ajax({
            url: 'http://202.120.60.31:3000/query/single/history', //请求的url
            type: 'get', //请求的方式
            data: 'car_VIN='+curCarVin+'&type='+curCarType+'&limit=2880',
            error: function (data) {
                console.log('requestSingleCarHistory请求失败');
            },
            success: function (data) {
                console.log('requestSingleCarHistory success '+data.length);
                dataLine = new Array();

                var dataType = curCarType;
                if(dataType == 'velocity'){
                    dataType = 'speed';
                }

                for(var i = 0; i < data.length; ++i){
                    var d = new Date();
                    d.setTime(Date.parse(data[i]['create_time']));
                    dataLine.push({
                        name: d.toString(),
                        // [d.getFullYear(), d.getMonth() + 1, d.getDate()].join('/')
                        value: [
                            d.getTime(),
                            data[i][dataType]
                        ]
                    })
                }
                console.log('requestSingleCarHistory: '+dataLine.length+' '+data.length);

                myChartLine.setOption({
                    title:{
                        text:curCarType+' of '+curCarVin
                    },
                    series: [{
                        data: dataLine
                    }]
                });
            }
        });

        // for (var i = 0; i < 5; i++) {
        //     data.shift();
        //     data.push(randomData());
        // }
    
        // myChartLine.setOption({
        //     series: [{
        //         data: data
        //     }]
        // });
        
    }

    function createDetailItem(k, d){
        var result = '<a id="detail_cumulative_mileage" class="item" href="javascript:void(0);">' + k + ' : ' + d + '</a> \n';
        return result;
        
    }

    function requestSingleCar(){
        if(shouldRequestSingle == false) return;
        shouldRequestSingle = false;
        $.ajax({
            url: 'http://202.120.60.31:3000/query/single/info_java', //请求的url
            type: 'get', //请求的方式
            data: 'car_VIN='+curCarVin,
            error: function (data) {
                console.log('requestSingleCar请求失败');
            },
            success: function (data) {
                console.log('requestSingleCar success');
                console.log(data);
                data = JSON.parse(data);
                console.log(data);
                if(!curSingleMode) return;

                if(data.length == 0) return;

                var elementList = '<a class="active item">车辆详情</a>\n';

                // document.getElementById("detail_car").innerHTML = data;
                for(var key in data){
                    // console.log("detail_"+key);
                    // console.log(''+key+ ' : '+data[key]);

                    // var element = document.getElementById('detail_'+key)
                    // if(element != null) element.innerHTML = ''+key+ ' : '+data[key];
                    elementList += createDetailItem(key, data[key]);
                }

                document.getElementById('detail_div').innerHTML = elementList;

                if(rawPointValid(data['longitude'], data['latitude'])){
                    var convertor = new BMap.Convertor();
                    var pointArr = [];
                    pointArr.push(new BMap.Point(data['longitude'], data['latitude']));
                    convertor.translate(pointArr, 1, 5, singleQueryTranslateCallBack);
                }else{
                    // map.removeOverlay(curNewOverlayHandler);
                    // map.addOverlay(curNewOverlayHandler);    
                }

                var curOption = myChartGuage.getOption();
                curOption.series[0].data[0].value = parseInt(data['speed'], 10);
                curOption.series[1].data[0].value = parseInt(data['accPedalPos'], 10);
                curOption.series[2].data[0].value = parseInt(data['batVoltage'], 10);
                curOption.series[3].data[0].value = parseInt(data['batHighTemp'], 10);
                myChartGuage.setOption(curOption,true);

                console.log('speed: '+data['speed']);
                console.log('accPedalPos: '+data['accPedalPos']);
                console.log('batVoltage: '+data['batVoltage']);
                console.log('batHighTemp: '+data['batHighTemp']);

                var d = new Date();
                d.setTime(Date.parse(data['collectTime']));
                dataLine.push({
                    name: d.toString(),
                    // [d.getFullYear(), d.getMonth() + 1, d.getDate()].join('/')
                    value: [
                        d.getTime(),
                        data['speed']
                    ]
                })

                myChartLine.setOption({
                    series: [{
                        data: dataLine
                    }]
                });

                shouldRequestSingle = true;
            }
        });

        
    }


    

// <!-- 默认查询 -->
    function requestOnline(){
        // console.log('requestOnline '+carPosition[0].length);
        if(carPosition[0].length == 0){
            drawOverlay(0);
            // backgroundCarOverlayNew[0] = new Array();
            return;
        }
        
        backgroundRequestProcessing[0] = true;
        carPositionIdx[0] = 0;
        var convertor = new BMap.Convertor();
        var pointArr = [];
        pointArr.push(new BMap.Point(carPosition[0][carPositionIdx[0]][1],carPosition[0][carPositionIdx[0]][2]));
        convertor.translate(pointArr, 1, 5, translateCallBackOnline);
    }
    function requestOffline(){
        if(carPosition[1].length == 0){
            // console.log("backgroundCarOverlayNew[1].length" + backgroundCarOverlayNew[1].length);
            drawOverlay(1);

            // backgroundCarOverlayNew[1] = new Array();
            return;
        }
        backgroundRequestProcessing[1] = true;
        carPositionIdx[1] = 0;
        var convertor = new BMap.Convertor();
        var pointArr = [];
        pointArr.push(new BMap.Point(carPosition[1][carPositionIdx[1]][1],carPosition[1][carPositionIdx[1]][2]));
        convertor.translate(pointArr, 1, 5, translateCallBackOffline);
    }
    function requestCharging(){
        if(carPosition[2].length == 0){
            drawOverlay(2);
            return;
        }
        
        backgroundRequestProcessing[2] = true;
        carPositionIdx[2] = 0;
        var convertor = new BMap.Convertor();
        var pointArr = [];
        pointArr.push(new BMap.Point(carPosition[2][carPositionIdx[2]][1],carPosition[2][carPositionIdx[2]][2]));
        convertor.translate(pointArr, 1, 5, translateCallBackCharging);
    }
    function requestInitmode(){
        if(carPosition[3].length == 0){
            drawOverlay(3);
            return;
        }
        
        backgroundRequestProcessing[3] = true;
        carPositionIdx[3] = 0;
        var convertor = new BMap.Convertor();
        var pointArr = [];
        pointArr.push(new BMap.Point(carPosition[3][carPositionIdx[3]][1],carPosition[3][carPositionIdx[3]][2]));
        convertor.translate(pointArr, 1, 5, translateCallBackInitmode);
    }
    function requestPoweron(){
        if(carPosition[4].length == 0){
            drawOverlay(4);
            return;
        }
        
        backgroundRequestProcessing[4] = true;
        carPositionIdx[4] = 0;
        var convertor = new BMap.Convertor();
        var pointArr = [];
        pointArr.push(new BMap.Point(carPosition[4][carPositionIdx[4]][1],carPosition[4][carPositionIdx[4]][2]));
        convertor.translate(pointArr, 1, 5, translateCallBackPoweron);
    }
    function requestUnknown(){
        if(carPosition[5].length == 0){
            drawOverlay(5);
            return;
        }
        
        backgroundRequestProcessing[5] = true;
        carPositionIdx[5] = 0;
        var convertor = new BMap.Convertor();
        var pointArr = [];
        pointArr.push(new BMap.Point(carPosition[5][carPositionIdx[5]][1],carPosition[5][carPositionIdx[5]][2]));
        convertor.translate(pointArr, 1, 5, translateCallBackUnknown);
    }

    // function requestNormal(typeNum){
    //     if(carPosition[typeNum].length == 0) return;
    //     carPositionIdx[typeNum] = 0;
    //     var convertor = new BMap.Convertor();
    //     var pointArr = [];
    //     pointArr.push(new BMap.Point(carPosition[typeNum][carPositionIdx[typeNum]][1],carPosition[typeNum][carPositionIdx[typeNum]][2]));
    //     convertor.translate(pointArr, 1, 5, translateCallBackNor);
    // }

    var requestFunction = [requestOnline, requestOffline, requestCharging, requestInitmode, requestPoweron, requestUnknown];

    var filterDic = {}
    var filteredData = new Array();

    // 过滤全局模式车辆坐标请求返回信息中的重复内容
    function filterBackgroundRequest(data){
        filterDic = {};
        for(var i = 0; i < data.length; ++i){
            var tem_key = data[i]['VIN']
            if(filterDic.hasOwnProperty(tem_key) && (Date.parse(filterDic[tem_key]['collectTime']) >= Date.parse(data[i]['collectTime']))){
                continue;
            }else{
                filterDic[tem_key] = data[i];
            }
        }

        filteredData = new Array();
        for(var k in filterDic){
            if(k == "LK6ADCE20HB005678"){
                console.log("LK6ADCE20HB005678: ")
                console.log(filterDic[k]);
            }
            filteredData.push(filterDic[k]);
        }

    }

    var activeThreshold = 1000*60*3;

    function getMode(logTime, curTime){
        var tem = Date.parse(logTime);
        // console.log('curTime: '+curTime+' logTime: '+tem+' diff: '+(curTime-tem));
        if(curTime-tem > activeThreshold){
            // console.log('5 '+ (curTime-tem));
            return 1; //表示未知
        }else{
            // console.log('0 '+(curTime-tem));

            return 0; //表示运行中
        }
    }

    function backgroundRequest(){
        // map.clearOverlays();
        $.ajax({
            url: 'http://202.120.60.31:3000/query/all/location/batch', //请求的url
            type: 'get', //请求的方式
            error: function (data) {
                console.log('backgroundRequest请求失败');
            },
            success: function (data) {
                var needProcess = Array(totalOperatingModelCnt);
                for(var i = 0; i < totalOperatingModelCnt; ++i){
                    if(backgroundRequestProcessing[i] == true){
                        needProcess[i] = false;
                        console.log('background lock: '+getOperatingModeTypeName(i));
                    }else{
                        needProcess[i] = true
                    }
                }

                for(var i = 0; i < totalOperatingModelCnt; ++i){
                    if(needProcess[i] == false){
                        continue;
                    }else{
                        carPosition[i] = [];
                    }
                }

                var requestcnt = 0;
                var cachecnt = 0;
                var nocarcnt = 0;
                var unequalcnt = 0;
                var undefinecnt = 0;

                console.log("before filter"+data.length);
                filterBackgroundRequest(data);
                console.log("after filter"+filteredData.length)

                var curTime = new Date().getTime();
                pie_active_cnt = 0;
                pie_deactive_cnt = 0;


                for(var i = 0; i < filteredData.length; ++i){

                    // if(i+1 < data.length && data[i]['car_VIN'] == data[i+1]['car_VIN']){
                    //     continue;
                    // }

                    var tem_vin = filteredData[i]['VIN'];
                    var tem_point = new BMap.Point(filteredData[i]['longitude'], filteredData[i]['latitude']);
                    // var tem_type = getOperatingModeType(filteredData[i]['vehicle_operating_mode']);
                    var tem_type = getMode(filteredData[i]['collectTime'], curTime);

                    if(tem_type == 0){
                        pie_active_cnt += 1;
                        // console.log(tem_vin);
                    }else{
                        pie_deactive_cnt += 1;
                    }

                    // backGroundPointCache = {};
                    // console.log(backGroundPointCache);


                    if(backGroundPointCache.hasOwnProperty(tem_vin) && backGroundPointCache[tem_vin]['raw'].equals(tem_point) && backGroundPointCache[tem_vin]['converted'] != undefined){
                        cachecnt += 1;
                        
                        var marker = new BMap.Marker(backGroundPointCache[tem_vin]['converted']);
                        marker.setIcon(iconArr[tem_type]);
                        var content = filteredData[i]['VIN']+' '+vin2license[filteredData[i]['VIN']]+' '+getOperatingModeTypeName(tem_type);
                        // map.addOverlay(marker)
                        // if(needAnimation[5]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
                        addMouseHandler(content, marker);
                        backgroundCarOverlayNew[tem_type].push(marker);
                    }else{
                        requestcnt += 1;
                        if(!backGroundPointCache.hasOwnProperty(tem_vin)){
                            ++nocarcnt;
                        }else if(!backGroundPointCache[tem_vin]['raw'].equals(tem_point)){
                            ++unequalcnt;
                            // console.log('carvin: '+tem_vin);
                            // console.log('unequal: '+filteredData[i]['longitude']+', '+filteredData[i]['latitude']+' old: '+backGroundPointCache[tem_vin]['raw'].lng+', '+backGroundPointCache[tem_vin]['raw'].lat);
                        }else{
                            ++undefinecnt;
                        }

                        backGroundPointCache[tem_vin] = {
                            raw:tem_point,
                            converted:undefined
                        };
                        if(needProcess[tem_type] == true){
                            (carPosition[tem_type]).push([filteredData[i]['VIN']+' '+vin2license[filteredData[i]['VIN']]+' '+getOperatingModeTypeName(tem_type), filteredData[i]['longitude'], filteredData[i]['latitude']]);
                        }
                    }

                    // (carPosition[getOperatingModeType(data[i]['vehicle_operating_mode'])]).push([data[i]['car_VIN']+' '+data[i]['vehicle_operating_mode'], new Bmap.Point(data[i]['longitude'], data[i]['latitude'])]);

                    // (carPosition[getOperatingModeType(data[i]['vehicle_operating_mode'])]).push([data[i]['car_VIN']+' '+data[i]['vehicle_operating_mode'], data[i]['longitude'], data[i]['latitude']]);
                    // if(data[i]['vehicle_operating_mode'] == '活跃'){
                    //     onlineCarPosition.push([data[i]['car_VIN'], data[i]['longitude'], data[i]['latitude']]);
                    // }else if(data[i]['vehicle_operating_mode'] == '离线'){
                    //     offlineCarPosition.push([data[i]['car_VIN'], data[i]['longitude'], data[i]['latitude']]);
                    // }else if(data[i]['vehicle_operating_mode'] == '充电'){
                    //     chargingCarPosition.push([data[i]['car_VIN'], data[i]['longitude'], data[i]['latitude']]);
                    // }else if(data[i]['vehicle_operating_mode'] == '初始化'){
                    //     initmodeCarPosition.push([data[i]['car_VIN'], data[i]['longitude'], data[i]['latitude']]);
                    // }else if(data[i]['vehicle_operating_mode'] == '上电'){
                    //     poweronCarPosition.push([data[i]['car_VIN'], data[i]['longitude'], data[i]['latitude']]);
                    // }
                }

                var option = myChartPie.getOption();
                for(var i = 0; i < totalOperatingModelCnt; ++i){
                    option.series[0].data[i]['value'] = 0;
                }
                option.series[0].data[0]['value'] = pie_active_cnt;
                option.series[0].data[1]['value'] = pie_deactive_cnt;

                myChartPie.setOption(option);

                cur_value[0] = pie_active_cnt;
                cur_value[1] = pie_deactive_cnt;

                console.log('deactive: '+pie_deactive_cnt);

                var curDate = curTime;

                if(stack_time.length == 0 || curDate > stack_time[stack_time.length-1] || _shouldUpdataStack()){
                    if(stack_time.length >= 1500){
                        stack_time.shift();
                        stack_show_time.shift();
                        for(var i = 0; i < totalOperatingModelCnt; ++i){
                            stack_value[i].shift();
                        }
                        // stack_online.shift();
                        // stack_offline.shift();
                        // stack_charging.shift();
                        // stack_poweron.shift();
                        // stack_initmode.shift();
                    }
                    var tem = curDate;
                    stack_time.push(tem);
                    stack_show_time.push(_get_valide_date_for_stack(tem));
                    for(var i = 0; i < 2; ++i){
                        // console.log('stack_value.length'+stack_value.length);

                        // console.log('stack_value[i].length'+stack_value[i].length);

                        (stack_value[i]).push(cur_value[i]);
                    }
                    // stack_online.push(cur_online);
                    // stack_offline.push(cur_offline);
                    // stack_charging.push(cur_charging);
                    // stack_poweron.push(cur_poweron);
                    // stack_initmode.push(cur_initmode);

                    var option = myChartStack.getOption();
                    for(var i = 0; i < totalOperatingModelCnt; ++i){
                        option.series[i].data = stack_value[i];
                    }
                    // option.series[0].data = stack_online;
                    // option.series[1].data = stack_offline;
                    // option.series[2].data = stack_charging;
                    // option.series[3].data = stack_initmode;
                    // option.series[4].data = stack_poweron;
                    option.xAxis[0].data = stack_show_time;

                    myChartStack.setOption(option);

                }

                console.log('request: '+requestcnt+' cache: '+cachecnt);
                console.log('nocar: '+nocarcnt+' unequal: '+unequalcnt+' undefine: '+undefinecnt);

                // for(var i = 0; i < totalOperatingModelCnt; ++i){
                //     console.log(carPosition[i].length+'');
                // }
                for(var i = 0; i < totalOperatingModelCnt; ++i){
                    // console.log("request: "+i+" "+carPosition[i].length);
                    if((needBackgroundRequest[i] == true) && (needProcess[i] == true)) requestFunction[i]();
                    // console.log(getOperatingModeTypeName(i)+' : '+carPosition[i].length);
                }


            }
        });

        // mapLocked = true;
        

    }

// <!-- 背景查询 -->

    function _get_valide_date_for_stack(millisecond){
        var tem = new Date();
        tem.setTime(millisecond);
        return tem.toLocaleString();
    }

    function _all_zero(idx){
        for(var i = 0; i < totalOperatingModelCnt; ++i){
            if(idx >= stack_value[i].length || stack_value[i][idx] != 0){
                return false;
            }
        }
        return true;
    }
    function do_initialStack(data){
        // console.log(data.length);
        // stack_online = new Array(5000);
        // stack_offline = new Array(5000);
        // stack_charging = new Array(5000);
        // stack_initmode = new Array(5000);
        // stack_poweron = new Array(5000);
        for(var i = 0; i < totalOperatingModelCnt; ++i){
            stack_value[i] = new Array(5000);
        }
        // console.log('stack array initial finish with length: '+stack_value[0].length);
        stack_time = new Array(5000);
        // stack_show_time = new Array(5000);
        
        var curDate = timeValidate(new Date());
        // console.log('curDate'+curDate);

        for(var i = 0; i < 5000; ++i){
            // console.log(i);
            stack_time[5000-1-i] = (curDate-timeGap*i);
            for(var j = 0; j < totalOperatingModelCnt; ++j){
                stack_value[j][i] = 0;
            }
        }

        for(var c = 0; c < data.length; ++c){
            // console.log(c);
            curInfo = data[c]['info']
            // console.log(curInfo.length);
            var curDataIdx = 0;
            for(var i in stack_time){
                                // for(;curDataIdx < curInfo.length && timeValidate(curInfo[curDataIdx]['create_time']) <= stack_time[i]; ++curDataIdx){}
                while(curDataIdx < curInfo.length && Date.parse(curInfo[curDataIdx]['create_time']) <= stack_time[i]){
                    ++curDataIdx;
                }
                // if(curDataIdx < curInfo.length) console.log(curDataIdx+' '+Date.parse(curInfo[curDataIdx]['create_time'])+' '+stack_time[i]);
                // else console.log('achieve length')
                if(curDataIdx == 0){
                    continue;
                }else{
                    stack_value[getOperatingModeType(curInfo[curDataIdx-1]['vehicle_operating_mode'])][i] += 1;
                    // if(curInfo[curDataIdx-1]['vehicle_operating_mode'] == '活跃'){
                    //     stack_online[i] += 1;
                    // }else if(curInfo[curDataIdx-1]['vehicle_operating_mode'] == '充电'){
                    //     stack_charging[i] += 1;
                    // }else if(curInfo[curDataIdx-1]['vehicle_operating_mode'] == '休眠'){
                    //     stack_offline[i] += 1;
                    // }else if(curInfo[curDataIdx-1]['vehicle_operating_mode'] == '上电'){
                    //     stack_poweron[i] += 1;
                    // }else if(curInfo[curDataIdx-1]['vehicle_operating_mode'] == '初始化'){
                    //     stack_initmode[i] += 1;
                    // }
                }
            }
        }
        while(stack_time.length > 0){
            if(_all_zero(0)){
                for(var i = 0; i < totalOperatingModelCnt; ++i){
                    stack_value[i].shift();
                }
                // stack_online.shift();
                // stack_offline.shift();
                // stack_charging.shift();
                // stack_poweron.shift();
                // stack_initmode.shift();
                stack_time.shift();
            }else{
                break;
            }
        }

        for(var i = 0; i < stack_time.length; ++i){
            // var tem = new Date();
            // tem.setTime(stack_time[i]);
            stack_show_time.push(_get_valide_date_for_stack(stack_time[i]));
        }

        // console.log(stack_value[0].length);

        var option = myChartStack.getOption();
        for(var i = 0; i < totalOperatingModelCnt; ++i){
            option.series[i].data = stack_value[i];
        }
        // option.series[0].data = stack_online;
        // option.series[1].data = stack_offline;
        // option.series[2].data = stack_charging;
        // option.series[3].data = stack_initmode;
        // option.series[4].data = stack_poweron;
        option.xAxis[0].data = stack_show_time;
        // option.xAxis[0].data = stack_time;


        myChartStack.setOption(option);

        stackInitialFinish = true;

    }

    // 初始化层叠图
    function initialStack(){
        $.ajax({
            url: 'http://202.120.60.31:3000/query/history/status', //请求的url
            type: 'get', //请求的方式
            data: 'limit=5000000',
            error: function (data) {
                console.log('initialStack请求失败');
            },
            success: function (data) {
                do_initialStack(data);
            }
            
        });

    }

    function _shouldUpdataStack(){
        for(var i = 0; i < totalOperatingModelCnt; ++i){
            if(cur_value[i] != stack_value[i][stack_value[i].length-1]){
                return true;
            }
        }
        return false;
    }

    function requestCurrentTypeNum(){
        $.ajax({
            url: 'http://202.120.60.31:3000/query/history/status', //请求的url
            type: 'get', //请求的方式
            data: 'limit=0',
            error: function (data) {
                console.log('requestCurrentTypeNum请求失败');
            },
            success: function (data) {
                // var cur_online = 0;
                // var cur_offline = 0;
                // var cur_charging = 0;
                // var cur_initmode = 0;
                // var cur_poweron = 0;
                
                for(var i = 0; i < totalOperatingModelCnt; ++i){
                    cur_value[i] = 0;
                }
                
                for(var i in data){
                    cur_value[getOperatingModeType(data[i]['latest_info']['vehicle_operating_mode'])] += 1;

                    // if(data[i]['latest_info']['vehicle_operating_mode'] == '休眠'){
                    //     ++cur_offline;
                    // }else if(data[i]['latest_info']['vehicle_operating_mode'] == '活跃'){
                    //     ++cur_online;
                    // }else if(data[i]['latest_info']['vehicle_operating_mode'] == '充电'){
                    //     ++cur_charging;
                    // }else if(data[i]['latest_info']['vehicle_operating_mode'] == '上电'){
                    //     ++cur_poweron;
                    // }else if(data[i]['latest_info']['vehicle_operating_mode'] == '初始化'){
                    //     ++cur_initmode;
                    // }
                }

                // pie的修改转移到背景查询中了
                // var option = myChartPie.getOption();
                // for(var i = 0; i < totalOperatingModelCnt; ++i){
                //     // option.series[0].data[i]['value'] = cur_value[i];
                //     option.series[0].data[i]['value'] = 0;
                // }
                // option.series[0].data[0]['value'] = pie_active_cnt;
                // option.series[0].data[1]['value'] = pie_deactive_cnt;

                // // option.series[0].data[0]['value'] = cur_online;
                // // option.series[0].data[1]['value'] = cur_offline;
                // // option.series[0].data[2]['value'] = cur_charging;
                // // option.series[0].data[3]['value'] = cur_initmode;
                // // option.series[0].data[4]['value'] = cur_poweron;
                // myChartPie.setOption(option);

                // console.log('brk 1');
                // var curDate = timeValidate(new Date());
                if(!stackInitialFinish) return;

                var curDate = new Date().getTime();

                if(stack_time.length == 0 || curDate > stack_time[stack_time.length-1] || _shouldUpdataStack()){
                    if(stack_time.length >= 1500){
                        stack_time.shift();
                        stack_show_time.shift();
                        for(var i = 0; i < totalOperatingModelCnt; ++i){
                            stack_value[i].shift();
                        }
                        // stack_online.shift();
                        // stack_offline.shift();
                        // stack_charging.shift();
                        // stack_poweron.shift();
                        // stack_initmode.shift();
                    }
                    var tem = new Date().getTime();
                    stack_time.push(tem);
                    stack_show_time.push(_get_valide_date_for_stack(tem));
                    for(var i = 0; i < totalOperatingModelCnt; ++i){
                        // console.log('stack_value.length'+stack_value.length);
                        if(stack_value[i] == undefined) stack_value = new Array();
                        console.log('stack_value[i].length'+stack_value[i].length);

                        (stack_value[i]).push(cur_value[i]);
                    }
                    // stack_online.push(cur_online);
                    // stack_offline.push(cur_offline);
                    // stack_charging.push(cur_charging);
                    // stack_poweron.push(cur_poweron);
                    // stack_initmode.push(cur_initmode);

                    var option = myChartStack.getOption();
                    for(var i = 0; i < totalOperatingModelCnt; ++i){
                        option.series[i].data = stack_value[i];
                    }
                    // option.series[0].data = stack_online;
                    // option.series[1].data = stack_offline;
                    // option.series[2].data = stack_charging;
                    // option.series[3].data = stack_initmode;
                    // option.series[4].data = stack_poweron;
                    option.xAxis[0].data = stack_show_time;

                    myChartStack.setOption(option);

                }
            }
        });

        /**
         * stack初始化方法，UTC时间->毫秒数
         * 从此刻开始向前追溯一定的距离，每1000ms为array中的一个单位
         * 针对每辆car
         *  针对每个时间单为
         *      遍历info数组，知道到时间不大于当前单位的那个元素，填入
         * 
         */
        // var cur_online = getRandomData(100);
        // var cur_offline = getRandomData(50);
        // var cur_charging = getRandomData(50);

        // // var option = myChartPie.getOption();
        // // option.series[0].data[0]['value'] = cur_online;
        // // option.series[0].data[1]['value'] = cur_offline;
        // // option.series[0].data[2]['value'] = cur_charging;
        // // myChartPie.setOption(option);

        // stack_time.shift();
        // stack_time.push(getStackTimeStamp());
        // stack_online.shift();
        // stack_online.push(cur_online);
        // stack_offline.shift();
        // stack_offline.push(cur_offline);
        // stack_charging.shift();
        // stack_charging.push(cur_charging);

        // option = myChartStack.getOption();
        // option.series[0].data = stack_online;
        // option.series[1].data = stack_offline;
        // option.series[2].data = stack_charging;
        // option.xAxis[0].data = stack_time;

        // myChartStack.setOption(option);
    }


// <!-- 回调函数 -->  

    // <!-- 饼图回调函数 --> 
    function eConsole(param) {
        needBackgroundRequest[param.dataIndex] = !needBackgroundRequest[param.dataIndex];
        if(needBackgroundRequest[param.dataIndex] == false){
            for(var i = 0; i < backgroundCarOverlayOld[param.dataIndex].length; ++i){
                map.removeOverlay(backgroundCarOverlayOld[param.dataIndex][i]);
            }
            // backgroundCarOverlayOld[param.dataIndex];
        }else{
            if(backgroundCarOverlayOld[param.dataIndex].length != 0){
                for(var i = 0; i < backgroundCarOverlayOld[param.dataIndex].length; ++i){
                    map.addOverlay(backgroundCarOverlayOld[param.dataIndex][i]);
                }
            }
        }
        needAnimation[param.dataIndex] = true;
    }

    // <!-- 搜索点击回调函数 -->
    function onClickSearchButton(){
        var requestType = document.getElementById('select');
        var requestTypeValue = requestType.options[requestType.selectedIndex].value;
        var requestId = document.getElementById('search-select');
        var requestIdValue = requestId.options[requestId.selectedIndex].value;

        do_initRequestSingleCar(requestTypeValue, requestIdValue)

    }

    // <!-- 地图覆盖物点击回调函数 -->
    function onClickOverlay(targetId){
        var requestType = document.getElementById('select');
        var requestTypeValue = requestType.options[requestType.selectedIndex].value;

        //TODO: 通过车辆选择之后也要进行选择框联动修改
        // $('#search-select')
        //     .dropdown('set selected', targetId)
        // ;

        do_initRequestSingleCar(requestTypeValue, targetId)

        // onClickSearchButton()
        // console.log(targetId);
    }

    // <!-- 进入单车模式的实际执行函数 -->
    function do_initRequestSingleCar(requestTypeValue, requestIdValue){
        // data = [];
        // for (var i = 0; i < 1000; i++) {
        //     data.push(randomData());
        // }
        console.log('single start');
        document.getElementById("right_bottom_coner_default").style.display="none";//隐藏
        document.getElementById("right_bottom_coner_detail").style.display="";//隐藏


        // if(requestIdValue != 'LK6ADCE28JB008253') console.log('no data yet');
        // else{
            mapLocked = true;
            map.clearOverlays();
            curSingleMode = true;
            curCarVin = requestIdValue;
            curCarType = requestTypeValue;
            requestSingleCarTrace();
            requestSingleCarHistory();
            // map.addEventListener('click', function(){console.log('EventListener trigged')});
            curSingleMode = true;
            mapLocked = false;
            console.log('request History finish'+ curSingleMode);
            shouldRequestSingle = true;

            
        // }
    }

    // 进入单车模式后增加的地图回调函数 用于返回到默认模式
    function backToBackground(){
        console.log("evoke");
        map.clearOverlays();
        // map.removeEventListener("click", backToBackground);
        for(var i = 0; i < needAnimation.length; ++i){
            needAnimation[i] = true;
        }
        map.centerAndZoom(new BMap.Point(121.447176,31.033731),16); //新行政楼

        var option = myChartGuage.getOption();
        option.series[0].data[0].value = 0;
        option.series[1].data[0].value = 0;
        option.series[2].data[0].value = 0;
        option.series[3].data[0].value = 0;
        myChartGuage.setOption(optionGuage);

        dataLine=[];

        myChartLine.setOption({
            title:{
                text:' '
            },
            series: [{
                data: dataLine
            }]
        });

        for(var i = 0; i < totalOperatingModelCnt; ++i){
            
            if(needBackgroundRequest[i] && backgroundCarOverlayOld[i].length != 0){
                for(var j = 0; j < backgroundCarOverlayOld[i].length; ++j){
                    map.addOverlay(backgroundCarOverlayOld[i][j]);
                }
            }
        }

        curSingleMode = false;
        document.getElementById("right_bottom_coner_detail").style.display="none";//隐藏
        document.getElementById("right_bottom_coner_default").style.display="";

        console.log('backtoground cursinglemode='+curSingleMode);
    }

    // 百度地图坐标转换回调函数
    function translateCallBackOnline(data){
        // console.log('onlineCallback');
        if(data.status != 0){
            console.log('translateCallBackOnline错误');
        }else{
            var marker = new BMap.Marker(data.points[0]);
            marker.setIcon(iconArr[0]);
            var content = carPosition[0][carPositionIdx[0]][0];
            // map.addOverlay(marker)
            // if(needAnimation[0]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
            addMouseHandler(content, marker);
            backgroundCarOverlayNew[0].push(marker);

            var tem_vin = content.split(' ')[0];
            backGroundPointCache[tem_vin]['converted'] = data.points[0];

            if(IsInFance(data.points[0]) == false){
                console.log("carPosition[0][carPositionIdx[0]]");
                console.log(carPosition[0][carPositionIdx[0]]);

                var obj = document.getElementById("right_bottom_coner_default");
                var new_tex = document.createElement("p");
                new_tex.setAttribute("onclick", "centerAndZoomCarVin(this)");
                new_tex.innerHTML = carPosition[0][carPositionIdx[0]][0];
                obj.appendChild(new_tex);

            }

            
            ++carPositionIdx[0];
            if(carPositionIdx[0] == carPosition[0].length){
                needAnimation[0] = false;
                backgroundRequestProcessing[0] = false;
                drawOverlay(0);

                // for(var i = 0; i < totalOperatingModelCnt; ++i){
                //     if(carPositionIdx[i] != carPosition[i].length){
                //         return;
                //     }
                // }
                // mapLocked = false;
            }else{
                var convertor = new BMap.Convertor();
                var pointArr = [];
                pointArr.push(new BMap.Point(carPosition[0][carPositionIdx[0]][1],carPosition[0][carPositionIdx[0]][2]));
                convertor.translate(pointArr, 1, 5, translateCallBackOnline);
            }
        }
    }

    function translateCallBackOffline(data){
        if(data.status != 0){
            console.log('translateCallBackOffline错误');
        }else{
            // console.log(data);
            var marker = new BMap.Marker(data.points[0]);
            marker.setIcon(iconArr[1]);
            var content = carPosition[1][carPositionIdx[1]][0];
            // console.log(content);
            // console.log(''+carPosition[1][carPositionIdx[1]][0] +', '+ carPosition[1][carPositionIdx[1]][1] + ', '+ carPosition[1][carPositionIdx[1]][2])

            // if(carPosition[1][carPositionIdx[1]][0] == 'LK6ADCE20HB005700 休眠'){
            //     console.log(''+carPosition[1][carPositionIdx[1]][0] +', '+ carPosition[1][carPositionIdx[1]][1] + ', '+ carPosition[1][carPositionIdx[1]][2])
            //     console.log(data.points[0])
            // }

            // map.addOverlay(marker)
            // if(needAnimation[1]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
            addMouseHandler(content, marker);
            backgroundCarOverlayNew[1].push(marker);

            var tem_vin = content.split(' ')[0];
            backGroundPointCache[tem_vin]['converted'] = data.points[0];

            if(IsInFance(data.points[0]) == false){
                // console.log("carPosition[1][carPositionIdx[1]]");
                console.log(carPosition[1][carPositionIdx[1]]);

                var obj = document.getElementById("right_bottom_coner_default");
                var new_tex = document.createElement("p");
                // curVin = carPosition[1][carPositionIdx[1]][0].split()[1]
                console.log(tem_vin)
                new_tex.setAttribute("onclick", "centerAndZoomCarVin(this)");
                new_tex.innerHTML = carPosition[1][carPositionIdx[1]][0];
                obj.appendChild(new_tex);
            }

            
            ++carPositionIdx[1];
            if(carPositionIdx[1] == carPosition[1].length){
                needAnimation[1] = false;
                backgroundRequestProcessing[1] = false;
                drawOverlay(1);

                // for(var i = 0; i < totalOperatingModelCnt; ++i){
                //     if(carPositionIdx[i] != carPosition[i].length){
                //         return;
                //     }
                // }
                // mapLocked = false;
            }else{
                var convertor = new BMap.Convertor();
                var pointArr = [];
                pointArr.push(new BMap.Point(carPosition[1][carPositionIdx[1]][1],carPosition[1][carPositionIdx[1]][2]));
                convertor.translate(pointArr, 1, 5, translateCallBackOffline);
            }
        }
    }

    function translateCallBackCharging(data){
        if(data.status != 0){
            console.log('translateCallBackCharging');
        }else{
            var marker = new BMap.Marker(data.points[0]);
            marker.setIcon(iconArr[2]);
            var content = carPosition[2][carPositionIdx[2]][0];
            // map.addOverlay(marker)
            // if(needAnimation[2]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
            addMouseHandler(content, marker);
            backgroundCarOverlayNew[2].push(marker);

            var tem_vin = content.split(' ')[0];
            backGroundPointCache[tem_vin]['converted'] = data.points[0];

            
            ++carPositionIdx[2];
            if(carPositionIdx[2] == carPosition[2].length){
                needAnimation[2] = false;
                backgroundRequestProcessing[2] = false;
                drawOverlay(2);

                // for(var i = 0; i < totalOperatingModelCnt; ++i){
                //     if(carPositionIdx[i] != carPosition[i].length){
                //         return;
                //     }
                // }
                // mapLocked = false;
            }else{
                var convertor = new BMap.Convertor();
                var pointArr = [];
                pointArr.push(new BMap.Point(carPosition[2][carPositionIdx[2]][1],carPosition[2][carPositionIdx[2]][2]));
                convertor.translate(pointArr, 1, 5, translateCallBackCharging);
            }
        }
    }

    function translateCallBackInitmode(data){
        if(data.status != 0){
            console.log('translateCallBackInitmode');
        }else{
            var marker = new BMap.Marker(data.points[0]);
            marker.setIcon(iconArr[3]);
            var content = carPosition[3][carPositionIdx[3]][0];
            // map.addOverlay(marker)
            // if(needAnimation[3]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
            addMouseHandler(content, marker);
            backgroundCarOverlayNew[3].push(marker);

            var tem_vin = content.split(' ')[0];
            backGroundPointCache[tem_vin]['converted'] = data.points[0];

            
            ++carPositionIdx[3];
            if(carPositionIdx[3] == carPosition[3].length){
                needAnimation[3] = false;
                backgroundRequestProcessing[3] = false;
                drawOverlay(3);

                // for(var i = 0; i < totalOperatingModelCnt; ++i){
                //     if(carPositionIdx[i] != carPosition[i].length){
                //         return;
                //     }
                // }
                // mapLocked = false;
            }else{
                var convertor = new BMap.Convertor();
                var pointArr = [];
                pointArr.push(new BMap.Point(carPosition[3][carPositionIdx[3]][1],carPosition[3][carPositionIdx[3]][2]));
                convertor.translate(pointArr, 1, 5, translateCallBackInitmode);
            }
        }
    }

    function translateCallBackPoweron(data){
        if(data.status != 0){
            console.log('translateCallBackPoweron');
        }else{
            var marker = new BMap.Marker(data.points[0]);
            marker.setIcon(iconArr[4]);
            var content = carPosition[4][carPositionIdx[4]][0];
            // map.addOverlay(marker)
            // if(needAnimation[4]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
            addMouseHandler(content, marker);
            backgroundCarOverlayNew[4].push(marker);

            var tem_vin = content.split(' ')[0];
            backGroundPointCache[tem_vin]['converted'] = data.points[0];

            
            ++carPositionIdx[4];
            if(carPositionIdx[4] == carPosition[4].length){
                needAnimation[4] = false;
                backgroundRequestProcessing[4] = false;
                drawOverlay(4);

                // for(var i = 0; i < totalOperatingModelCnt; ++i){
                //     if(carPositionIdx[i] != carPosition[i].length){
                //         return;
                //     }
                // }
                // mapLocked = false;
            }else{
                var convertor = new BMap.Convertor();
                var pointArr = [];
                pointArr.push(new BMap.Point(carPosition[4][carPositionIdx[4]][1],carPosition[4][carPositionIdx[4]][2]));
                convertor.translate(pointArr, 1, 5, translateCallBackPoweron);
            }
        }
    }

    function translateCallBackUnknown(data){
        if(data.status != 0){
            console.log('translateCallBackPoweron');
        }else{
            // console.log('unknown translate doing');
            

            var marker = new BMap.Marker(data.points[0]);
            marker.setIcon(iconArr[5]);
            var content = carPosition[5][carPositionIdx[5]][0];
            // map.addOverlay(marker)
            // if(needAnimation[5]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
            addMouseHandler(content, marker);
            backgroundCarOverlayNew[5].push(marker);

            var tem_vin = content.split(' ')[0];
            backGroundPointCache[tem_vin]['converted'] = data.points[0];

            
            ++carPositionIdx[5];
            if(carPositionIdx[5] == carPosition[5].length){
                needAnimation[5] = false;
                // console.log('unknown translate finish');
                backgroundRequestProcessing[5] = false;
                drawOverlay(5);

                // for(var i = 0; i < totalOperatingModelCnt; ++i){
                //     if(carPositionIdx[i] != carPosition[i].length){
                //         return;
                //     }
                // }
                // mapLocked = false;
            }else{
                var convertor = new BMap.Convertor();
                var pointArr = [];
                pointArr.push(new BMap.Point(carPosition[5][carPositionIdx[5]][1],carPosition[5][carPositionIdx[5]][2]));
                convertor.translate(pointArr, 1, 5, translateCallBackUnknown);
            }
        }
    }

    // function translateCallBackNormal(data, typeNum){
    //     if(data.status != 0){
    //         console.log('translateCallBackNormal '+typeNum);
    //     }else{
    //         var marker = new BMap.Marker(data.points[0]);
    //         marker.setIcon(iconArr[typeNum]);
    //         var content = carPosition[typeNum][carPositionIdx[typeNum]][0];
    //         // map.addOverlay(marker)
    //         // if(needAnimation[5]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
    //         addMouseHandler(content, marker);
    //         backgroundCarOverlayNew[typeNum].push(marker);
            
    //         ++carPositionIdx[typeNum];
    //         if(carPositionIdx[typeNum] == carPosition[typeNum].length){
    //             needAnimation[typeNum] = false;
    //             drawOverlay(typeNum);
    //             // for(var i = 0; i < totalOperatingModelCnt; ++i){
    //             //     if(carPositionIdx[i] != carPosition[i].length){
    //             //         return;
    //             //     }
    //             // }
    //             // mapLocked = false;
    //         }else{
    //             var convertor = new BMap.Convertor();
    //             var pointArr = [];
    //             pointArr.push(new BMap.Point(carPosition[typeNum][carPositionIdx[typeNum]][1],carPosition[typeNum][carPositionIdx[typeNum]][2]));
    //             convertor.translate(pointArr, 1, 5, translateCallBackPoweron);
    //         }
    //     }
    // }

    function translateCallBackTrace(data){
        if(data.status != 0){
            console.log('translateCallBackTrace');
        }else{
            for(var i = 0; i < data.points.length; ++i){
                singleCarTranslatedPoints.push(data.points[i]);
                if(singleCarTranslatedPoints.length > 1){
                    // console.log('draw: '+singleCarTranslatedPoints.length);
                    // drawLine(singleCarTranslatedPoints[singleCarTranslatedPoints.length-2], singleCarTranslatedPoints[singleCarTranslatedPoints.length-1]);
                }
            }
            // console.log(singleCarTranslatedPoints.length);
            if(singleCarFilteredPointsIdx >= singleCarFilteredPoints.length){
                console.log('translate finish: '+singleCarTranslatedPoints.length);
                do_singleCarTrace();
            }else{
                var convertor = new BMap.Convertor();
                var pointArr = [];
                console.log("singleCarFilteredPointsIdx Str: "+singleCarFilteredPointsIdx);

                for(var j = 0; j < 10; ++j){
                    if(singleCarFilteredPointsIdx >= singleCarFilteredPoints.length) break;
                    pointArr.push(singleCarFilteredPoints[singleCarFilteredPointsIdx]);
                    ++singleCarFilteredPointsIdx;
                }
                console.log("singleCarFilteredPointsIdx Fin: "+singleCarFilteredPointsIdx);

                convertor.translate(pointArr, 1, 5, translateCallBackTrace);
            }
        }
    }

    function drawOverlay(typeNum){
        // console.log(getOperatingModeTypeName(typeNum));
        for(var i = 0; i < backgroundCarOverlayOld[typeNum].length; ++i){
            map.removeOverlay(backgroundCarOverlayOld[typeNum][i]);
        }
        backgroundCarOverlayOld[typeNum] = new Array();
        for(var i = 0; i < backgroundCarOverlayNew[typeNum].length; ++i){
            if(needBackgroundRequest[typeNum] && !curSingleMode){
                map.addOverlay(backgroundCarOverlayNew[typeNum][i]);
            }
            backgroundCarOverlayOld[typeNum].push(backgroundCarOverlayNew[typeNum][i]);
        }
        backgroundCarOverlayNew[typeNum] = new Array();
    }

    function singleQueryTranslateCallBack(data){
        if(data.status != 0){
            console.log('singleQueryTranslateCallBack');
        }else if(singleCarTraceInitFinish == false){
            console.log('singleTrace : new query evoked, but initial not yet finished')
        }else{
            if(singleCarTranslatedPoints.length == 0){
                singleCarTranslatedPoints.push(data.points[0]);

                curOldOverlayHandler = new BMap.Marker(singleCarTranslatedPoints[0]);
                curOldOverlayHandler.setIcon(iconStart);
                map.addOverlay(curOldOverlayHandler)
                curOldOverlayHandler.setAnimation(BMAP_ANIMATION_DROP);//跳动的动画

                curNewOverlayHandler = new BMap.Marker(singleCarTranslatedPoints[singleCarTranslatedPoints.length-1]);
                curNewOverlayHandler.setIcon(iconEnd);
                var content = curCarVin;
                map.addOverlay(curNewOverlayHandler)
                curNewOverlayHandler.setAnimation(BMAP_ANIMATION_BOUNCE);//跳动的动画
                addMouseHandler(content, curNewOverlayHandler);
            }else if(!((data.points[0]).equals(singleCarTranslatedPoints[singleCarTranslatedPoints.length-1]))){
                console.log('final icon should move');
                map.removeOverlay(curNewOverlayHandler);

                curNewOverlayHandler = new BMap.Marker(data.points[0]);
                curNewOverlayHandler.setIcon(iconEnd);
                var content = curCarVin;
                map.addOverlay(curNewOverlayHandler)
                curNewOverlayHandler.setAnimation(BMAP_ANIMATION_BOUNCE);//跳动的动画
                addMouseHandler(content, curNewOverlayHandler);

                var polyline = new BMap.Polyline([singleCarTranslatedPoints[singleCarTranslatedPoints.length-1], data.points[0]], { strokeColor: "#18a45b", strokeWeight: 5, strokeOpacity: 0.8 });
                map.addOverlay(polyline);

                singleCarTranslatedPoints.push(data.points[0]);
                
            }
        }
    }
// <!-- 绘图 -->
// <!-- 右侧栏仪表盘 开始 -->


var domGuage = document.getElementById("guage");
    var myChartGuage = echarts.init(domGuage);
    var app = {};
    optionGuage = null;
    optionGuage = {
        tooltip : {
            formatter: "{a} <br/>{c} {b}"
        },
        // toolbox: {
        //     show: true,
        //     feature: {
        //         restore: {show: true},
        //         saveAsImage: {show: true}
        //     }
        // },
        series : [
            {
                name: '速度',
                type: 'gauge',
                z: 3,
                center: ['48%', '50%'],    // 默认全局居中

                min: 0,
                max: 50,
                splitNumber: 10,
                radius: '55%',
                axisLine: {            // 坐标轴线
                    lineStyle: {       // 属性lineStyle控制线条样式
                        color : [ //表盘颜色
                            [ 0.2,  "#8FBC8F"],//0-50%处的颜色
                            [ 0.6, "#4F94CD" ],//51%-70%处的颜色
                            [ 1, "#B22222" ],//70%-90%处的颜色
                        ],
                        width: 10
                    }
                },
                axisTick: {            // 坐标轴小标记
                    length: "15%",        // 属性length控制线长
                    lineStyle: {       // 属性lineStyle控制线条样式
                        color: 'auto'
                    }
                },
                splitLine: {           // 分隔线
                    length: "20%",         // 属性length控制线长
                    lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                        color: 'auto'
                    }
                },
                axisLabel: {
                    backgroundColor: 'auto',
                    borderRadius: 2,
                    color: '#eee',
                    padding: 3,
                    fontSize:'70%',
                    textShadowBlur: 2,
                    textShadowOffsetX: 1,
                    textShadowOffsetY: 1,
                    textShadowColor: '#222'
                },
                pointer: {
                    width:"7%"
                },
                title : {
                    // 其余属性默认使用全局文本样式，详见TEXTSTYLE
                    fontWeight: 'bolder',
                    fontSize: '60%',
                    fontStyle: 'italic'
                },
                detail : {
                    // 其余属性默认使用全局文本样式，详见TEXTSTYLE
                    formatter: function (value) {
                        value = (value + '').split('.');
                        value.length < 2 && (value.push('00'));
                        return ('00' + value[0]).slice(-2)
                            + '.' + (value[1] + '00').slice(0, 2);
                    },
                    fontWeight: 'bolder',
                    borderRadius: 3,
                    backgroundColor: '#444',
                    borderColor: '#aaa',
                    shadowBlur: 5,
                    shadowColor: '#333',
                    shadowOffsetX: 0,
                    shadowOffsetY: 3,
                    borderWidth: 2,
                    textBorderColor: '#000',
                    textBorderWidth: 2,
                    textShadowBlur: 2,
                    textShadowColor: '#fff',
                    textShadowOffsetX: 0,
                    textShadowOffsetY: 0,
                    fontFamily: 'Arial',
                    fontSize:'100%',
                    width: 100,
                    color: '#eee',
                    rich: {}
                },
                data:[{value: 0, name: 'km/h'}]
            },
            {
                name: '转速',
                type: 'gauge',
                center: ['15%', '55%'],    // 默认全局居中
                radius: '30%',
                min:0,
                max:7,
                endAngle:50,
                splitNumber:7,
                axisLine: {            // 坐标轴线
                    lineStyle: {       // 属性lineStyle控制线条样式
                        width: 8
                    }
                },
                axisTick: {            // 坐标轴小标记
                    length:'15%',        // 属性length控制线长
                    lineStyle: {       // 属性lineStyle控制线条样式
                        color: 'auto'
                    }
                },
                splitLine: {           // 分隔线
                    length:'20%',         // 属性length控制线长
                    lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                        color: 'auto'
                    }
                },
                pointer: {
                    width:"8%"
                },
                title: {
                    offsetCenter: [0, '-30%'],       // x, y，单位px
                    fontSize:'60%'
                },
                detail: {
                    // 其余属性默认使用全局文本样式，详见TEXTSTYLE
                    fontWeight: 'bolder',
                    fontSize:'10%',
                },
                data:[{value: 0, name: 'x1000 r/min'}]
            },
            {
                name: '电量',
                type: 'gauge',
                center: ['80%', '40%'],    // 默认全局居中
                radius: '25%',
                min: 0,
                max: 100,
                startAngle: 135,
                endAngle: 45,
                splitNumber: 2,
                axisLine: {            // 坐标轴线
                    lineStyle: {       // 属性lineStyle控制线条样式
                        width: 8
                    }
                },
                axisTick: {            // 坐标轴小标记
                    splitNumber: 5,
                    length: '10%',        // 属性length控制线长
                    lineStyle: {        // 属性lineStyle控制线条样式
                        color: 'auto'
                    }
                },
                axisLabel: {
                    formatter:function(v){
                        switch (v + '') {
                            case '0' : return 'E';
                            case '1' : return 'Gas';
                            case '2' : return 'F';
                        }
                    }
                },
                splitLine: {           // 分隔线
                    length: '15%',         // 属性length控制线长
                    lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                        color: 'auto'
                    }
                },
                pointer: {
                    width:"4%"
                },
                title : {
                    show: false
                },
                detail : {
                    show: false
                },
                data:[{value: 0, name: '%'}]
            },
            {
                name: '温度',
                type: 'gauge',
                center : ['80%', '58%'],    // 默认全局居中
                radius : '25%',
                min: 0,
                max: 80,
                startAngle: 315,
                endAngle: 225,
                splitNumber: 2,
                axisLine: {            // 坐标轴线
                    lineStyle: {       // 属性lineStyle控制线条样式
                        width: 8
                    }
                },
                axisTick: {            // 坐标轴小标记
                    show: false
                },
                axisLabel: {
                    formatter:function(v){
                        switch (v + '') {
                            case '0' : return 'H';
                            case '1' : return 'Water';
                            case '2' : return 'C';
                        }
                    }
                },
                splitLine: {           // 分隔线
                    length: '15%',         // 属性length控制线长
                    lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                        color: 'auto'
                    }
                },
                pointer: {
                    width:"4%"
                },
                title: {
                    show: false
                },
                detail: {
                    show: false
                },
                data:[{value: 0, name: '°C'}]
            }
        ]
    };
    
    // setInterval(function (){
    //     optionGuage.series[0].data[0].value = (Math.random()*60).toFixed(2) - 0;
    //     optionGuage.series[1].data[0].value = (Math.random()*7).toFixed(2) - 0;
    //     optionGuage.series[2].data[0].value = (Math.random()*2).toFixed(2) - 0;
    //     optionGuage.series[3].data[0].value = (Math.random()*2).toFixed(2) - 0;
    //     myChartGuage.setOption(optionGuage,true);
    // },2000);;
    if (optionGuage && typeof optionGuage === "object") {
        myChartGuage.setOption(optionGuage, true);
    }
// <!-- 右侧栏仪表盘 结束 -->

// <!-- 右侧栏折线图 开始 -->

    var domLine = document.getElementById("dynamicLine");
    var myChartLine = echarts.init(domLine);
    var app = {};
    optionLine = null;
    function randomData() {
        now = new Date(+now + oneDay);
        value = value + Math.random() * 21 - 10;
        return {
            name: now.toString(),
            value: [
                [now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/'),
                Math.round(value)
            ]
        }
    }
    
    var dataLine = new Array();
    var now = +new Date(1997, 9, 3);
    var oneDay = 24 * 3600 * 1000;
    var value = Math.random() * 1000;
    // for (var i = 0; i < 1000; i++) {
    //     data.push(randomData());
    // }
    
    optionLine = {
        title: {
            text: '历史速度'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function (params) {
                params = params[0];
                // var date = new Date(params.name);
                var data_tem = params.name.split(' ');
                return data_tem[3]+'-'+data_tem[1]+'-'+data_tem[2]+' '+data_tem[4]+' '+params.value[1]; 
                // return date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear() + ' : ' + params.value[1];
                // return data.getFullYear()+'-'+(date.getMonth() + 1)+'-'+date.getDate()+' '+date.getHours()+':'+date.getMinutes()+':'+date.getSeconds()+'.'+date.getMinutes()+' '+params.value[1];
            },
            axisPointer: {
                animation: false
            }
        },
        xAxis: {
            type: 'time',
            splitLine: {
                show: false
            }
        },
        yAxis: {
            type: 'value',
            boundaryGap: [0, '100%'],
            splitLine: {
                show: false
            }
        },
        dataZoom: [
            {   // 这个dataZoom组件，默认控制x轴。
                type: 'slider', // 这个 dataZoom 组件是 slider 型 dataZoom 组件
                start: 0,      // 左边在 10% 的位置。
                end: 100,         // 右边在 60% 的位置。
                height: '5%',
                // zlevel:3
                // minSpan:8,
            },
            {   // 这个dataZoom组件，也控制x轴。
                type: 'inside', // 这个 dataZoom 组件是 inside 型 dataZoom 组件
                start: 0,      // 左边在 10% 的位置。
                end: 100         // 右边在 60% 的位置。
            }
        ],
        series: [{
            name: '数据',
            type: 'line',
            showSymbol: false,
            hoverAnimation: false,
            data: dataLine
        }]
    };
    
    // setInterval(function () {
    
    //     for (var i = 0; i < 5; i++) {
    //         data.shift();
    //         data.push(randomData());
    //     }
    
    //     myChartLine.setOption({
    //         series: [{
    //             data: data
    //         }]
    //     });
    // }, 1000);;
    if (optionLine && typeof optionLine === "object") {
        myChartLine.setOption(optionLine, true);
    }

// <!-- 右侧栏折线图 结束 -->




// <!-- 底部栏 -->


// <!-- Pie Start -->
    var domPie = document.getElementById("Pie");
    var myChartPie = echarts.init(domPie);
    var app = {};
    optionPie = null;
    app.title = '环形图';
    
    optionPie = {
        tooltip: {
            triggeron:'click',
            trigger: 'item',
            formatter: "{b}: {c} ({d}%)"
        },
        legend: {
            orient: 'vertical',
            x: 'left',
            data:['活跃','休眠','充电','初始化','上电','未知']
            // data:['运行中','空闲中','低电量','离线','待维修']
            // tooltip: {
            //     triggeron:'click',
            //     trigger: 'item',
            //     formatter: "{b}: {c} ({d}%)"
            // }

        },
        series: [
            {
                name:'车辆状态',
                type:'pie',
                radius: ['35%', '70%'],
                avoidLabelOverlap: false,
                label: {
                    normal: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        show: true,
                        textStyle: {
                            fontSize: '110%',
                            fontWeight: 'bold'
                        }
                    }
                },
                labelLine: {
                    normal: {
                        show: true
                    }
                },
                data:[
                    {value:1, name:'活跃'},
                    {value:1, name:'休眠'},
                    {value:1, name:'充电'},
                    {value:1, name:'初始化'},
                    {value:1, name:'上电'},
                    {value:1, name:'未知'},
                ]
            }
        ]
    };
    ;
    if (optionPie && typeof optionPie === "object") {
        myChartPie.setOption(optionPie, true);
    }
// <!-- Pie End -->


// 层叠图开始
    var domStack = document.getElementById("Stack");
    var myChartStack = echarts.init(domStack);
    var app = {};
    optionStack = null;
    optionStack = {
        title: {
            text: '车辆使用情况'
        },
        tooltip : {
            trigger: 'axis',
            axisPointer: {
                type: 'cross',
                label: {
                    backgroundColor: '#6a7985'
                }
            }
        },
        legend: {
            // data:['使用中','空闲中','低电量','离线','待维修']
            data:['活跃','休眠','充电','初始化','上电','未知']
        },
        // toolbox: {
        //     feature: {
        //         saveAsImage: {}
        //     }
        // },
        grid: {
            // top: '15%',
            left: '3%',
            right: '4%',
            // bottom: '50px',
            containLabel: true
        },
        xAxis : [
            {
                type : 'category',
                boundaryGap : false,
                data : new Array(),
                // data : ['','','','','','','', '']
            }
        ],
        yAxis : [
            {
                type : 'value'
            }
        ],
        dataZoom: [
            {   // 这个dataZoom组件，默认控制x轴。
                type: 'slider', // 这个 dataZoom 组件是 slider 型 dataZoom 组件
                start: 0,      // 左边在 10% 的位置。
                end: 100         // 右边在 60% 的位置。
            },
            {   // 这个dataZoom组件，也控制x轴。
                type: 'inside', // 这个 dataZoom 组件是 inside 型 dataZoom 组件
                start: 0,      // 左边在 10% 的位置。
                end: 100         // 右边在 60% 的位置。
            }
        ],
        series : [
            {
                name:'活跃',
                type:'line',
                stack: '总量',
                areaStyle: {},
                data : new Array(),
                // data:[120, 132, 101, 134, 90, 230, 210,1000]
            },
            {
                name:'休眠',
                type:'line',
                stack: '总量',
                areaStyle: {},
                data : new Array(),
                // data:[220, 182, 191, 234, 290, 330, 310, 1000]
            },
            {
                name:'充电',
                type:'line',
                stack: '总量',
                areaStyle: {},
                data : new Array(),
                // data:[150, 232, 201, 154, 190, 330, 410, 1000]
            },
            {
                name:'初始化',
                type:'line',
                stack: '总量',
                areaStyle: {},
                data : new Array(),
                // data:[150, 232, 201, 154, 190, 330, 410, 1000]
            },
            {
                name:'上电',
                type:'line',
                stack: '总量',
                areaStyle: {},
                data : new Array(),
                // data:[150, 232, 201, 154, 190, 330, 410, 1000]
            },
            {
                name:'未知',
                type:'line',
                stack: '总量',
                areaStyle: {},
                data : new Array(),
                // data:[150, 232, 201, 154, 190, 330, 410, 1000]
            },
            // {
            //     name:'离线',
            //     type:'line',
            //     stack: '总量',
            //     areaStyle: {normal: {}},
            //     data:[320, 332, 301, 334, 390, 330, 320]
            // },
            // {
            //     name:'待维修',
            //     type:'line',
            //     stack: '总量',
            //     label: {
            //         normal: {
            //             show: true,
            //             position: 'top'
            //         }
            //     },
            //     areaStyle: {normal: {}},
            //     data:[820, 932, 901, 934, 1290, 1330, 1320]
            // }
        ]
    };
    ;

    // initialStack();
    if (optionStack && typeof optionStack === "object") {
        myChartStack.setOption(optionStack, true);
    }

// 层叠图 结束


    window.onresize = function () {
        myChartPie.resize();
        myChartStack.resize();
        myChartGuage.resize();
        myChartLine.resize();
    }


// <!-- 绘制地图 -->

    // 绘制轨迹折线图
    function drawLine(prePoint, nxtPoint){
        console.log('prePoint: '+prePoint.lng+''+prePoint.lat);
        console.log('nxtPoint: '+nxtPoint.lng+''+nxtPoint.lat);

        // var sym = new BMap.Symbol
        // (
        //     BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, //百度预定义的 箭头方向向下的非闭合箭头
        //     {
        //         fillColor : '#0F0', //设置矢量图标的填充颜色。支持颜色常量字符串、十六进制、RGB、RGBA等格式
        //         fillOpacity : 1, //设置矢量图标填充透明度,范围0~1
        //         scale : 0.5, //设置矢量图标的缩放比例
        //         // rotation : 90, //设置矢量图标的旋转角度,参数为角度
        //         strokeColor : '#FFF', //设置矢量图标的线填充颜色,支持颜色常量字符串、十六进制、RGB、RGBA等格式
        //         strokeOpacity : 1, //设置矢量图标线的透明度,opacity范围0~1
        //         strokeWeight : 2, //旋设置线宽。如果此属性没有指定，则线宽跟scale数值相
        //     }
        // );

        // var iconSequence = new BMap.IconSequence
        // (
        //     sym, //symbol为符号样式
        //     '0%', //offset为符号相对于线起点的位置，取值可以是百分比也可以是像素位置，默认为"100%"
        //     '40%', //repeat为符号在线上重复显示的距离，可以是百分比也可以是距离值，同时设置repeat与offset时，以repeat为准
        //     false //fixedRotation设置图标的旋转角度是否与线走向一致，默认为true
        // );
        // var polyline = new BMap.Polyline(
        //     [
        //         prePoint,
        //         nxtPoint
        //     ],
        //     {
        //         icons : [iconSequence], //图标集合  **也是我之前没有实现样式改变的最大原因**
        //         strokeColor : '#0F0', //折线颜色 尽量与图标填充色保持一样
        //         strokeOpacity : 1, //折线的透明度，取值范围0 - 1
        //         strokeWeight : 5, //折线的宽度，以像素为单位
        //     }
        // );
        var sy = new BMap.Symbol(BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, {    
            scale: 0.6,//图标缩放大小
            strokeColor:'#fff',//设置矢量图标的线填充颜色
            strokeWeight: '2',//设置线宽
        });
        var icons = new BMap.IconSequence(sy, '10', '30');
        var arr = new Array();
        arr.push(prePoint, nxtPoint)
        var polyline = new BMap.Polyline(arr, {
            enableEditing: false,//是否启用线编辑，默认为false
            enableClicking: true,//是否响应点击事件，默认为true
            icons:[icons],
            strokeWeight:'8',//折线的宽度，以像素为单位
            strokeOpacity: 0.8,//折线的透明度，取值范围0 - 1
            strokeColor:"#18a45b" //折线颜色
        });
        map.addOverlay(polyline);
        console.log('drawnline finish');
    }

    // 绘制点（根据车辆状态选择图片颜色），并加入回调
    function drawMapPoint(data, type){
        // var myIcon = new BMap.Icon("./img/icon-green-small.gif", new BMap.Size(25, 25));
        for(var i = 0; i < data.length; ++i){
            
            var marker = new BMap.Marker(new BMap.Point(data[i][1], data[i][2]));
            marker.setIcon(iconArr[type]);
            var content = data[i][0];
            map.addOverlay(marker)
            if(needAnimation[type]) marker.setAnimation(BMAP_ANIMATION_DROP);//坠落动画
            addMouseHandler(content, marker);
        }
        needAnimation[type] = false;
    }

    function addMouseHandler(content,marker){
        marker.addEventListener("mouseover",function(e){
            this.getPosition();
            needUpdateMap = false;
            openInfo(content, e);
        });
        marker.addEventListener("mouseout",function(e){
            needUpdateMap = true;
        });
        marker.addEventListener("click",function(){ //必须要在外面套一个匿名函数，不然会直接执行，不知道为什么
            needUpdateMap = true;
            onClickOverlay((content.split(' '))[0]);
        });
    }

    function openInfo(content, e){
        var p=e.target;
        
        var opts = {
            // width : 50px,     // 信息窗口宽度
            // height: '10%',     // 信息窗口高度
            title : '车辆编号'  // 信息窗口标题
        }

        var point=new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content, opts);
        map.openInfoWindow(infoWindow, point);
    }

    // // var data_info = [[121.447176,31.033731],[135.447176,35.033731],[115.447176,35.033731]];
    // var data_info = [[121.447176,31.033780,"car1"],[121.445009,31.030880,"car2"],[121.444695,31.027980,"car2"]];
    // function eConsole(param) {
    // 　　//param.dataIndex 获取当前点击索引，
    // // 　　console.log(param.dataIndex);
    //     map.clearOverlays();
    // 　　clickFunc(param.dataIndex);//执行点击效果
    // }
    // myChartPie.on("click", eConsole);
    
    // function addMouseHandler(content,marker, num){
    //     marker.addEventListener("mouseover",function(e){
            
    //         this.getPosition();
    //         openInfo(content, e);
    //         // console.log(num);
    //     });
    //     marker.addEventListener("click",function(){ //必须要在外面套一个匿名函数，不然会直接执行，不知道为什么
    //         onClickOverlay(num);
    //     });
    // }

    // function openInfo(content, e){
    //     // console.log("mouse on");
    //     var p=e.target;
        
    //     var opts = {
    //         // width : 50px,     // 信息窗口宽度
    //         // height: '10%',     // 信息窗口高度
    //         title : '车辆编号'  // 信息窗口标题
    //     }

        
    //     var point=new BMap.Point(p.getPosition().lng, p.getPosition().lat);
    //     var infoWindow = new BMap.InfoWindow(content, opts);
    //     map.openInfoWindow(infoWindow, point);
    //     // console.log(content);
    // }

    // function clickFunc(carType){
    //     // console.log(data_info.length);
    //     var myIcon = new BMap.Icon("./img/icon-green-small.gif", new BMap.Size(25, 25));
    //     for(var i = 0; i < data_info.length; ++i){
            
    //         var marker = new BMap.Marker(new BMap.Point(data_info[i][0], data_info[i][1]));
    //         marker.setIcon(myIcon);
    //         var content = data_info[i][2];
    //         map.addOverlay(marker)
    //         addMouseHandler(content, marker, i);
    //     }
    // }
 


    // <!-- 网页启动 -->
    // initialStack();
    myChartPie.on("click", eConsole);
    backToBackground();
    requestCurrentTypeNum();
    backgroundRequest();
    // setInterval(function(){
    //     if(pageStale) return;
    //     requestCurrentTypeNum();
    // }, 12253 );
    setInterval(function(){
        // console.log('needUpdateMap: '+needUpdateMap);
        // console.log('mapLocked: '+mapLocked);

        if(pageStale) return;

        if(!needUpdateMap || mapLocked) return;
        if(!curSingleMode){
            // console.log('request background');
            // map.clearOverlays();
            backgroundRequest();
        }else{
            // console.log('request single');
            // requestSingleCarHistory();
            requestSingleCar();
        }
    }, 5000   );

    setInterval(function(){
        pageStale = true;
    }, 1800000);
</script>
          