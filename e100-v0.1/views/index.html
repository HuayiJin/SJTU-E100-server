<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title>SJTU-E100-TEST</title>
	<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://img.hcharts.cn/jquery/jquery-1.8.3.min.js"></script>
	<script src="https://img.hcharts.cn/highcharts/highcharts.js"></script>
	<script src="https://img.hcharts.cn/highcharts/modules/exporting.js"></script>
	<script src="https://img.hcharts.cn/highcharts/modules/data.js"></script>
	<script src="https://img.hcharts.cn/highcharts/modules/series-label.js"></script>
	<script src="https://img.hcharts.cn/highcharts/modules/oldie.js"></script>
	<script src="https://img.hcharts.cn/highcharts-plugins/highcharts-zh_CN.js"></script>

	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=M0Pi0G5matEh4ZUSMTHaSB0EmlgQaOYM"></script>

	<style type="text/css">
		body,
		html {
			width: 100%;
			height: 100%;
			margin: 0;
			font-family: "微软雅黑";
		}

		#allmap {
			height: 500px;
			width: 100%;
		}

		#r-result {
			width: 100%;
		}

		table,
		td,
		th {
			border: 0px solid black;
		}

		table {
			width: 100%;
		}

		th {
			height: 35px;
			font-size: 20px;
		}

		td {
			text-align: left;
		}

		div {
			margin: auto;
		}

		.center {
			margin: 10px;
			padding: 10px;
			text-align: center;
		}

		#sgmw {
			margin: 0px;
			text-align: center;
		}

		#sgmwframe {
			margin: auto;
			width: 90%;
		}

		#register {
			height: 1200px;
		}

		.regleft,
		.regright {
			margin: 10px;
			width: 450px;
			height: 400px;
			padding: 10px;
			display: table-cell;
		}

		#reginfocontainer {
			width: 900px;
			margin: auto;
		}

		#search {
			height: 100px;
		}

		h1 {
			margin: 10px;
			text-align: left;
			padding: 20px
		}

		h2 {
			padding: 10px;
			text-align: center;
		}

		.chartcontainer {
			width: 90%;
			padding: 20px;
			min-width: 400px;
			height: 400px;
		}

		#allmap {
			height: 600px;
			width: 100%;
		}

		#r-result {
			width: 100%;
		}

        .sgmw-relative{position:relative; width:1400px; height:900px} 
        .sgmw-a{ position:absolute; width:1400px; height:900px} 
        /* css注释说明： 背景为红色 */ 
        .sgmw-b{ position:absolute; left:70px ; background:#FF0; width:1260px; height:80px} 
        /* 背景为黄色 */ 
	</style>

</head>

<body>
	<div id="container">
		<div id="header">
			<h1 style="margin-bottom:0;">SJTU-E100-TEST</h1>
		</div>
		<ul id="myTab" class="nav nav-tabs">
			<li class="active">
				<a href="#register" data-toggle="tab">注册信息</a>
			</li>
			<li>
				<a href="#rtdata" data-toggle="tab">实时信息</a>
			</li>
			<li>
				<a href="#rtmap" data-toggle="tab">历史位置信息</a>
			</li>
			<li class="dropdown">
				<a href="#history" id="myTabDrop1" class="dropdown-toggle" data-toggle="dropdown">历史信息
					<b class="caret"></b>
				</a>
				<ul class="dropdown-menu" role="menu" aria-labelledby="myTabDrop1">
					<li><a href="#runtime" tabindex="-1" data-toggle="tab">车辆历史数据</a></li>
					<li><a href="#alert" tabindex="-1" data-toggle="tab">告警历史数据</a></li>
				</ul>
			</li>
		</ul>

		<div id="myTabContent" class="tab-content">
			<div class="tab-pane fade in active" id="register">
				<h2>注册信息</h2>
				<div id="search1" class="center">
					<form action="/users/search/register">
						<input type="radio" name="searchtype_reg" checked="checked">
						<b>按VIN查找</b>
						<input list="VINs" id="car_VIN_reg">
						<datalist id="VINs">
							<option value="1">
							<option value="LK6ADCE21JB008286">
						</datalist><br>

						<input type="radio" name="searchtype_reg">
						<b>按车牌号查找</b>
						<input list="Nums" id="car_NUM_reg">
						<datalist id="Nums">
							<option value="1">
							<option value="LK6ADCE21JB008286">s
						</datalist><br>
						<input type="button" value="查询" onclick="Submit_reg()">
					</form>
				</div>
				<div id="reginfocontainer">
					<div id="regcontent1" class="regleft">
						<table id='regtable1'>
							<tr>
								<th>车辆VIN</th>
							</tr>
							<tr>
								<th>注册时间</th>
							</tr>
							<tr>
								<th>车辆类型</th>
							</tr>
							<tr>
								<th>储能装置种类</th>
							</tr>
							<tr>
								<th>驱动电机类型</th>
							</tr>
							<tr>
								<th>电机额定功率</th>
							</tr>
							<tr>
								<th>电机额定转速</th>
							</tr>
							<tr>
								<th>电机额定转矩</th>
							</tr>
						</table>
					</div>
					<div id="regcontent2" class="regright">
						<table id='regtable2'>
							<tr>
								<th>电机安装数量</th>
							</tr>
							<tr>
								<th>电机布置位置</th>
							</tr>
							<tr>
								<th>电机冷却方式</th>
							</tr>
							<tr>
								<th>电动汽车续航里程</th>
							</tr>
							<tr>
								<th>电动汽车最高时速</th>
							</tr>
							<tr>
								<th>电池包数量</th>
							</tr>
							<tr>
								<th>电池包信息</th>
							</tr>
							<tr>
								<th>额外字段</th>
							</tr>
						</table>
					</div>
				</div>
			</div>
			<div class="tab-pane fade" id="rtdata">
                <div class="sgmw-relative">
                    <div class="sgmw-a" id="sgmw">
                        <iframe id="sgmwframe" src="https://cloud.sgmw.com.cn" height="900" width="1400" frameborder="0">
                            <p>您的浏览器不支持 iframe 标签。</p>
                        </iframe>
                    </div>
                    <div class="sgmw-b">
                        <img src="SJTU-ICEVIC.jpg">
                    </div>
                </div>
			</div>
			<div class="tab-pane fade" id="rtmap">
				<div id="searchmap" class="center">
					<h2>车辆地图数据</h2>
					<form action="/users/search/runtime">
						<input type="radio" name="searchtype_rt_rtmap" checked="checked">
						<b>按VIN查找</b>
						<input list="VINs" id="car_VIN_rt_rtmap">
						<datalist id="VINs">
							<option value="1">
							<option value="LK6ADCE21JB008286">
						</datalist><br>

						<input type="radio" name="searchtype_rt_rtmap">
						<b>按车牌号查找</b>
						<input list="Nums" id="car_NUM_rt_rtmap">
						<datalist id="Nums">
							<option value="1">
							<option value="LK6ADCE21JB008286">
						</datalist><br>

						选择时间段:
						<input type="datetime-local" name="bdaytime_rtmap" value="2018-01-01T00:00">~
						<input type="datetime-local" name="bdaytime_rtmap" value="2019-01-01T00:00"><br>
						<input type="button" value="查询" onclick="Submit_rt('rtmap')">
					</form>
				</div>
				<div id="allmap"></div>
				<div id="r-result">
					<input type="button" onclick="remove_overlay();" value="删除覆盖物" />
				</div>
			</div>
			<div class="tab-pane fade" id="runtime">
				<div id="search2" class="center">
					<h2>车辆历史数据</h2>
					<form action="/users/search/runtime">
						<input type="radio" name="searchtype_rt_runtime" checked="checked">
						<b>按VIN查找</b>
						<input list="VINs" id="car_VIN_rt_runtime">
						<datalist id="VINs">
							<option value="1">
							<option value="LK6ADCE21JB008286">
						</datalist><br>

						<input type="radio" name="searchtype_rt_runtime">
						<b>按车牌号查找</b>
						<input list="Nums" id="car_NUM_rt_runtime">
						<datalist id="Nums">
							<option value="1">
							<option value="LK6ADCE21JB008286">
						</datalist><br>

						<b>数据类型：</b>
						<select id="chartselect_runtime" name="cars">
							<option value="velocity" selected>速度</option>
							<option value="cumulative_mileage">总行驶里程</option>
							<option value="drive_motor_rpm">电机转速</option>
                            <option value="drive_motor_temperature">电机温度</option>
                            <option value="motor_torque">电机转矩</option>
                            <option value="motor_controller_current">电机控制器电流</option>
                            <option value="motor_controller_voltage">电机控制器电压</option>
                            <option value="residual_energy">剩余电量</option>
                            <option value="high_voltage_battery_current">总电流</option>
                            <option value="total_battery_voltage">总电压</option>
                            <option value="max_single_voltage">电池最高单体电压</option>
                            <option value="min_single_voltage">电池最低单体电压</option>
                            <option value="insulation_resistance_value">绝缘阻值</option>
						</select><br>
						选择时间段:
						<input type="datetime-local" name="bdaytime_runtime" value="2018-01-01T00:00">~
						<input type="datetime-local" name="bdaytime_runtime" value="2019-01-01T00:00"><br>
						<input type="button" value="查询" onclick="Submit_rt('runtime')">
					</form>
				</div>
				<div>
					<div id="chartcontainer_runtime" class="chartcontainer"></div>
				</div>
			</div>
			<div class="tab-pane fade" id="alert">
				<div id="search4" class="center">
					<h2>告警历史数据</h2>
					<form action="">
						<input type="radio" name="searchtype_rt_alert" checked="checked">
						<b>按VIN查找</b>
						<input list="VINs" id="car_VIN_rt_alert">
						<datalist id="VINs">
							<option value="1">
							<option value="LK6ADCE21JB008286">
						</datalist><br>

						<input type="radio" name="searchtype_rt_alert">
						<b>按车牌号查找</b>
						<input list="Nums" id="car_NUM_rt_alert">
						<datalist id="Nums">
							<option value="1">
							<option value="LK6ADCE21JB008286">
						</datalist><br>

						选择时间段:
						<input type="datetime-local" name="bdaytime_alert" value="2018-01-01T00:00">~
						<input type="datetime-local" name="bdaytime_alert" value="2019-01-01T00:00"><br>
						<input type="button" value="查询" onclick="Submit_rt('alert')">
					</form>
				</div>
				<div id="alerttable">
				</div>
			</div>
		</div>
	</div>
</body>

</html>
<script>


var mapdata = null;

function Submit_reg() {
    var reqdata;
    var searchtype = document.getElementsByName("searchtype_reg");

    if(searchtype[0].checked){
        reqdata = "searchtype=byVIN"
        + "&car_VIN=" + document.getElementById("car_VIN_reg").value
    }else if(searchtype[1].checked){
        reqdata = "searchtype=bynumber"
        + "&car_NUM=" + document.getElementById("car_NUM_reg").value
    }else{
        alert("请选择查询方式")
    }

    $.ajax({
        url: '/users/search/register', //请求的url
        type: 'get', //请求的方式
        data: reqdata,
        error:function (data) {
            alert('请求失败');
        },
        success:function (data) {
            var str1=
            "<tbody><tr><th>车辆VIN</th><td>" + data[0].car_VIN  + "</td></tr>" +
            "<tr><th>注册时间</th><td>" + data[0].registration_time  + "</td></tr>" +
            "<tr><th>车辆类型</th><td>" + data[0].vehicle_type  + "</td></tr>" +
            "<tr><th>储能装置种类</th><td>" + data[0].energy_storing_type  + "</td></tr>" +
            "<tr><th>驱动电机类型</th><td>" + data[0].drive_motor_type  + "</td></tr>" +
            "<tr><th>电机额定功率</th><td>" + data[0].drive_motor_rated_power  + "</td></tr>" +
            "<tr><th>电机额定转速</th><td>" + data[0].drive_motor_rated_rpm  + "</td></tr>" +
            "<tr><th>电机额定转矩</th><td>" + data[0].drive_motor_rated_torque  + "</td></tr></tbody>" ;

            var str2=
            "<tbody><tr><th>电机安装数量</th><td>" + data[0].drive_motor_number + "</td></tr>" +
            "<tr><th>电机布置位置</th><td>" + data[0].drive_motor_position + "</td></tr>" +
            "<tr><th>电机冷却方式</th><td>" + data[0].drive_motor_cooling_method + "</td></tr>" +
            "<tr><th>电动汽车续航里程</th><td>" + data[0].e_car_endurance_mileage + "</td></tr>" +
            "<tr><th>电动汽车最高时速</th><td>" + data[0].e_car_top_speed + "</td></tr>" +
            "<tr><th>电池包数量</th><td>" + data[0].power_battery_number + "</td></tr>" +
            "<tr><th>电池包信息</th><td>" + data[0].power_battery_info_0 + "</td></tr>" +
            "<tr><th>额外字段</th><td>" + data[0].extra_field + "</td></tr></tbody>";
            
            console.dir(data[0])
            //清空table中的html
            $("#regtable1").html(""); 
            $("#regtable2").html("");
            $("#regtable1").append(str1);
            $("#regtable2").append(str2);
        }
    });
}

function Submit_rt(route) {
    var reqdata;
    var searchtype = document.getElementsByName("searchtype_rt_"+route);
    console.log(searchtype)
    var vinid = "car_VIN_rt_" + route
    var numid = "car_NUM_rt_" + route
    var time = document.getElementsByName("bdaytime_"+route)

    var searchroute;
    if (searchtype == "电机转矩"||
        searchtype == "电机控制器电流"||
        searchtype == "电机控制器电压") {
        searchroute = "other";
    } else if (searchtype == "剩余电量"||
        searchtype == "总电流"||
        searchtype == "总电压"||
        searchtype == "电池最高单体电压"||
        searchtype == "电池最低单体电压"||
        searchtype == "绝缘阻值") {
        searchroute = "battery";
    } else {
        searchroute = route;
    }

    console.log("searchroute is "+searchroute)
    console.log(searchtype)
    
    if(searchtype[0].checked){
        reqdata = "searchtype=byVIN"
        + "&car_VIN=" + document.getElementById(vinid).value 
        + "&bdaytime=" + time[0].value + "&bdaytime=" + time[1].value ,true
    }else if(searchtype[1].checked){
        reqdata = "searchtype=bynumber"
        + "&car_NUM=" + document.getElementById(numid).value
        + "&bdaytime=" + time[0].value + "&bdaytime=" + time[1].value ,true
    }else{
        alert("请选择查询方式")
    }

    $.ajax({
        url: '/users/search/' + (searchroute=="rtmap"?"runtime":searchroute), //请求的url
        type: 'get', //请求的方式
        data: reqdata,
        error:function (data) {
            alert('请求失败');
        },
        success:function (data) {
            if(searchroute == "rtmap"){
				//console.log(data)
				mappoint(data)
				return true;
            }
            var type = "chartselect_" + searchroute
            var charttype = document.getElementById(type).value 

            var csv = data2csv(data,charttype)

            var chartloc = "chartcontainer_" + searchroute;
            console.log(chartloc)
            chart = Highcharts.chart(chartloc, {
                chart: {
                    zoomType: 'x'
                },
                data: {
                    csv: csv
                },
                title: {
                    text: '实时数据图'
                },
                subtitle: {
                    text: document.ontouchstart === undefined ?
                    '鼠标拖动可以进行缩放' : '手势操作进行缩放'
                },
                xAxis: {
                    type: 'datetime',
                    dateTimeLabelFormats: {
                        millisecond: '%H:%M:%S.%L',
                        second: '%H:%M:%S',
                        minute: '%H:%M',
                        hour: '%H:%M',
                        day: '%m-%d',
                        week: '%m-%d',
                        month: '%Y-%m',
                        year: '%Y'
                    }
                },
                tooltip: {
                    dateTimeLabelFormats: {
                        millisecond: '%H:%M:%S.%L',
                        second: '%H:%M:%S',
                        minute: '%H:%M',
                        hour: '%H:%M',
                        day: '%Y-%m-%d',
                        week: '%m-%d',
                        month: '%Y-%m',
                        year: '%Y'
                    }
                },
                yAxis: {
                    title: {
                        text: charttype
                    }
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    area: {
                        fillColor: {
                            linearGradient: {
                                x1: 0,
                                y1: 0,
                                x2: 0,
                                y2: 1
                            },
                            stops: [
                                [0, Highcharts.getOptions().colors[0]],
                                [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                            ]
                        },
                        marker: {
                            radius: 2
                        },
                        lineWidth: 1,
                        states: {
                            hover: {
                                lineWidth: 1
                            }
                        },
                        threshold: null
                    }
                }
            });
        }
    });
}

function data2csv(data,type){
    //console.log(type)
    //console.dir(data)
    typename = dictionary_en2cn[type]
    console.log(typename)
    var csv = "Time," + typename + " \n";
    for(var i = 0; i < data.length; i += 1){
        if(data[i][type] == null){
            continue;
        }
        csv += data[i].timestamp + "," + data[i][type] + "\n";
    }
    return csv;
}

var dictionary_cn2en ={
    "日期": "timestamp",
    "经度": "longitude",
    "纬度": "latitude",
    "车辆运行模式": "vehicle_operating_mode",
    "制动踏板位置": "brake_pedal_status",
    "加速踏板位置": "accelerator_pedal_stroke",
    "档位": "gear_position",
    "钥匙状态": "key_status",
    "驾驶模式": "driving_mode",
    "车速": "velocity",
    "电机状态": "motor_status",
    "电机转矩": "motor_torque",
    "电机转速": "drive_motor_rpm",
    "电机控制器电流": "motor_controller_current",
    "电机控制器电压": "motor_controller_voltage",
    "电机温度": "drive_motor_temperature",
    "电机控制器温度": "motor_controller_temperature",
    "总电流": "high_voltage_battery_current",
    "总电压": "total_battery_voltage",
    "绝缘阻值": "insulation_resistance_value",
    "剩余电量": "residual_energy",
    "电池最高单体电压": "max_single_voltage",
    "电池最低单体电压": "min_single_voltage",
    "总行驶里程": "cumulative_mileage"
}
var dictionary_en2cn = {
    "timestamp" : "日期",
    "longitude" : "经度",
    "latitude" : "纬度",
    "vehicle_operating_mode" : "车辆运行模式",
    "brake_pedal_status" : "制动踏板位置",
    "accelerator_pedal_stroke" : "加速踏板位置",
    "gear_position" : "档位",
    "key_status" : "钥匙状态",
    "driving_mode" : "驾驶模式",
    "velocity" : "车速",
    "motor_status" : "电机状态",
    "motor_torque" : "电机转矩",
    "drive_motor_rpm" : "电机转速",
    "motor_controller_current" : "电机控制器电流",
    "motor_controller_voltage" : "电机控制器电压",
    "drive_motor_temperature" : "电机温度",
    "motor_controller_temperature" : "电机控制器温度",
    "high_voltage_battery_current" : "总电流",
    "total_battery_voltage" : "总电压",
    "insulation_resistance_value" : "绝缘阻值",
    "residual_energy" : "剩余电量",
    "max_single_voltage" : "电池最高单体电压",
    "min_single_voltage" : "电池最低单体电压",
    "cumulative_mileage" : "总行驶里程"
}

var map = new BMap.Map("allmap");
map.centerAndZoom("上海",13);      // 初始化地图,用城市名设置地图中心点
map.enableScrollWheelZoom(true);
map.addControl(new BMap.NavigationControl());

function mappoint(data){
    var pointArr = [];

    for(var i = 0; i < data.length; i++){
        if(data[i].longitude == null ||data[i].latitude == null){
            continue;
		}
		if(data[i].longitude > 124 ||data[i].longitude < 118 ||data[i].latitude > 35 ||data[i].latitude < 27){
            continue;
        }
        
		var ggPoint = new BMap.Point(data[i].longitude,data[i].latitude);
        pointArr.push(ggPoint);
    
        //console.log(ggPoint)
    }

    var total = 0;
    var groupCount = 0;
    if (pointArr.length % 10 > 0) {
        groupCount = (pointArr.length / 10) + 1;
    }
    else {
        groupCount = (pointArr.length / 10);
    }

    
    for(var i=0;i<groupCount;i++){ //外层循环，有多少组十条
        var pos = new Array();
        for(var j=0;j<10;j++){ //内层循环，每组十条
            if(total<pointArr.length){ //不超过总记录数结束
                var point = pointArr[(i * 10) + j];
                pos.push(point);
            }
            total++;
        }
        var pointarray = [];
        var convertor = new BMap.Convertor();
        convertor.translate(pos, 1, 5, function(data){
            if(data.status === 0) {
                for (var i = 0; i < data.points.length; i++) {
                    pointarray.push(data.points[i]);
                    //map.addOverlay(new BMap.Marker(data.points[i]));
                    //map.setCenter(data.points[i]);
                }
            
            console.log(pointarray.length)
            var polyline = new BMap.Polyline(pointarray, {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5});
            map.addOverlay(polyline);          //增加折线
            map.setCenter(pointarray[0]);
            pointarray = [];
            }
        });
    }




    //var convertor = new BMap.Convertor();
    //convertor.translate(pointArr, 1, 5, translateCallback)

    //var point = new BMap.Point(data[i].longitude, data[i].latitude);
    //var marker = new BMap.Marker(point); // 创建点
    //map.addOverlay(marker);
    
    console.log(pointarray)
}

function remove_overlay(){
    map.clearOverlays();         
}
</script>